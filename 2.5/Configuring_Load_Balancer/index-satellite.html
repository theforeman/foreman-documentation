<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Configuring Capsules with a Load Balancer</title>
<link rel="stylesheet" href="./satellite.css">
<!-- docinfo -->
</head>
<body class="book">
<!--
	vim: set noai ts=2 sts=2 sw=2 et ft= syn=html
-->
<div id="wrap">
<script src="/js/nav.js"></script>
<script>
const versionRe = new RegExp(`/(nightly|\\d+.\\d+)/`);
var currentVer = document.location.toString().match(versionRe);
if (currentVer && currentVer.length > 1) {
  currentVer = currentVer[1];
} else {
  currentVer = "nightly";
}
var navId = 1;
var Navbar = `<nav>
<img class="logo" src="/img/helmet.svg" />
<button type="button" class="btn-hamburger" data-action="nav-toggle">
  <span></span>
  <span></span>
  <span></span>
  <span></span>
  <span></span>
</button>
<ul class="nav-menu">
  <li class="nav-item"><a href="/">Home</a></li>`
  + navItems.map(function(navItem){ return(
    `<li id="nav-id-`+ navId++ +`" class="nav-item dropdown">
        <a href="#" data-action="dropdown-toggle">`+ navItem.title + `</a>
        <div class="dropdown-menu">`
        + navItem.items.map(function(item){ return(
            `<div class="dropdown-div"><a class="dropdown-item" href=/`+currentVer+item.href+`>`+item.title+`</a></div>`
        )}).join("")
        +`</div>
    </li>`
    )}).join("")
  + navVersions.map(function(navItem){ return(
    `<li id="nav-id-`+ navId++ +`" class="nav-item dropdown">
        <a href="#" data-action="dropdown-toggle">Version `+currentVer+`</a>
        <div class="dropdown-menu dropdown-menu-left">`
        + navItem.items.map(function(item){
            if (document.location.pathname == "/") {
                var dl = "/release/" + item.href;
            } else {
                var dl = document.location.toString().replace(versionRe, "/"+item.href+"/");
            }
            return(`<div class="dropdown-div"><a class="dropdown-item" href=`+dl+`>`+item.title+`</a></div>`
        )}).join("")
        +`</div>
    </li>`
    )}).join("")
+`</ul>
</nav>`;

function toggleElement(dropdown) {
  if (dropdown.classList.contains("show")) {
    dropdown.classList.remove("show");
  } else {
    dropdown.classList.add("show");
  }
}

function closeAll(except) {
  for (let i = 1; i <= navItems.length + 1; i++) {
    let elem = document.getElementById("nav-id-" + i)
    if (elem != except) {
      elem.classList.remove("show");
    }
  }
}

var addNavbarListeners = () => {
  let nav = document.querySelector("nav");
  let navId = 1;
  nav.querySelectorAll("[data-action='dropdown-toggle']").forEach((dropdownToggle) => {
    let dropdown = document.getElementById("nav-id-" + navId++);
    dropdownToggle.addEventListener("click", () => {
      closeAll(dropdown);
      toggleElement(dropdown);
    });
  });

  nav.querySelector("[data-action='nav-toggle']").addEventListener("click", () => {
    if (nav.classList.contains("opened")) {
      nav.classList.remove("opened");
    } else {
      nav.classList.add("opened");
    }
  });
}
document.open();
document.write(Navbar)
addNavbarListeners();
document.close();
</script>
</div>
<div id="header">
<h1>Configuring Capsules with a Load Balancer</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="load-balancing-solution-architecture">1. Load Balancing Solution Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can configure Satellite&#160;Server to use a load balancer to distribute client requests and network load across multiple Capsule&#160;Servers.
This results in an overall performance improvement on Capsule&#160;Servers.</p>
</div>
<div class="paragraph">
<p>This guide outlines how to prepare Satellite&#160;Server and Capsule&#160;Server for load balancing, and provides guidelines on how to configure a load balancer and register clients in a load-balanced setup.</p>
</div>
<div class="paragraph">
<p>A load-balanced setup consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Satellite&#160;Server</p>
</li>
<li>
<p>Two or more Capsule&#160;Servers</p>
</li>
<li>
<p>A load balancer</p>
</li>
<li>
<p>Multiple clients</p>
</li>
</ul>
</div>
<div id="satellite-load-balancing-solution-architecture" class="imageblock">
<div class="content">
<img src="images/satellite_load_balancing_architecture.png" alt="Load Balancing Solution Architecture">
</div>
<div class="title">Figure 1. Satellite Load Balancing Solution Architecture</div>
</div>
<div class="paragraph">
<p>In a load-balanced setup, nearly all Capsule functionality continues to work as expected when one Capsule&#160;Server is down, for planned or unplanned maintenance.
Load balancer works with the following services and features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Registration using <code>subscription-manager</code></p>
</li>
<li>
<p>Content Management with <code>yum</code> repositories</p>
</li>
<li>
<p>Optional: Puppet</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In the load-balanced setup, a load balancer distributes load only for the services and features mentioned above.
If other services, such as provisioning or virt-who, are running on the individual Capsules, you must access them directly through Capsules and not through the load balancer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Managing Puppet Limitations</div>
<p>Puppet Certificate Authority (CA) management does not support certificate signing in a load-balanced setup.
Puppet CA stores certificate information, such as the serial number counter and CRL, on the file system.
Multiple writer processes that attempt to use the same data can corrupt it.</p>
</div>
<div class="paragraph">
<p>To manage this Puppet limitation, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure Puppet certificate signing on one Capsule&#160;Server, typically the first system where you configure Capsule&#160;Server for load balancing.</p>
</li>
<li>
<p>Configure the clients to send CA requests to port 8141 on a load balancer.</p>
</li>
<li>
<p>Configure a load balancer to redirect CA requests from port 8141 to port 8140 on the system where you configure Capsule&#160;Server to sign Puppet certificates.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="load-balancing-considerations">2. Load Balancing Considerations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Distributing load between several Capsule&#160;Servers prevents any one Capsule from becoming a single point of failure.
Configuring Capsules to use a load balancer can provide resilience against planned and unplanned outages.
This improves availability and responsiveness.</p>
</div>
<div class="paragraph">
<p>Consider the following guidelines when configuring load balancing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you use Puppet, Puppet certificate signing is assigned to the first Capsule that you configure.
If the first Capsule is down, clients cannot obtain Puppet content.</p>
</li>
<li>
<p>This solution does not use Pacemaker or other similar HA tools to maintain one state across all Capsules.
To troubleshoot issues, reproduce the issue on each Capsule, bypassing the load balancer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Additional Maintenance Required for Load Balancing</div>
<p>Configuring Capsules to use a load balancer results in a more complex environment and requires additional maintenance.</p>
</div>
<div class="paragraph">
<p>The following additional steps are required for load balancing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You must ensure that all Capsules have the same Content Views and synchronize all Capsules to the same Content View versions</p>
</li>
<li>
<p>You must upgrade each Capsule in sequence</p>
</li>
<li>
<p>You must backup each Capsule that you configure regularly</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Upgrading Capsule&#160;Servers in a Load Balancing Configuration</div>
<p>To upgrade Capsule&#160;Servers from 6.9 to 6.10, complete the <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html/upgrading_and_updating_red_hat_satellite/upgrading_red_hat_satellite#upgrading_capsule_server">Upgrading Capsule&#160;Servers</a> procedure in <em>Upgrading and Updating Red&#160;Hat Satellite</em>.
There are no additional steps required for Capsule&#160;Servers in a load balancing configuration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preparing-satellite-server-and-capsule-servers">3. Prerequisites for Configuring Capsule&#160;Servers for Load Balancing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To configure Capsule&#160;Servers for load balancing, complete the following procedures described in <em>Installing Capsule&#160;Server</em>.
Satellite does not support configuring existing Capsule&#160;Servers for load balancing.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/installing_capsule_server/index#registering-to-satellite-server_capsule">Registering Capsule&#160;Server to Satellite&#160;Server</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/installing_capsule_server/index#attaching-satellite-infrastructure-subscription_capsule">Attaching the Satellite Infrastructure Subscription</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/installing_capsule_server/index#configuring-repositories-proxy_capsule">Configuring Repositories</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/installing_capsule_server/index#synchronizing-the-system-clock-with-chronyd_capsule">Synchronizing the System Clock With chronyd</a></p>
</li>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/installing_capsule_server/index#installing-capsule-server-packages_capsule">Installing Capsule&#160;Server Packages</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-capsule-servers-for-load-balancing">4. Configuring Capsule&#160;Servers for Load Balancing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter outlines how to configure Capsule&#160;Servers for load balancing.
Proceed to one of the following sections depending on your Satellite&#160;Server configuration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#configuring-capsule-server-with-default-ssl-certificates-for-load-balancing-without-puppet">Configuring Capsule&#160;Server with Default SSL Certificates for Load Balancing without Puppet</a></p>
</li>
<li>
<p><a href="#configuring-capsule-server-with-default-ssl-certificates-for-load-balancing-with-puppet">Configuring Capsule&#160;Server with Default SSL Certificates for Load Balancing with Puppet</a></p>
</li>
<li>
<p><a href="#configuring-capsule-server-with-custom-ssl-certificates-for-load-balancing-without-puppet">Configuring Capsule&#160;Server with Custom SSL Certificates for Load Balancing without Puppet</a></p>
</li>
<li>
<p><a href="#configuring-capsule-server-with-custom-ssl-certificates-for-load-balancing-with-puppet">Configuring Capsule&#160;Server with Custom SSL Certificates for Load Balancing with Puppet</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Use different file names for the Katello certificates you create for each Capsule&#160;Server.
For example, name the certificate archive file with Capsule&#160;Server FQDN.</p>
</div>
<div class="sect2">
<h3 id="configuring-capsule-server-with-default-ssl-certificates-for-load-balancing-without-puppet">4.1. Configuring Capsule&#160;Server with Default SSL Certificates for Load Balancing without Puppet</h3>
<div class="paragraph">
<p>The following section describes how to configure Capsule&#160;Servers that use default SSL certificates for load balancing without Puppet.</p>
</div>
<div class="paragraph">
<p>Complete this procedure on each Capsule&#160;Server that you want to configure for load balancing.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Satellite&#160;Server, generate Katello certificates for Capsule&#160;Server, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># capsule-certs-generate \
--foreman-proxy-fqdn <em>capsule.example.com</em> \
--certs-tar "/root/<em>capsule.example.com</em>-certs.tar" \
--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
<div class="paragraph">
<p>Retain a copy of the example <code>satellite-installer</code> command that is output by the <code>capsule-certs-generate</code> command for installing Capsule&#160;Server certificate.</p>
</div>
</li>
<li>
<p>Copy the certificate archive file from Satellite&#160;Server to Capsule&#160;Server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp /root/<em>capsule.example.com</em>-certs.tar \
root@<em>capsule.example.com</em>:<em>capsule.example.com</em>-certs.tar</pre>
</div>
</div>
</li>
<li>
<p>Append the following options to the <code>satellite-installer</code> command that you obtain from the output of the <code>capsule-certs-generate</code> command.
Set the <code>--puppet-ca-server</code> option to point to Capsule&#160;Server where you enter the command.
You must install Puppet CA on your Capsule&#160;Servers, regardless of whether you intend to use it or not.
Puppet is configured in its default single-node configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule.example.com</em>" \
--foreman-proxy-puppetca "true" \
--puppet-server-ca "true" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, enter the <code>satellite-installer</code> command, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --scenario capsule \
--foreman-proxy-register-in-foreman "true" \
--foreman-proxy-foreman-base-url "<em>https://satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>capsule.example.com</em>" \
--foreman-proxy-oauth-consumer-key "<em>oauth key</em>" \
--foreman-proxy-oauth-consumer-secret "<em>oauth secret</em>" \
--certs-tar-file "<em>capsule.example.com-certs.tar</em>" \
--puppet-server-foreman-url "<em>https://satellite.example.com</em>" \
--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule.example.com</em>" \
--foreman-proxy-puppetca "true" \
--puppet-server-ca "true" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-capsule-server-with-default-ssl-certificates-for-load-balancing-with-puppet">4.2. Configuring Capsule&#160;Server with Default SSL Certificates for Load Balancing with Puppet</h3>
<div class="paragraph">
<p>The following section describes how to configure Capsule&#160;Servers that use default SSL certificates for load balancing with Puppet.</p>
</div>
<div class="paragraph">
<p>If you use Puppet in your Satellite configuration, you must complete the following procedures:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#configuring-capsule-server-to-generate-and-sign-puppet-certificates-default-certs">Configuring Capsule&#160;Server to Generate and Sign Puppet Certificates</a></p>
</li>
<li>
<p><a href="#configuring-remaining-capsule-servers-for-load-balancing-default-certs">Configuring Remaining Capsule&#160;Servers for Load Balancing</a></p>
</li>
</ol>
</div>
<div id="configuring-capsule-server-to-generate-and-sign-puppet-certificates-default-certs" class="paragraph">
<div class="title">Configuring Capsule&#160;Server to Generate and Sign Puppet Certificates</div>
<p>Complete this procedure only for the system where you want to configure Capsule&#160;Server to generate and sign Puppet certificates for all other Capsule&#160;Servers that you configure for load balancing.
In the examples in this procedure, the FQDN of this Capsule&#160;Server is <code>capsule-ca.example.com</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On Satellite&#160;Server, generate Katello certificates for the system where you configure Capsule&#160;Server to generate and sign Puppet certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># capsule-certs-generate \
--foreman-proxy-fqdn <em>capsule-ca.example.com</em> \
--certs-tar "/root/<em>capsule-ca.example.com</em>-certs.tar" \
--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
<div class="paragraph">
<p>Retain a copy of the example <code>satellite-installer</code> command that is output by the <code>capsule-certs-generate</code> command for installing Capsule&#160;Server certificate.</p>
</div>
</li>
<li>
<p>Copy the certificate archive file from Satellite&#160;Server to Capsule&#160;Server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp /root/<em>capsule-ca.example.com</em>-certs.tar \
root@<em>capsule-ca.example.com</em>:<em>capsule-ca.example.com</em>-certs.tar</pre>
</div>
</div>
</li>
<li>
<p>Append the following options to the <code>satellite-installer</code> command that you obtain from the output of the <code>capsule-certs-generate</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule-ca.example.com</em>" \
--foreman-proxy-puppetca "true" \
--puppet-server-ca "true" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, enter the <code>satellite-installer</code> command, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --scenario capsule \
--foreman-proxy-register-in-foreman "true" \
--foreman-proxy-foreman-base-url "<em>https://satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>capsule-ca.example.com</em>" \
--foreman-proxy-oauth-consumer-key "<em>oauth key</em>" \
--foreman-proxy-oauth-consumer-secret "<em>oauth secret</em>" \
--certs-tar-file "<em>capsule-ca.example.com-certs.tar</em>" \
--puppet-server-foreman-url "<em>https://satellite.example.com</em>" \
--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule-ca.example.com</em>" \
--foreman-proxy-puppetca "true" \
--puppet-server-ca "true" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, stop the Puppet server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># puppet resource service puppetserver ensure=stopped</pre>
</div>
</div>
</li>
<li>
<p>Generate Puppet certificates for all other Capsule&#160;Servers that you configure for load balancing, except the first system where you configure Puppet certificates signing:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># puppetserver ca generate --certname <em>capsule.example.com</em> \
--subject-alt-names <em>loadbalancer.example.com</em> --ca-client</pre>
</div>
</div>
<div class="paragraph">
<p>This command creates the following files on the system where you configure Capsule&#160;Server to sign Puppet certificates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/etc/puppetlabs/puppet/ssl/certs/ca.pem</code></p>
</li>
<li>
<p><code>/etc/puppetlabs/puppet/ssl/certs/<em>capsule.example.com</em>.pem</code></p>
</li>
<li>
<p><code>/etc/puppetlabs/puppet/ssl/private_keys/<em>capsule.example.com</em>.pem</code></p>
</li>
<li>
<p><code>/etc/puppetlabs/puppet/ssl/public_keys/<em>capsule.example.com</em>.pem</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Resume the Puppet server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># puppet resource service puppetserver ensure=running</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="configuring-remaining-capsule-servers-for-load-balancing-default-certs" class="paragraph">
<div class="title">Configuring Remaining Capsule&#160;Servers for Load Balancing</div>
<p>Complete this procedure on each Capsule&#160;Server excluding the system where you configure Capsule&#160;Server to sign Puppet certificates.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On Satellite&#160;Server, generate Katello certificates for Capsule&#160;Server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># capsule-certs-generate \
--foreman-proxy-fqdn <em>capsule.example.com</em> \
--certs-tar "/root/<em>capsule.example.com</em>-certs.tar" \
--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
<div class="paragraph">
<p>Retain a copy of the example <code>satellite-installer</code> command that is output by the <code>capsule-certs-generate</code> command for installing Capsule&#160;Server certificate.</p>
</div>
</li>
<li>
<p>Copy the certificate archive file from Satellite&#160;Server to Capsule&#160;Server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp /root/<em>capsule.example.com</em>-certs.tar \
root@<em>capsule.example.com</em>:<em>capsule.example.com</em>-certs.tar</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, install the <code>puppetserver</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain packages install puppetserver</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, create directories for puppet certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir -p /etc/puppetlabs/puppet/ssl/certs/ \
/etc/puppetlabs/puppet/ssl/private_keys/ \
/etc/puppetlabs/puppet/ssl/public_keys/</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, copy the Puppet certificates for this Capsule&#160;Server from the system where you configure Capsule&#160;Server to sign Puppet certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp root@<em>capsule-ca.example.com</em>:/etc/puppetlabs/puppet/ssl/certs/ca.pem \
/etc/puppetlabs/puppet/ssl/certs/ca.pem
# scp root@<em>capsule-ca.example.com</em>:/etc/puppetlabs/puppet/ssl/certs/<em>capsule.example.com</em>.pem \
/etc/puppetlabs/puppet/ssl/certs/<em>capsule.example.com</em>.pem
# scp root@<em>capsule-ca.example.com</em>:/etc/puppetlabs/puppet/ssl/private_keys/<em>capsule.example.com</em>.pem \
/etc/puppetlabs/puppet/ssl/private_keys/<em>capsule.example.com</em>.pem
# scp root@<em>capsule-ca.example.com</em>:/etc/puppetlabs/puppet/ssl/public_keys/<em>capsule.example.com</em>.pem \
/etc/puppetlabs/puppet/ssl/public_keys/<em>capsule.example.com</em>.pem</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, change the directory ownership to user <code>puppet</code>, group <code>puppet</code> and set the SELinux contexts:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chown -R puppet:puppet /etc/puppetlabs/puppet/ssl/
# restorecon -Rv /etc/puppetlabs/puppet/ssl/</pre>
</div>
</div>
</li>
<li>
<p>Append the following options to the <code>satellite-installer</code> command that you obtain from the output of the <code>capsule-certs-generate</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule-ca.example.com</em>" \
--foreman-proxy-puppetca "false" \
--puppet-server-ca "false" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, enter the <code>satellite-installer</code> command, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --scenario capsule \
--foreman-proxy-register-in-foreman "true" \
--foreman-proxy-foreman-base-url "<em>https://satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>capsule.example.com</em>" \
--foreman-proxy-oauth-consumer-key "<em>oauth key</em>" \
--foreman-proxy-oauth-consumer-secret "<em>oauth secret</em>" \
--certs-tar-file "<em>capsule.example.com-certs.tar</em>" \
--puppet-server-foreman-url "<em>https://satellite.example.com</em>" \
--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule-ca.example.com</em>" \
--foreman-proxy-puppetca "false" \
--puppet-server-ca :false" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-capsule-server-with-custom-ssl-certificates-for-load-balancing-without-puppet">4.3. Configuring Capsule&#160;Server with Custom SSL Certificates for Load Balancing without Puppet</h3>
<div class="paragraph">
<p>The following section describes how to configure Capsule&#160;Servers that use custom SSL certificates for load balancing without Puppet.</p>
</div>
<div class="sect3">
<h4 id="_creating_custom_ssl_certificates_for_capsuleserver">4.3.1. Creating Custom SSL Certificates for Capsule&#160;Server</h4>
<div class="paragraph">
<p>This procedure outlines how to create a configuration file for the Certificate Signing Request and include the load balancer and Capsule&#160;Server as Subject Alternative Names (SAN).
Complete this procedure on each Capsule&#160;Server that you want to configure for load balancing.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Capsule&#160;Server, create a directory to contain all the source certificate files, accessible to only the <code>root</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir /root/capsule_cert
# cd /root/capsule_cert</pre>
</div>
</div>
</li>
<li>
<p>Create a private key with which to sign the Certificate Signing Request (CSR).</p>
<div class="paragraph">
<p>Note that the private key must be unencrypted.
If you use a password-protected private key, remove the private key password.</p>
</div>
<div class="paragraph">
<p>If you already have a private key for this Capsule&#160;Server, skip this step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># openssl genrsa -out /root/capsule_cert/capsule_cert_key.pem 4096</pre>
</div>
</div>
</li>
<li>
<p>Create the certificate request configuration file with the following content:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[ req ]
default_bits       = 4096
distinguished_name = req_distinguished_name
req_extensions     = req_ext
prompt = no

[ req_distinguished_name ]
countryName=<em>2 Letter Country Code</em>
stateOrProvinceName=<em>State or Province Full Name</em>
localityName=<em>Locality Name</em>
0.organizationName=<em>Organization Name</em>
organizationalUnitName=<em>Capsule Organization Unit Name</em>
commonName=<em>capsule.example.com</em>  <b class="conum">(1)</b>
emailAddress=<em>Email Address</em>

[ req_ext ]
#authorityKeyIdentifier=keyid,issuer
#basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]                  <b class="conum">(2)</b>
DNS.1 = <em>loadbalancer.example.com</em>
DNS.2 = <em>capsule.example.com</em></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The certificate&#8217;s common name must match the FQDN of Capsule&#160;Server.
Ensure to change this when running the command on each Capsule&#160;Server that you configure for load balancing.
You can also set a wildcard value <code>*</code>.
If you set a wildcard value, you must add the <code>-t capsule</code> option when you use the <code>katello-certs-check</code> command.</p>
</li>
<li>
<p>Under <code>[alt_names]</code>, include the FQDN of the load balancer as <code>DNS.1</code> and the FQDN of Capsule&#160;Server as <code>DNS.2</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a Certificate Signing Request (CSR) for the SAN certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># openssl req -new \
-key /root/capsule_cert/capsule_cert_key.pem \ <b class="conum">(1)</b>
-config SAN_config.cfg \                   <b class="conum">(2)</b>
-out /root/capsule_cert/capsule_cert_csr.pem   <b class="conum">(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Capsule&#160;Server’s private key, used to sign the certificate</p>
</li>
<li>
<p>The certificate request configuration file</p>
</li>
<li>
<p>Certificate Signing Request file</p>
</li>
</ol>
</div>
</li>
<li>
<p>Send the certificate request to the Certificate Authority:</p>
<div class="paragraph">
<p>When you submit the request, specify the lifespan of the certificate.
The method for sending the certificate request varies, so consult the Certificate Authority for the preferred method.
In response to the request, you can expect to receive a Certificate Authority bundle and a signed certificate, in separate files.</p>
</div>
</li>
<li>
<p>Copy the Certificate Authority bundle and Capsule&#160;Server certificate file that you receive from the Certificate Authority, and Capsule&#160;Server private key to your Satellite&#160;Server.</p>
</li>
<li>
<p>On Satellite&#160;Server, validate Capsule&#160;Server certificate input files:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># katello-certs-check \
-c /root/capsule_cert/capsule_cert.pem \      <b class="conum">(1)</b>
-k /root/capsule_cert/capsule_cert_key.pem \  <b class="conum">(2)</b>
-b /root/capsule_cert/ca_cert_bundle.pem      <b class="conum">(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Capsule&#160;Server certificate file, provided by your Certificate Authority</p>
</li>
<li>
<p>Capsule&#160;Server’s private key that you used to sign the certificate</p>
</li>
<li>
<p>Certificate Authority bundle, provided by your Certificate Authority</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you set the <code>commonName=</code> to a wildcard value <code>*</code>, you must add the <code>-t capsule</code> option to the <code>katello-certs-check</code> command.</p>
</div>
<div class="paragraph">
<p>Retain a copy of the example <code>capsule-certs-generate</code> command that is output by the <code>katello-certs-check</code> command for creating the Certificate Archive File for this Capsule&#160;Server.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_capsuleserver_with_custom_ssl_certificates_for_load_balancing_without_puppet">4.3.2. Configuring Capsule&#160;Server with Custom SSL Certificates for Load Balancing without Puppet</h4>
<div class="paragraph">
<p>Complete this procedure on each Capsule&#160;Server that you want to configure for load balancing.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Append the following option to the <code>capsule-certs-generate</code> command that you obtain from the output of the <code>katello-certs-check</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
</li>
<li>
<p>On Satellite&#160;Server, enter the <code>capsule-certs-generate</code> command to generate Capsule certificates.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># capsule-certs-generate \
--foreman-proxy-fqdn <em>capsule.example.com</em> \
--certs-tar /root/capsule_cert/capsule.tar \
--server-cert /root/capsule_cert/capsule.pem \
--server-key /root/capsule_cert/capsule.pem \
--server-ca-cert /root/capsule_cert/ca_cert_bundle.pem \
--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
<div class="paragraph">
<p>Retain a copy of the example <code>satellite-installer</code> command from the output for installing Capsule&#160;Server certificates.</p>
</div>
</li>
<li>
<p>Copy the certificate archive file from Satellite&#160;Server to Capsule&#160;Server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp /root/<em>capsule.example.com</em>-certs.tar \
root@<em>capsule.example.com</em>:<em>capsule.example.com</em>-certs.tar</pre>
</div>
</div>
</li>
<li>
<p>Append the following options to the <code>satellite-installer</code> command that you obtain from the output of the <code>capsule-certs-generate</code> command.
Set the <code>--puppet-ca-server</code> option to point to Capsule&#160;Server where you enter the command.
You must install Puppet CA on your Capsule&#160;Servers, regardless of whether you intend to use it or not.
Puppet is configured in its default single-node configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule.example.com</em>" \
--foreman-proxy-puppetca "true" \
--puppet-server-ca "true" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, enter the <code>satellite-installer</code> command, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --scenario capsule \
--foreman-proxy-register-in-foreman "true" \
--foreman-proxy-foreman-base-url "<em>https://satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>capsule.example.com</em>" \
--foreman-proxy-oauth-consumer-key "<em>oauth key</em>" \
--foreman-proxy-oauth-consumer-secret "<em>oauth secret</em>" \
--certs-tar-file "<em>capsule.example.com-certs.tar</em>" \
--puppet-server-foreman-url "<em>https://satellite.example.com</em>" \
--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule.example.com</em>" \
--foreman-proxy-puppetca "true" \
--puppet-server-ca "true" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-capsule-server-with-custom-ssl-certificates-for-load-balancing-with-puppet">4.4. Configuring Capsule&#160;Server with Custom SSL Certificates for Load Balancing with Puppet</h3>
<div class="paragraph">
<p>The following section describes how to configure Capsule&#160;Servers that use custom SSL certificates for load balancing with Puppet.</p>
</div>
<div class="sect3">
<h4 id="_creating_custom_ssl_certificates_for_capsuleserver_2">4.4.1. Creating Custom SSL Certificates for Capsule&#160;Server</h4>
<div class="paragraph">
<p>This procedure outlines how to create a configuration file for the Certificate Signing Request and include the load balancer and Capsule&#160;Server as Subject Alternative Names (SAN).
Complete this procedure on each Capsule&#160;Server that you want to configure for load balancing.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Capsule&#160;Server, create a directory to contain all the source certificate files, accessible to only the <code>root</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir /root/capsule_cert
# cd /root/capsule_cert</pre>
</div>
</div>
</li>
<li>
<p>Create a private key with which to sign the Certificate Signing Request (CSR).</p>
<div class="paragraph">
<p>Note that the private key must be unencrypted.
If you use a password-protected private key, remove the private key password.</p>
</div>
<div class="paragraph">
<p>If you already have a private key for this Capsule&#160;Server, skip this step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># openssl genrsa -out /root/capsule_cert/capsule.pem 4096</pre>
</div>
</div>
</li>
<li>
<p>Create the certificate request configuration file with the following content:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[ req ]
default_bits       = 4096
distinguished_name = req_distinguished_name
req_extensions     = req_ext
prompt = no

[ req_distinguished_name ]
countryName=<em>2 Letter Country Code</em>
stateOrProvinceName=<em>State or Province Full Name</em>
localityName=<em>Locality Name</em>
0.organizationName=<em>Organization Name</em>
organizationalUnitName=<em>Capsule Organization Unit Name</em>
commonName=<em>capsule.example.com</em>  <b class="conum">(1)</b>
emailAddress=<em>Email Address</em>

[ req_ext ]
#authorityKeyIdentifier=keyid,issuer
#basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]                  <b class="conum">(2)</b>
DNS.1 = <em>loadbalancer.example.com</em>
DNS.2 = <em>capsule.example.com</em></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The certificate&#8217;s common name must match the FQDN of Capsule&#160;Server.
Ensure to change this when running the command on each Capsule&#160;Server.
You can also set a wildcard value <code>*</code>.
If you set a wildcard value, you must add the <code>-t capsule</code> option when you use the <code>katello-certs-check</code> command.</p>
</li>
<li>
<p>Under <code>[alt_names]</code>, include the FQDN of the load balancer as <code>DNS.1</code> and the FQDN of Capsule&#160;Server as <code>DNS.2</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a Certificate Signing Request (CSR) for the SAN certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># openssl req -new \
-key /root/capsule_cert/capsule.pem \ <b class="conum">(1)</b>
-config SAN_config.cfg \          <b class="conum">(2)</b>
-out /root/capsule_cert/capsule.pem   <b class="conum">(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Capsule&#160;Server’s private key, used to sign the certificate</p>
</li>
<li>
<p>The certificate request configuration file</p>
</li>
<li>
<p>Certificate Signing Request file</p>
</li>
</ol>
</div>
</li>
<li>
<p>Send the certificate request to the Certificate Authority:</p>
<div class="paragraph">
<p>When you submit the request, specify the lifespan of the certificate.
The method for sending the certificate request varies, so consult the Certificate Authority for the preferred method.
In response to the request, you can expect to receive a Certificate Authority bundle and a signed certificate, in separate files.</p>
</div>
</li>
<li>
<p>Copy the Certificate Authority bundle and Capsule&#160;Server certificate file that you receive from the Certificate Authority, and Capsule&#160;Server private key to your Satellite&#160;Server to validate them.</p>
</li>
<li>
<p>On Satellite&#160;Server, validate Capsule&#160;Server certificate input files:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># katello-certs-check \
-c /root/capsule_cert/capsule.pem \      <b class="conum">(1)</b>
-k /root/capsule_cert/capsule.pem \      <b class="conum">(2)</b>
-b /root/capsule_cert/ca_cert_bundle.pem <b class="conum">(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Capsule&#160;Server certificate file, provided by your Certificate Authority</p>
</li>
<li>
<p>Capsule&#160;Server’s private key that you used to sign the certificate</p>
</li>
<li>
<p>Certificate Authority bundle, provided by your Certificate Authority</p>
<div class="paragraph">
<p>If you set the <code>commonName=</code> to a wildcard value <code>*</code>, you must add the <code>-t capsule</code> option to the <code>katello-certs-check</code> command.</p>
</div>
<div class="paragraph">
<p>Retain a copy of the example <code>capsule-certs-generate</code> command that is output by the <code>katello-certs-check</code> command for creating the Certificate Archive File for this Capsule&#160;Server.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_capsuleserver_with_custom_ssl_certificates_for_load_balancing_with_puppet">4.4.2. Configuring Capsule&#160;Server with Custom SSL Certificates for Load Balancing with Puppet</h4>
<div class="paragraph">
<p>If you use Puppet in your Satellite configuration, then you must complete the following procedures:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#configuring-capsule-server-to-generate-and-sign-puppet-certificates-custom-certs">Configuring Capsule&#160;Server to Generate and Sign Puppet Certificates</a></p>
</li>
<li>
<p><a href="#configuring-remaining-capsule-servers-for-load-balancing-custom-certs">Configuring Remaining Capsule&#160;Servers for Load Balancing</a></p>
</li>
</ol>
</div>
<div id="configuring-capsule-server-to-generate-and-sign-puppet-certificates-custom-certs" class="paragraph">
<div class="title">Configuring Capsule&#160;Server to Generate and Sign Puppet Certificates</div>
<p>Complete this procedure only for the system where you want to configure Capsule&#160;Server to generate Puppet certificates for all other Capsule&#160;Servers that you configure for load balancing.
In the examples in this procedure, the FQDN of this Capsule&#160;Server is <code>capsule-ca.example.com</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Append the following option to the <code>capsule-certs-generate</code> command that you obtain from the output of the <code>katello-certs-check</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
</li>
<li>
<p>On Satellite&#160;Server, enter the <code>capsule-certs-generate</code> command to generate Capsule certificates.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># capsule-certs-generate \
--foreman-proxy-fqdn <em>capsule-ca.example.com</em> \
--certs-tar /root/capsule_cert/capsule-ca.tar \
--server-cert /root/capsule_cert/capsule-ca.pem \
--server-key /root/capsule_cert/capsule-ca.pem \
--server-ca-cert /root/capsule_cert/ca_cert_bundle.pem \
--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
<div class="paragraph">
<p>Retain a copy of the example <code>satellite-installer</code> command from the output for installing Capsule&#160;Server certificates.</p>
</div>
</li>
<li>
<p>Copy the certificate archive file from Satellite&#160;Server to Capsule&#160;Server.</p>
</li>
<li>
<p>Append the following options to the <code>satellite-installer</code> command that you obtain from the output of the <code>capsule-certs-generate</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule-ca.example.com</em>" \
--foreman-proxy-puppetca "true" \
--puppet-server-ca "true" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, enter the <code>satellite-installer</code> command, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">satellite-installer --scenario capsule \
--foreman-proxy-register-in-foreman "true" \
--foreman-proxy-foreman-base-url "<em>https://satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>capsule-ca.example.com</em>" \
--foreman-proxy-oauth-consumer-key "oauth key" \
--foreman-proxy-oauth-consumer-secret "oauth secret" \
--certs-tar-file "<em>certs.tgz</em>" \
--puppet-server-foreman-url "<em>https://satellite.example.com</em>" \
--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule-ca.example.com</em>" \
--foreman-proxy-puppetca "true" \
--puppet-server-ca "true" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, generate Puppet certificates for all other Capsules that you configure for load balancing, except this first system where you configure Puppet certificates signing:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># puppet cert generate <em>capsule.example.com</em> \
--dns_alt_names=<em>loadbalancer.example.com</em></pre>
</div>
</div>
<div class="paragraph">
<p>This command creates the following files on the Puppet certificate signing Capsule&#160;Server instance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/etc/puppetlabs/puppet/ssl/certs/ca.pem</code></p>
</li>
<li>
<p><code>/etc/puppetlabs/puppet/ssl/certs/capsule.example.com.pem</code></p>
</li>
<li>
<p><code>/etc/puppetlabs/puppet/ssl/private_keys/capsule.example.com.pem</code></p>
</li>
<li>
<p><code>/etc/puppetlabs/puppet/ssl/public_keys/capsule.example.com.pem</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="configuring-remaining-capsule-servers-for-load-balancing-custom-certs" class="paragraph">
<div class="title">Configuring Remaining Capsule&#160;Servers for Load Balancing</div>
<p>Complete this procedure for each Capsule&#160;Server excluding the system where you configure Capsule&#160;Server to sign Puppet certificates.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Append the following option to the <code>capsule-certs-generate</code> command that you obtain from the output of the <code>katello-certs-check</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
</li>
<li>
<p>On Satellite&#160;Server, enter the <code>capsule-certs-generate</code> command to generate Capsule certificates.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># capsule-certs-generate \
--foreman-proxy-fqdn <em>capsule.example.com</em> \
--certs-tar /root/capsule_cert/capsule.tar \
--server-cert /root/capsule_cert/capsule.pem \
--server-key /root/capsule_cert/capsule.pem \
--server-ca-cert /root/capsule_cert/ca_cert_bundle.pem \
--foreman-proxy-cname <em>loadbalancer.example.com</em></pre>
</div>
</div>
<div class="paragraph">
<p>Retain a copy of the example <code>satellite-installer</code> command from the output for installing Capsule&#160;Server certificates.</p>
</div>
</li>
<li>
<p>Copy the certificate archive file from Satellite&#160;Server to Capsule&#160;Server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp /root/<em>capsule.example.com</em>-certs.tar \
root@<em>capsule.example.com</em>:<em>capsule.example.com</em>-certs.tar</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, install the <code>puppetserver</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-maintain packages install puppetserver</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, create directories for puppet certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir -p /etc/puppetlabs/puppet/ssl/certs/ \
/etc/puppetlabs/puppet/ssl/private_keys/ \
/etc/puppetlabs/puppet/ssl/public_keys/</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, copy the Puppet certificates for this Capsule&#160;Server from the system where you configure Capsule&#160;Server to sign Puppet certificates:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp root@<em>capsule-ca.example.com</em>:/etc/puppetlabs/puppet/ssl/certs/ca.pem \
/etc/puppetlabs/puppet/ssl/certs/ca.pem
# scp root@<em>capsule-ca.example.com</em>:/etc/puppetlabs/puppet/ssl/certs/<em>capsule.example.com</em>.pem \
/etc/puppetlabs/puppet/ssl/certs/<em>capsule.example.com</em>.pem
# scp root@<em>capsule-ca.example.com</em>:/etc/puppetlabs/puppet/ssl/private_keys/<em>capsule.example.com</em>.pem \
/etc/puppetlabs/puppet/ssl/private_keys/<em>capsule.example.com</em>.pem
# scp root@<em>capsule-ca.example.com</em>:/etc/puppetlabs/puppet/ssl/public_keys/<em>capsule.example.com</em>.pem \
/etc/puppetlabs/puppet/ssl/public_keys/<em>capsule.example.com</em>.pem</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, change the directory ownership to user <code>puppet</code>, group <code>puppet</code> and set the SELinux contexts:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chown -R puppet:puppet /etc/puppetlabs/puppet/ssl/
# restorecon -Rv /etc/puppetlabs/puppet/ssl/</pre>
</div>
</div>
</li>
<li>
<p>Append the following options to the <code>satellite-installer</code> command that you obtain from the output of the <code>capsule-certs-generate</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule-ca.example.com</em>" \
--foreman-proxy-puppetca "false" \
--puppet-server-ca "false" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>On Capsule&#160;Server, enter the <code>satellite-installer</code> command, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-installer --scenario capsule \
--foreman-proxy-register-in-foreman "true" \
--foreman-proxy-foreman-base-url "<em>https://satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>satellite.example.com</em>" \
--foreman-proxy-trusted-hosts "<em>capsule.example.com</em>" \
--foreman-proxy-oauth-consumer-key "<em>oauth key</em>" \
--foreman-proxy-oauth-consumer-secret "<em>oauth secret</em>" \
--certs-tar-file "<em>capsule.example.com-certs.tar</em>" \
--puppet-server-foreman-url "<em>https://satellite.example.com</em>" \
--certs-cname "<em>loadbalancer.example.com</em>" \
--puppet-dns-alt-names "<em>loadbalancer.example.com</em>" \
--puppet-ca-server "<em>capsule-ca.example.com</em>" \
--foreman-proxy-puppetca "false" \
--puppet-server-ca "false" \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installing-the-load-balancer">5. Installing the Load Balancer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following example provides general guidance for configuring an HAProxy load balancer.
However, you can install any suitable load balancing software solution that supports TCP forwarding and sticky sessions.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On a Red&#160;Hat Enterprise Linux 7 host, install HAProxy:</p>
<div class="listingblock">
<div class="content">
<pre># yum install haproxy</pre>
</div>
</div>
</li>
<li>
<p>Install the following package that includes the <code>semanage</code> tool:</p>
<div class="listingblock">
<div class="content">
<pre># yum install policycoreutils-python</pre>
</div>
</div>
</li>
<li>
<p>Configure SELinux to allow HAProxy to bind any port:</p>
<div class="listingblock">
<div class="content">
<pre># semanage boolean --modify --on haproxy_connect_any</pre>
</div>
</div>
</li>
<li>
<p>Configure the load balancer to balance the network load for the ports as described in <a href="#ports-configuration-for-the-load-balancer">Ports Configuration for the Load Balancer</a>.
For example, to configure ports for HAProxy, edit the <code>/etc/haproxy/haproxy.cfg</code> file to correspond with the table.</p>
<div class="paragraph">
<p>You must configure sticky session on TCP port 443 to request yum metadata for RPM repositories from different Capsule&#160;Servers that you configure for load balancing.</p>
</div>
<table id="ports-configuration-for-the-load-balancer" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Ports Configuration for the Load Balancer</caption>
<colgroup>
<col style="width: 18%;">
<col style="width: 16%;">
<col style="width: 16%;">
<col style="width: 20%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Port</th>
<th class="tableblock halign-left valign-top">Mode</th>
<th class="tableblock halign-left valign-top">Balance Mode</th>
<th class="tableblock halign-left valign-top">Destination</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">roundrobin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port 80 on all Capsule&#160;Servers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port 443 on all Capsule&#160;Servers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RHSM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">roundrobin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port 8443 on all Capsule&#160;Servers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AMQP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5647</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">roundrobin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port 5647 on all Capsule&#160;Servers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Puppet (<em>Optional</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8140</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">roundrobin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port 8140 on all Capsule&#160;Servers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PuppetCA (<em>Optional</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8141</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">roundrobin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port 8140 only on the system where you configure Capsule&#160;Server to sign Puppet certificates</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SmartProxy (<em>Optional for OpenScap</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9090</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">roundrobin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port 9090 on all Capsule&#160;Servers</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Configure the load balancer to disable SSL offloading and allow client-side SSL certificates to pass through to back end servers.
This is required because communication from clients to Capsule&#160;Servers depends on client-side SSL certificates.</p>
</li>
<li>
<p>Start and enable the HAProxy service:</p>
<div class="listingblock">
<div class="content">
<pre># systemctl start haproxy
# systemctl enable haproxy</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registering-clients">6. Registering Clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can register a client running a Red&#160;Hat Enterprise Linux version 6, 7 or 8 operating system to Capsule&#160;Servers that you configure for load balancing.
For more information about registering clients and configuring them to use Puppet, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/managing_hosts/index#Registering_Hosts">Registering Hosts</a> in the <em>Managing Hosts</em> guide.</p>
</div>
<div class="paragraph">
<p>To register clients, proceed to one of the following procedures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#registering-clients-using-the-bootstrap-script">Registering Clients Using the Bootstrap Script</a></p>
</li>
<li>
<p><a href="#registering-clients-manually">Registering Clients Manually</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="registering-clients-using-the-bootstrap-script">6.1. Registering Clients Using the Bootstrap Script</h3>
<div class="paragraph">
<p>To register clients, enter the following command on the client.
You must complete the registration procedure for each client.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisite</div>
<p>Ensure that you install the bootstrap script on the client and change the script&#8217;s file permissions to executable.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/managing_hosts/index#registering-a-host-to-satellite-using-the-bootstrap-script">Registering Hosts to Red&#160;Hat Satellite Using The Bootstrap Script</a> in the <em>Managing Hosts</em> guide.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On Red&#160;Hat Enterprise Linux 8, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># /usr/libexec/platform-python bootstrap.py \
--login=<em>admin</em> \
--server <em>loadbalancer.example.com</em> \
--organization="<em>Your_Organization</em>" \
--location="<em>Your_Location</em>" \
--hostgroup="<em>Your_Hostgroup</em>" \
--activationkey=<em>your_activation_key</em> \
--enablerepos=rhel-7-server-satellite-tools-6.10-rpms \
--puppet-ca-port 8141 \    <b class="conum">(1)</b>
--force                    <b class="conum">(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Include the <code>--puppet-ca-port 8141</code> option if you use Puppet.</p>
</li>
<li>
<p>Include the <code>--force</code> option to register the client that has been previously registered to a standalone Capsule.</p>
</li>
</ol>
</div>
</li>
<li>
<p>On Red&#160;Hat Enterprise Linux 7, 6, or 5, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># python bootstrap.py --login=<em>admin</em> \
--server <em>loadbalancer.example.com</em> \
--organization="<em>Your_Organization</em>" \
--location="<em>Your_Location</em>" \
--hostgroup="<em>Your_Hostgroup</em>" \
--activationkey=<em>your_activation_key</em> \
--enablerepos=rhel-7-server-satellite-tools-6.10-rpms \
--puppet-ca-port 8141 \    <b class="conum">(1)</b>
--force                    <b class="conum">(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Include the <code>--puppet-ca-port 8141</code> option if you use Puppet.</p>
</li>
<li>
<p>Include the <code>--force</code> option to register the client that has been previously registered to a standalone Capsule.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The script prompts for the password corresponding to the Satellite user name you entered with the <code>--login</code> option.</p>
</div>
</div>
<div class="sect2">
<h3 id="registering-clients-manually">6.2. Registering Clients Manually</h3>
<div class="paragraph">
<p>To register clients manually, complete the following procedure on each client that you register.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Remove the <code>katello-ca-consumer</code> package if it is installed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum remove 'katello-ca-consumer*'</pre>
</div>
</div>
</li>
<li>
<p>Install the <code>katello-ca-consumer</code> package from the load balancer:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -Uvh \
http://<em>loadbalancer.example.com</em>/pub/katello-ca-consumer-latest.noarch.rpm</pre>
</div>
</div>
</li>
<li>
<p>Register the client and include the <code>--serverurl</code> and <code>--baseurl</code> options:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager register --org=<em>Your_Organization</em> \
--activationkey=<em>Your_Activation_Key</em> \
--serverurl=https://<em>loadbalancer.example.com</em>:8443/rhsm \
--baseurl=https://<em>loadbalancer.example.com</em>/pulp/content/</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="promoting-scap-content-to-clients">7. Promoting SCAP Content to Clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following section describes how to promote Security Content Automation Protocol (SCAP) content to clients registered to Capsule&#160;Servers that you configure for load balancing.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Ensure that you configure the SCAP content.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/administering_red_hat_satellite/index#sect-Administering-Security_Compliance_Management_with_OpenSCAP-Configuring_SCAP_Content">Configuring SCAP Content</a> in <em>Administering Red&#160;Hat Satellite</em>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Satellite web UI, navigate to <strong>Configure</strong> &gt; <strong>Classes</strong> and click <code>foreman_scap_client</code>.</p>
</li>
<li>
<p>Click the <strong>Smart Class Parameter</strong> tab.</p>
</li>
<li>
<p>In the pane to the left of the <strong>Smart Class Parameter</strong> window, click <code>port</code>.</p>
</li>
<li>
<p>In the <strong>Default Behavior</strong> area, select the <strong>Override</strong> check box.</p>
</li>
<li>
<p>From the <strong>Key Type</strong> list, select <code>integer</code>.</p>
</li>
<li>
<p>In the <strong>Default Value</strong> field, enter <code>9090</code>.</p>
</li>
<li>
<p>In the pane to the left of the <strong>Smart Class Parameter</strong> window, click <code>server</code>.</p>
</li>
<li>
<p>In the <strong>Default Behavior</strong> area, select the <strong>Override</strong> check box.</p>
</li>
<li>
<p>From the <strong>Key Type</strong> list, select <code>string</code>.</p>
</li>
<li>
<p>In the <strong>Default Value</strong> field, enter the FQDN of your load balancer.
For example, <code><em>loadbalancer.example.com</em></code>.</p>
</li>
<li>
<p>In the lower left of the <strong>Smart Class Parameter</strong> window, click <strong>Submit</strong>.</p>
</li>
<li>
<p>Add the puppet module that contains the <code>foreman_scap_client</code> puppet class to a Content View.
Publish and promote this Content View to your client&#8217;s environment.</p>
</li>
<li>
<p>If you want to verify the configuration, run the Puppet agent on the client to promote the changes.
Do not run the Puppet agent on every client manually because the Puppet agent runs on the clients every 30 minutes.</p>
<div class="listingblock">
<div class="content">
<pre># puppet agent -t --noop</pre>
</div>
</div>
</li>
<li>
<p>On the client, verify that the <code>/etc/foreman_scap_client/config.yaml</code> file contains the following lines:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># Foreman proxy to which reports should be uploaded
:server: '<em>loadbalancer.example.com</em>'
:port: 9090</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional Resources</div>
<ul>
<li>
<p>For more information about adding puppet modules to Satellite&#160;Server, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.10/html/puppet_guide/chap-red_hat_satellite-puppet_guide-adding_puppet_modules_to_red_hat_satellite_6">Adding Puppet Modules to Red&#160;Hat Satellite&#160;6</a> in the <em>Puppet Guide</em>.</p>
</li>
<li>
<p>For more information about Content Views, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9/html-single/content_management_guide/index#Managing_Content_Views">Managing Content Views</a> in the <em>Content Management Guide</em>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="verifying-the-load-balancing-configuration">8. Verifying the Load Balancing Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can verify the load balancing configuration by completing the following steps for each Capsule&#160;Server that you configure:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Shut down the base operating system for your Capsule&#160;Server.</p>
</li>
<li>
<p>Verify that content or subscription management features are available on the client registered to this Capsule.
For example, enter the <code>subscription-manager refresh</code> command on the client.</p>
</li>
<li>
<p>Restart the base operating system for your Capsule&#160;Server.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated Mar 2022
</div>
</div>
</body>
</html>