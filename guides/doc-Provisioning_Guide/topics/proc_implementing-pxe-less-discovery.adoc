[[implementing-pxe-less-discovery]]
= Implementing PXE-less Discovery

{Project} provides a PXE-less Discovery service that operates without the need for PXE-based services (DHCP and TFTP). You accomplish this using {ProjectServer}'s Discovery image. Once a discovered node is scheduled for installation, it uses `kexec` command to reload Linux kernel with OS installer without rebooting the node.

ifeval::["{build}" == "satellite"]
[NOTE]
Discovery `kexec` is a Technology Preview feature.
endif::[]

image::PXEless-mode.png[]

If you have not yet installed the Discovery service or image, see xref:building-a-discovery-image[].

The ISO for the Discovery service resides at `/usr/share/foreman-discovery-image/` and is installed using the `foreman-discovery-image` package.

.Attended Use

This ISO acts as bootable media. Copy this media to either a CD, DVD, or a USB stick. For example, to copy to a USB stick at `/dev/sdb`:

[options="nowrap" subs="+quotes"]
----
# dd bs=4M \
if=/usr/share/foreman-discovery-image/foreman-discovery-image-3.4.4-5.iso \
of=/dev/sdb
----

. Insert the Discovery boot media into a bare metal host, start the host, and boot from the media. The Discovery Image displays an option for either *Manual network setup* or *Discovery with DHCP*:

  - If selecting *Manual network setup*, the Discovery image requests a set of network options. This includes the primary network interface that connects to {ProjectServer}. This Discovery image also asks for network interface configuration options, such as an *IPv4 Address*, *IPv4 Gateway*, and an *IPv4 DNS* server.
. After entering these details, select *Next*.
. If you select *Discovery with DHCP*, the Discovery image requests only the primary network interface that connects to {ProjectServer}. It attempts to automatically configure the network interface using a DHCP server, such as one that a {SmartProxyServer} provides.
. After the primary interface configuration, the Discovery image requests the *Server URL*, which is the URL of {ProjectServer} or {SmartProxyServer} offering the Discovery service. For example, to use the integrated {SmartProxy} on {ProjectServer}, use the following URL:
+
----
https://{foreman-example-com}:{smartproxy_port}
----
+
. Set the *Connection type* to `Proxy`, then select *Next*.

. Optional: The Discovery image also provides a set of fields to input *Custom facts* for the Facter tool to relay back to {ProjectServer}. These are entered in a *name*-*value* format. Provide any custom facts you require and select *Confirm* to continue.

The {Project} reports a successful communication with {ProjectServer}'s Discovery service. Navigate to *Hosts* > *Discovered Hosts* and view the newly discovered host.

For more information about provisioning discovered hosts, see xref:creating-hosts-from-discovered-hosts[].

.Unattended Use and Customization

It is possible to create a customized Discovery ISO, which automates the process of configuring the image after booting. The Discovery image uses a Linux kernel for the operating system, which means you pass kernel parameters to the configure the image's operating system. These kernel parameters include:

proxy.url::
  The URL of the {SmartProxyServer} providing the Discovery service.

proxy.type::
  The proxy type. This is usually set to `proxy` to connect to {SmartProxyServer}. This parameter also supports a legacy `foreman` option, where communication goes directly to {ProjectServer} instead of a {SmartProxyServer}.

fdi.pxmac::
  The MAC address of the primary interface in the format of `AA:BB:CC:DD:EE:FF`. This is the interface you aim to use for communicating with {SmartProxyServer}. In automated mode, the first NIC (using network identifiers in alphabetical order) with a link is used. In semi-automated mode, a screen appears and requests you to select the correct interface.

fdi.pxip, fdi.pxgw, fdi.pxdns::
  Manually configures IP address (`fdi.pxip`), the gateway (`fdi.pxgw`), and the DNS (`fdi.pxdns`) for the primary network interface. If your omit these parameters, the image uses DHCP to configure the network interface.

fdi.pxfactname1, fdi.pxfactname2 ... fdi.pxfactnameN::
  Allows you to specify custom fact names.

fdi.pxfactvalue1, fdi.pxfactvalue2 ... fdi.pxfactvalueN::
  The values for each custom fact. Each value corresponds to a fact name. For example, `fdi.pxfactvalue1` sets the value for the fact named with `fdi.pxfactname1`.

fdi.pxauto::
  To set automatic or semi-automatic mode. If set to 0, the image uses semi-automatic mode, which allows you to confirm your choices through a set of dialog options. If set to 1, the image uses automatic mode and proceeds without any confirmation.

{ProjectServer} also provides a tool (`discovery-remaster`) in the `foreman-discovery-image` package. This tool remasters the image to include these kernel parameters. To remaster the image, run the `discovery-remaster` tool. For example:

[options="nowrap" subs="+quotes,attributes"]
----
# discovery-remaster ~/iso/foreman-discovery-image-3.4.4-5.iso \
"fdi.pxip=192.168.140.20/24 fdi.pxgw=192.168.140.1 \
fdi.pxdns=192.168.140.2 proxy.url=https://_{foreman-example-com}_:{smartproxy_port} \
proxy.type=proxy fdi.pxfactname1=customhostname \
fdi.pxfactvalue1=myhost fdi.pxmac=52:54:00:be:8e:8c fdi.pxauto=1"
----

The tool creates a new ISO file in the same directory as the original discovery image. In this scenario, it saves in the `/usr/share/foreman-discovery-image/` directory.

Copy this media to either a CD, DVD, or a USB stick. For example, to copy to a USB stick at `/dev/sdb`:

[options="nowrap" subs="+quotes"]
----
# dd bs=4M \
if=/usr/share/foreman-discovery-image/foreman-discovery-image-3.4.4-5.iso \
of=/dev/sdb
----

Insert the Discovery boot media into a bare metal host, start the host, and boot from the media.

For more information about provisioning discovered hosts, see xref:creating-hosts-from-discovered-hosts[].

.Final Notes

The host must resolve to the following provisioning templates:

  - *kexec Template:* `Discovery Red Hat kexec`
  - *provision Template:* `{Project} Kickstart Default`

For more information about associating provisioning templates, see xref:Configuring_Provisioning_Resources-Creating_Provisioning_Templates[].
