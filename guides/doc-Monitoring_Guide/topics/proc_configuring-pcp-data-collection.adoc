[id='configure-pcp-data-collection_{context}']
= Configuring PCP Data Collection

This procedure describes how to configure PCP to collect metrics about processes, Satellite, Apache HTTP Server, and PostgreSQL.

.Procedure

. Configure PCP to collect data about important Satellite processes.
+
By default, PCP collects basic system metrics. This step enables detailed metrics about the following Satellite processes:
+
* Java
* PostgreSQL
* MongoDB
* Dynflow
* Passenger
* Pulp
* Qpid
+
----
# cat >/var/lib/pcp/pmdas/proc/hotproc.conf <<EOF
#pmdahotproc
Version 1.0

fname == "java" ||
fname ~ /(qdrouterd|qpidd)/ ||
(fname == "postgres" && psargs ~ /-D/) ||
fname == "mongod" ||
fname ~ /^dynflow/ ||
psargs ~ /Passenger RackApp/ ||
fname ~ /^wsgi:pulp/ ||
psargs ~ /celery (beat|worker)/ ||
psargs ~ /pulp_streamer/ ||
psargs ~ /smart-proxy/ ||
psargs ~ /squid.conf/
EOF
----

. Configure PCP to log the process metrics being collected.
+
----
# mkdir -p /var/lib/pcp/config/pmlogconf/foreman-hotproc
# cat >/var/lib/pcp/config/pmlogconf/foreman-hotproc/summary << EOF
#pmlogconf-setup 2.0
ident   foreman hotproc metrics
probe   hotproc.control.config != "" ? include : exclude
        hotproc.psinfo.psargs
        hotproc.psinfo.cnswap
        hotproc.psinfo.nswap
        hotproc.psinfo.rss
        hotproc.psinfo.vsize
        hotproc.psinfo.cstime
        hotproc.psinfo.cutime
        hotproc.psinfo.stime
        hotproc.psinfo.utime
        hotproc.io.write_bytes
        hotproc.io.read_bytes
        hotproc.schedstat.cpu_time
        hotproc.fd.count
EOF
----

. Install the process monitoring PMDA.
+
----
# cd /var/lib/pcp/pmdas/proc
# ./Install
----

. Configure PCP to collect metrics from Apache HTTP Server.
+
.. Enable the Apache HTTP Server extended status module.
+
----
#cat >/etc/httpd/conf.d/01-status.conf <<EOF
ExtendedStatus On
LoadModule status_module modules/mod_status.so

<Location "/server-status">
PassengerEnabled off
SetHandler server-status
Order deny,allow
Deny from all
Allow from localhost
</Location>
EOF
----
.. Enable the Apache HTTP Server PMDA.
+
----
# cd /var/lib/pcp/pmdas/apache
# ./Install
----
.. Prevent the Satellite installer overwriting the extended status moduleâ€™s configuration file.
+
Add the following line to the  `/etc/foreman-installer/custom-hiera.yaml` configuration file.
+
----
apache::purge_configs: false
----

. Configure PCP to collect metrics from PostgreSQL.

.. Change to the `/var/lib/pcp/pmdas/postgresql` directory.
+
-----
# cd /var/lib/pcp/pmdas/postgresql
-----

.. Run the installer.
+
----
# ./Install
----

.. Configure the PCP database interface to permit access to the PostgreSQL database.
+
Edit the `/etc/pcpdbi.conf` configuration file, inserting the following lines:
+
[options="nowrap" subs="verbatim,quotes"]
----
$database = "dbi:Pg:dbname=foreman;host=localhost";
$username = "foreman";
$password = "_6qXfN9m5nii5iEcbz8nuiJBNsyjjdRHA_"; <1>
$os_user = "foreman";
----
+
<1> The value for _$password_ is stored in `/etc/foreman/database.yml` configuration file.

.. Change the SELinux `pcp_pmcd_t` domain permission to permit PCP access to the PostgreSQL database.
+
----
# semanage permissive -a pcp_pmcd_t
----

.. Verify the PostgreSQL PMDA is able to connect to PostgreSQL.
+
Examine the `/var/log/pcp/pmcd/postgresql.log` file to confirm the connection is established. Without a successful database connection, the PostgreSQL PMDA will remain active, but not be able to provide any metrics.
+
----
[Tue Aug 14 09:21:06] pmdapostgresql(25056) Info: PostgreSQL connection established
----
+
If you find errors in `/var/log/pcp/pmcd/postgresql.log`, restart the *pmcd* service.
+
----
# systemctl restart pmcd
----

. Enable telemetry functionality in Satellite.
+
To enable collection of metrics from Satellite, you must send metrics via the `statsd` protocol into the `pmdastatsd`.

.. Install the Statsd reciever.
+
----
# cd /var/lib/pcp/pmdas/statsd
# ./Install
----

.. Enable the Satellite telemetry functionality.
+
Add the following lines to `/etc/foreman/settings.yaml` configuration file:
+
----
:telemetry:
  :prefix: 'fm_rails'
  :statsd:
    :enabled: true
    :host: '127.0.0.1:8125'
    :protocol: 'datadog'
  :prometheus:
    :enabled: false
  :logger:
    :enabled: false
    :level: 'INFO'
----

. Restart the Apache HTTP Server and PCP to begin data collection:
+
----
# systemctl restart httpd pmcd pmlogger
----
