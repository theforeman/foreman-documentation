[id="upgrading_a_disconnected_{project-context}_server_{context}"]
= Upgrading a disconnected {ProjectServer}

Use this procedure if your {ProjectServer} is not connected to the Red{nbsp}Hat Content Delivery Network.

[WARNING]
====
// Keep this in sync with common/modules/snip_warning-maintain-config-noop.adoc
* If you customized configuration files, either manually or using a tool such as Hiera, these changes are overwritten when you enter the `{foreman-maintain}` command during upgrading or updating.
You can use the `--noop` option with the `{foreman-installer}` command to review the changes that are applied during upgrading or updating.
ifdef::satellite[]
For more information, see the Red Hat Knowledgebase solution https://access.redhat.com/solutions/3351311[How to use the noop option to check for changes in {Project} config files during an upgrade].
endif::[]
ifdef::katello,orcharhino,satellite[]
* The hammer import and export commands have been replaced with `hammer content-import` and `hammer content-export` tooling.
+
If you have scripts that are using `hammer content-view version export`, `hammer content-view version export-legacy`, `hammer repository export`, or their respective import commands, you have to adjust them to use the `hammer content-export` command instead, along with its respective import command.
* If you implemented custom certificates, you must retain the content of both the `/root/ssl-build` directory and the directory in which you created any source files associated with your custom certificates.
+
Failure to retain these files during an upgrade causes the upgrade to fail.
If these files have been deleted, they must be restored from a backup in order for the upgrade to proceed.
endif::[]
====

.Before you begin

* Review and update your firewall configuration before upgrading your {ProjectServer}.
For more information, see {InstallingServerDisconnectedDocURL}Port_and_firewall_requirements_satellite[Port and firewall requirements] in _{InstallingServerDisconnectedDocTitle}_.
* Ensure that you do not delete the manifest from the Customer Portal or in the {ProjectWebUI} because this removes all the entitlements of your content hosts.
ifdef::satellite[]
* All {ProjectServer}s must be on the same version.
endif::[]

.Export the required repositories from your connected {ProjectServer}

. Synchronize the following repositories on your connected server with the download policy set to *Immediate*:
+
* {RepoRHEL9BaseOS}
* {RepoRHEL9AppStream}
* {RepoRHEL9ServerSatelliteServerProjectVersion}
* {RepoRHEL9ServerSatelliteMaintenanceProjectVersion}
. List the repositories to identify their IDs:
+
[options="nowrap" subs="+quotes"]
----
$ hammer repository list \
--organization-label _My_Organization_Label_
----
. Export each repository in the syncable format by using its repository ID:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
$ hammer content-export complete repository \
--format syncable \
--id _My_Repository_ID_
----
. Copy the exported directories to the disconnected {ProjectServer}.

.Upgrade disconnected {ProjectServer}

. Create a backup of your {ProjectServer}:
.. Stop all {Project} services:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} service stop
----
+
.. Take a snapshot or create a backup:
* On a virtual machine, take a snapshot.
* On a physical machine, create a backup.
.. Start all {Project} services:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} service start
----

. Optional: If you made manual edits to DNS or DHCP configuration in the `/etc/zones.conf` or `/etc/dhcp/dhcpd.conf` files, back up the configuration files because the installer only supports one domain or subnet, and therefore restoring changes from these backups might be required.

. Optional: If you made manual edits to DNS or DHCP configuration files and do not want to overwrite the changes, enter the following command:
+
[options="nowrap" subs="attributes"]
----
# {foreman-installer} --foreman-proxy-dns-managed false \
--foreman-proxy-dhcp-managed false
----

. In the {ProjectWebUI}, navigate to *Hosts* > *Discovered hosts*.
If there are discovered hosts available, turn them off and then delete all entries under the `Discovered hosts` page.
Select all other organizations in turn using the organization setting menu and repeat this action as required.
Reboot these hosts after the upgrade has completed.

. Stop all {Project} services:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} service stop
----

. Remove old repositories:
+
[options="nowrap" subs="attributes"]
----
# rm /etc/yum.repos.d/*
----

. Enable access to the exported content by configuring a repository:
.. Locate the copied directories from the syncable export.
.. Create the `/etc/yum.repos.d/upgrade.repo` file and update the `baseurl` directive to point to that location:
+
[source, ini, options="nowrap" subs="+quotes,verbatim,attributes"]
----
[{RepoRHEL9BaseOS}]
name=Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)
enabled=1
metadata_expire=-1
gpgcheck=0
baseurl=file:///_BaseOS_Export_Location_/content/dist/rhel9/9/x86_64/baseos/os

[{RepoRHEL9AppStream}]
name=Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)
enabled=1
metadata_expire=-1
gpgcheck=0
baseurl=file:///_AppStream_Export_Location_/content/dist/rhel9/9/x86_64/appstream/os

[{RepoRHEL9ServerSatelliteServerProjectVersion}]
name={ProjectName} {ProjectVersion} for RHEL 9 Server RPMs x86_64
enabled=0
metadata_expire=-1
gpgcheck=0
baseurl=file:///_{Project}_Export_Location_/content/dist/layered/rhel9/x86_64/{project-context}/{ProjectVersion}/os/

[{RepoRHEL9ServerSatelliteMaintenanceProjectVersion}]
name={ProjectName} Maintenance {ProjectVersion} for RHEL 9 Server RPMs x86_64
enabled=1
metadata_expire=-1
gpgcheck=0
baseurl=file:///_{Project}_Maintenance_Export_Location_/content/dist/layered/rhel9/x86_64/sat-maintenance/{ProjectVersion}/os/
----
+
Keep the `{RepoRHEL9ServerSatelliteServerProjectVersion}` repository disabled.

. Optional: Because of the lengthy upgrade time, use a utility such as `tmux` to suspend and reattach a communication session.
You can then check the upgrade progress without staying connected to the command shell continuously.
+
If you lose connection to the command shell where the upgrade command is running, you can see the logs in `/var/log/foreman-installer/satellite.log` to check if the process completed successfully.

. Upgrade the `{foreman-maintain}` utility to its latest version:
+
[options="nowrap" subs="attributes"]
----
# {foreman-maintain} self-upgrade --maintenance-repo-label={RepoRHEL9ServerSatelliteMaintenanceProjectVersion}
----

. Determine whether the system is ready for upgrade.
When prompted, enter the Hammer admin user credentials to configure `{foreman-maintain}` with Hammer credentials.
These changes are applied to the `/etc/foreman-maintain/foreman-maintain-hammer.yml` file.
+
[options="nowrap" subs="attributes"]
----
# {foreman-maintain} upgrade check --whitelist="repositories-validate,repositories-setup"
----
+
Review the results and address any highlighted error conditions before performing the upgrade.

. Edit the `/etc/yum.repos.d/upgrade.repo` file and enable the `{RepoRHEL9ServerSatelliteServerProjectVersion}` repository:
+
[source, ini, options="nowrap" subs="+quotes,verbatim,attributes"]
----
[{RepoRHEL9ServerSatelliteServerProjectVersion}]
name={ProjectName} {ProjectVersion} for RHEL 9 Server RPMs x86_64
enabled=1
metadata_expire=-1
gpgcheck=0
baseurl=file:///_{Project}_Export_Location_/content/dist/layered/rhel9/x86_64/{project-context}/{ProjectVersion}/os/
----

. Perform the upgrade:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} upgrade run --whitelist="repositories-validate,repositories-setup"
----
+
If the script fails due to missing or outdated packages, you must download and install these separately.
For more information, see {InstallingServerDisconnectedDocURL}resolving-package-dependency-errors_satellite[Resolving Package Dependency Errors] in _{InstallingServerDisconnectedDocTitle}_.

include::snip_steps-needs-reboot.adoc[]

. Optional: If you made manual edits to DNS or DHCP configuration files, check and restore any changes required to the DNS and DHCP configuration files using the backups that you made.

. If you make changes in the previous step, restart {Project} services:
+
[options="nowrap" subs="attributes"]
----
# {foreman-maintain} service restart
----

. If you have the OpenSCAP plugin installed, but do not have the default OpenSCAP content available, enter the following command.
+
[options="nowrap" subs="attributes"]
----
# foreman-rake foreman_openscap:bulk_upload:default
----

. In the {ProjectWebUI}, navigate to *Configure* > *Discovery Rules*.
 Associate selected organizations and locations with discovery rules.
