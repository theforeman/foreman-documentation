[id="upgrading_a_disconnected_{project-context}_server_{context}"]
= Upgrading a disconnected {ProjectServer}

You can upgrade your disconnected {Project} on {RHEL} 9 by synchronizing the required repositories on your connected {Project} and synchronizing the content to the disconnected {Project} using syncable exports.

[WARNING]
====
// Keep this in sync with common/modules/snip_warning-maintain-config-noop.adoc
* If you customized configuration files, either manually or using a tool such as Hiera, these changes are overwritten when you enter the `{foreman-maintain}` command during upgrading or updating.
You can use the `--noop` option with the `{foreman-installer}` command to review the changes that are applied during upgrading or updating.
ifdef::satellite[]
For more information, see the Red Hat Knowledgebase solution https://access.redhat.com/solutions/3351311[How to use the noop option to check for changes in {Project} config files during an upgrade].
endif::[]
ifdef::katello,orcharhino,satellite[]
* The hammer import and export commands have been replaced with `hammer content-import` and `hammer content-export` tooling.
+
If you have scripts that are using `hammer content-view version export`, `hammer content-view version export-legacy`, `hammer repository export`, or their respective import commands, you have to adjust them to use the `hammer content-export` command instead, along with its respective import command.
* If you implemented custom certificates, you must retain the content of both the `/root/ssl-build` directory and the directory in which you created any source files associated with your custom certificates.
+
Failure to retain these files during an upgrade causes the upgrade to fail.
If these files have been deleted, they must be restored from a backup in order to continue the upgrade.
endif::[]
====

.Prerequisites
* Review and update your firewall configuration before upgrading your {ProjectServer}.
For more information, see {InstallingServerDisconnectedDocURL}Port_and_firewall_requirements_{project-context}[Port and firewall requirements] in _{InstallingServerDisconnectedDocTitle}_.
* Ensure that you do not delete the manifest from the Customer Portal or in the {ProjectWebUI} because this removes all the entitlements of your content hosts.
ifdef::satellite[]
* All {ProjectServer}s must be on the same version.
endif::[]

.Procedure on the connected {ProjectServer}
. Ensure that the following repositories are synchronized on your connected {ProjectServer}:
+
* {RepoRHEL9BaseOS}
* {RepoRHEL9AppStream}
* {RepoRHEL9ServerSatelliteServerProjectVersion}
. Export the repositories in a syncable format:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
$ hammer content-export complete repository \
--id=_Repo_ID_ --format=syncable
----
. Copy the exported directories to the disconnected {ProjectServer}.

.Upgrade disconnected {ProjectServer}
. Stop all {Project} services:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} service stop
----
+
. Take a snapshot or create a backup:
* On a virtual machine, take a snapshot.
* On a physical machine, create a backup.
. Start all {Project} services:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} service start
----

. Optional: If you manually edited the DNS or DHCP configuration in the `/etc/zones.conf` or `/etc/dhcp/dhcpd.conf` files, back up these configuration files.
The installer only supports one domain or subnet, and therefore restoring changes from these backups might be required.

. Optional: If you made manual edits to DNS or DHCP configuration files and do not want to overwrite the changes, enter the following command:
+
[options="nowrap" subs="attributes"]
----
# {foreman-installer} --foreman-proxy-dns-managed=false \
--foreman-proxy-dhcp-managed=false
----

. In the {ProjectWebUI}, navigate to *Hosts* > *Discovered hosts*.
If there are discovered hosts available, turn them off and then delete all entries under the *Discovered hosts* page.
Use the organization setting menu to select each remaining organization and repeat the action as needed. 
Reboot these hosts after the upgrade has completed.

. Remove old repositories:
+
[options="nowrap" subs="attributes"]
----
# rm /etc/yum.repos.d/*
----

. Identify the location of the copied exported directories from the syncable export on the connected {ProjectServer}.
. Create the `/etc/yum.repos.d/upgrade.repo` and update the `baseurl` directive accordingly:
+
[options="nowrap" subs="+quotes,attributes"]
----
[{RepoRHEL9BaseOS}]
name=Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)
metadata_expire=-1
gpgcheck=0
cost=500
baseurl=file:///<export baseos location>/content/dist/rhel9/9/x86_64/baseos/os
[{RepoRHEL9AppStream}]
name=Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)
mediaid=None
metadata_expire=-1
gpgcheck=0
cost=500
baseurl=file:///<export appstream location>/content/dist/rhel9/9/x86_64/appstream/os
[{Project}]
name={Project}
mediaid=None
metadata_expire=-1
gpgcheck=0
cost=500
baseurl=file:///<export location>/content/dist/layered/rhel8/x86_64/{project-context}/{ProjectVersion}/os/
----
+
. Upgrade {foreman-maintain} to the next version:
+
[options="nowrap" subs="attributes"]
----
# {foreman-maintain} self-upgrade  --maintenance-repo-label={Project}
----

. Use the health check option to determine if the system is ready for update.
The first time you run this command, `{foreman-maintain}` prompts you to enter the hammer admin user credentials and saves them in `/etc/foreman-maintain/foreman-maintain-hammer.yml`.
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} upgrade check --whitelist="repositories-validate,repositories-setup" \ 
--target-version={ProjectVersion}
----
. Review the results and resolve any errors before proceeding with the update.
. Due to the lengthy update time, use a utility such as `tmux` to suspend and resume the session as needed.
This allows you to monitor progress without maintaining a continuous connection to the command shell.
+
If you lose connection to the command shell running the update command, you can see the logged messages in `{installer-log-file}` to confirm whether the process completed successfully.
. Perform the update:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} upgrade run --whitelist="repositories-validate,repositories-setup" \
--target-version={ProjectVersion}
----
+
If the script fails due to missing or outdated packages, you must download and install these separately.
For more information, see {InstallingServerDisconnectedDocURL}resolving-package-dependency-errors_satellite[Resolving Package Dependency Errors] in _{InstallingServerDisconnectedDocTitle}_.

include::snip_steps-needs-reboot.adoc[]

. Optional: If you made manual edits to DNS or DHCP configuration files, check and restore any changes required to the DNS and DHCP configuration files using the backups that you made.

. If you make changes in the previous step, restart {Project} services:
+
[options="nowrap" subs="attributes"]
----
# {foreman-maintain} service restart
----

. If you have the OpenSCAP plugin installed but do not have the default OpenSCAP content available, enter the following command.
+
[options="nowrap" subs="attributes"]
----
# foreman-rake foreman_openscap:bulk_upload:default
----

. In the {ProjectWebUI}, navigate to *Configure* > *Discovery Rules* and associate the selected organizations and locations with the appropriate discovery rules.