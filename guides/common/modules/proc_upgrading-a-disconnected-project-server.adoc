:_mod-docs-content-type: PROCEDURE

[id="upgrading_a_disconnected_{project-context}_server_{context}"]
= Upgrading a disconnected {ProjectServer}

Upgrading a {ProjectServer} that is not connected to the Red{nbsp}Hat Content Delivery Network includes backing up the server, configuring the server with the latest ISO files, and running the upgrade.

include::snip_warning-maintain-config-noop.adoc[]

.Prerequisites
* If you synchronize content between your {ProjectServer}s by using exports, ensure that all your {ProjectServer}s are on the same {Project} version.
* If you have made manual edits to you DNS or DHCP configuration in the `/etc/zones.conf` or `/etc/dhcp/dhcpd.conf` files, ensure DNS and DHCP configuration management is disabled:
+
[options="nowrap" subs="attributes"]
----
# {foreman-installer} \
--foreman-proxy-dhcp-managed false \
--foreman-proxy-dns-managed false
----
+
This prevents the upgrade process from overwriting your DNS and DHCP configuration.

.Procedure
. Create a backup of your {ProjectServer}:
.. Stop all {Project} services:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} service stop
----
.. Take a snapshot or create a backup:
* On a virtual machine, take a snapshot.
* On a physical machine, create a backup.
+
.. Start all {Project} services:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} service start
----
. Remove old repositories:
+
[options="nowrap" subs="attributes"]
----
# rm /etc/yum.repos.d/*
----

. Export the required repositories from your connected {ProjectServer} to your disconnected {ProjectServer}:
.. Ensure that the following repositories are synchronized on your connected server with the download policy set to *Immediate*:
+
* `{RepoRHEL9BaseOS}`
* `{RepoRHEL9AppStream}`
* `{RepoRHEL9ServerSatelliteServerProjectVersion}`
* `{RepoRHEL9ServerSatelliteMaintenanceProjectVersion}`
.. List the repositories to identify their IDs:
+
[options="nowrap" subs="+quotes"]
----
$ hammer repository list \
--organization-label _My_Organization_Label_
----
.. Export each repository in the syncable format by using its repository ID:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
$ hammer content-export complete repository \
--format syncable \
--id _My_Repository_ID_
----
.. Copy the exported directories to the disconnected {ProjectServer}.
. On the disconnected server, enable access to the exported content by configuring a repository:
.. Locate the copied directories from the syncable export.
.. Create the `/etc/yum.repos.d/upgrade.repo` file and update the `baseurl` directive to point to that location:
+
[source, ini, options="nowrap" subs="+quotes,verbatim,attributes"]
----
[{RepoRHEL9BaseOS}]
name=Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)
enabled=1
metadata_expire=-1
gpgcheck=0
baseurl=file:///_BaseOS_Export_Location_/content/dist/rhel9/9/x86_64/baseos/os

[{RepoRHEL9AppStream}]
name=Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)
enabled=1
metadata_expire=-1
gpgcheck=0
baseurl=file:///_AppStream_Export_Location_/content/dist/rhel9/9/x86_64/appstream/os

[{RepoRHEL9ServerSatelliteServerProjectVersion}]
name={ProjectName} {ProjectVersion} for RHEL 9 Server RPMs x86_64
enabled=0
metadata_expire=-1
gpgcheck=0
baseurl=file:///_{Project}_Export_Location_/content/dist/layered/rhel9/x86_64/{project-context}/{ProjectVersion}/os/

[{RepoRHEL9ServerSatelliteMaintenanceProjectVersion}]
name={ProjectName} Maintenance {ProjectVersion} for RHEL 9 Server RPMs x86_64
enabled=1
metadata_expire=-1
gpgcheck=0
baseurl=file:///_{Project}_Maintenance_Export_Location_/content/dist/layered/rhel9/x86_64/sat-maintenance/{ProjectVersion}/os/
----
+
Keep the `{RepoRHEL9ServerSatelliteServerProjectVersion}` repository disabled.
. Upgrade the `{foreman-maintain}` utility to its latest version:
+
[options="nowrap" subs="attributes"]
----
# {foreman-maintain} self-upgrade --maintenance-repo-label={RepoRHEL9ServerSatelliteMaintenanceProjectVersion}
----
. Determine whether your system is ready for {Project} upgrade:
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} upgrade check --whitelist="repositories-validate,repositories-setup"
----
+
Review the results and address any highlighted error conditions before performing the upgrade.
+
[NOTE]
====
The `{foreman-maintain} upgrade check` might prompt you for the Hammer admin user credentials.
These changes are applied to the `/etc/foreman-maintain/foreman-maintain-hammer.yml` file.
====
. Edit the `/etc/yum.repos.d/upgrade.repo` file and enable the `{RepoRHEL9ServerSatelliteServerProjectVersion}` repository:
+
[source, ini, options="nowrap" subs="+quotes,verbatim,attributes"]
----
[{RepoRHEL9ServerSatelliteServerProjectVersion}]
name={ProjectName} {ProjectVersion} for RHEL 9 Server RPMs x86_64
enabled=1
metadata_expire=-1
gpgcheck=0
baseurl=file:///_{Project}_Export_Location_/content/dist/layered/rhel9/x86_64/{project-context}/{ProjectVersion}/os/
----
. Run the {ProjectServer} upgrade command.
Because of the lengthy upgrade time, consider using a utility such as `tmux`.
For more information, see xref:following_the_progress_of_the_upgrade_upgrading-disconnected[].
+
[options="nowrap" subs="+quotes,verbatim,attributes"]
----
# {foreman-maintain} upgrade run --whitelist="repositories-validate,repositories-setup"
----
+
If the script fails due to missing or outdated packages, you must download and install these separately.
For more information, see {InstallingServerDisconnectedDocURL}resolving-package-dependency-errors_satellite[Resolving Package Dependency Errors] in _{InstallingServerDisconnectedDocTitle}_.

include::snip_steps-needs-reboot.adoc[]

. If you have the OpenSCAP plugin installed, but do not have the default OpenSCAP content available, enter the following command.
+
[options="nowrap" subs="attributes"]
----
# foreman-rake foreman_openscap:bulk_upload:default
----

. In the {ProjectWebUI}, navigate to *Configure* > *Discovery Rules*.
 Associate selected organizations and locations with discovery rules.

include::snip_post-upgrade-tasks.adoc[]
