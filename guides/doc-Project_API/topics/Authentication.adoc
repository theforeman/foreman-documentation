[[chap-Red_Hat_Satellite-API_Guide-Authenticating_API_Calls]]
== Authenticating API calls

Interaction with the Satellite API requires SSL authentication with Satellite Server CA certificate and authentication with valid Satellite user credentials. This chapter outlines the authenticating methods you can use.

[[Authenticating_API_Calls-SSL_Authentication_Overview]]
=== SSL authentication overview

Red{nbsp}Hat Satellite uses HTTPS, which provides a degree of encryption and identity verification when communicating with a Red{nbsp}Hat Satellite{nbsp}Server. Satellite {ProjectVersion} does not support non-SSL communications.

Each Red{nbsp}Hat Satellite{nbsp}Server uses a self-signed certificate. This certificate acts as both the server certificate to verify the encryption key and the certificate authority (CA) to trust the identity of Satellite{nbsp}Server.

[[proc-API_Guide-Configuring_SSL_Authentication]]
==== Configuring SSL authentication

Use the following procedure to configure an SSL authentication for the API requests to Satellite Server.

.Procedure
. Obtain a certificate from the Satellite{nbsp}Server with which you want to communicate using one of the following options:
+
* If you execute the command from a remote server, obtain a certificate using SSH:
+
[options="nowrap" subs="+quotes"]
----
$ scp root@_satellite.example.com_:/var/www/html/pub/katello-server-ca.crt /etc/pki/ca-trust/source/anchors/_satellite.example.com_-katello-server-ca.crt
----
+
* If you execute the command directly on the Satellite{nbsp}Server, copy the certificate to the `/etc/pki/ca-trust/source/anchors` directory:
+
[options="nowrap" subs="+quotes"]
----
$ cp /var/www/html/pub/katello-server-ca.crt /etc/pki/ca-trust/source/anchors/_satellite.example.com_-katello-server-ca.crt
----

. Add the certificate to the list of trusted CAs:
+
[options="nowrap" subs="+quotes"]
----
update-ca-trust extract
----

.Verification
* Verify that the certificate is present in the NSS database by entering the API request without the `--cacert` option:
+
[options="nowrap" subs="+quotes"]
----
$ curl --request GET \
--user _sat_username:sat_password_ \
https://_satellite.example.com_/api/v2/hosts
----

[[Authenticating_API_Calls-HTTP_Authentication_Overview]]
=== HTTP authentication overview

All requests to the Satellite API require a valid Satellite user name and password. The API uses HTTP Basic Authentication to encode these credentials and add to the `Authorization` header. For more information about Basic Authentication, see http://tools.ietf.org/html/rfc2617[RFC 2617 HTTP Authentication: Basic and Digest Access Authentication].
If a request does not include an appropriate `Authorization` header, the API returns a `401 Authorization Required` error

[IMPORTANT]
Basic authentication involves potentially sensitive information, for example, it sends passwords as plain text. The REST API requires HTTPS for transport level encryption of plain text requests.

Some base64 libraries break encoded credentials into multiple lines and terminate each line with a newline character. This invalidates the header and causes a faulty request. The Authorization header requires that the encoded credentials be on a single line within the header.

[[Authenticating_API_Calls-PAT_Authentication_Overview]]
=== {PAT} authentication overview

{ProjectName} supports {PAT}s that you can use to authenticate API requests instead of using your password.
You can set an expiration date for your {PAT} and you can revoke it if you decide it should expire before the expiration date.

include::modules/proc_creating-a-personal-access-token.adoc[leveloffset=+3]

include::modules/proc_revoking-a-personal-access-token.adoc[leveloffset=+3]

[[Authenticating_API_Calls-OAuth_Authentication_Overview]]
=== OAuth authentication overview

As an alternative to basic authentication, you can use limited OAuth 1.0 authentication. This is sometimes referred to as 1-legged OAuth in version 1.0a of the protocol.

To view OAuth settings, in the Satellite web UI, navigate to *Administer* > *Settings* > *Authentication*. The *OAuth consumer key* is the token to be used by all OAuth clients.

Satellite stores OAuth settings in the `/etc/foreman/settings.yaml` file. Use the `satellite-installer` script to configure these settings, because Satellite overwrites any manual changes to this file when upgrading.

[[Configurating_OAuth]]
==== Configuring OAuth

To change the OAuth settings, enter the `satellite-installer` with the required options. Enter the following command to list all the OAuth related installer options:
[options="nowrap" subs="+quotes"]
----
# satellite-installer --full-help | grep oauth
----

.Enabling OAuth mapping

By default, Satellite authorizes all OAuth API requests as the built-in anonymous API administrator account. Therefore, API responses include all Satellite data. However, you can also specify the Foreman user that makes the request and restrict access to data to that user.

To enable OAuth user mapping, enter the following command:

----
# satellite-installer --foreman-oauth-map-users true
----

[IMPORTANT]
Satellite does not sign the header in an OAuth request. Anyone with a valid consumer key can impersonate any Foreman user.

[[OAuth_Request_Format]]
==== OAuth request format

Every OAuth API request requires the `FOREMAN-USER` header with the login of an existing Foreman user and the `Authorization` header in the following format:

[options="nowrap" subs="+quotes"]
----
--header 'FOREMAN-USER: _sat_username_' \
--header 'Authorization: OAuth oauth_version="1.0",oauth_consumer_key="_secretkey_",oauth_signature_method="hmac-sha1",oauth_timestamp=_timestamp_,oauth_signature=_signature_'
----

IMPORTANT: Use an OAuth client library to construct all OAuth parameters.
For an example that uses the *requests_oauthlib* Python module, see https://access.redhat.com/solutions/4240401[How to execute an API call using the OAuth authentication method via python script in Red Hat Satellite 6?] in the Red{nbsp}Hat Knowledgebase.

.Example
This example lists architectures using OAuth for authentication. The request uses a _sat_username_ username in the `FOREMAN-USER` header. With the `--foreman-oauth-map-users` set to `true`, the response includes only architectures that the user has access to view. The signature reflects every parameter, HTTP method, and URI change.

Example request:
[options="nowrap" subs="+quotes"]
----
$ curl 'https://_satellite.example.com_/api/architectures' \
--header 'Content-Type: application/json' \
--header 'Accept:application/json' \
--header 'FOREMAN-USER: _sat_username_' \
--header 'Authorization: OAuth oauth_version="1.0",oauth_consumer_key="_secretkey_",oauth_signature_method="hmac-sha1",oauth_timestamp=_1321473112_,oauth_signature=_Il8hR8/ogj/XVuOqMPB9qNjSy6E=_'
----

[role="_additional-resources"]
.Additional resources
* https://oauth.net/core/1.0a/[Documentation for OAuth Core 1.0 Revision A]
