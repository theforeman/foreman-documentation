<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Installing Foreman 3.7 Server on Debian/Ubuntu</title>
<style>
﻿*,::before,::after{box-sizing:border-box}html{font-size:100%;-webkit-text-size-adjust:100%}body{background:#fff;color:rgba(0,0,0,0.8);padding:0;margin:0;font-family:"Noto Serif", "DejaVu Serif", serif;font-size:inherit;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,p,blockquote,th,td{margin:0;padding:0}a{background:none;color:#2156a5;text-decoration:underline;line-height:inherit}a:active,a:hover{cursor:pointer;outline:0}a:focus{outline:thin dotted}a:hover,a:focus{color:#1d4b8f}abbr{font-size:0.9em}abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}b,strong{font-weight:bold;line-height:inherit}strong strong{font-weight:400}code,kbd,pre{font-family:"Droid Sans Mono", "DejaVu Sans Mono", monospace;font-size:1em}code{font-weight:400;color:rgba(0,0,0,0.9)}pre{color:rgba(0,0,0,0.9);line-height:1.45;text-rendering:optimizeSpeed;white-space:pre-wrap}dfn{font-style:italic}em,i{font-style:italic;line-height:inherit}em em{font-style:normal}hr{border:solid #dddddf;border-width:1px 0 0;clear:both;height:0;margin:1.25em 0 1.1875em}mark{background:#ff0;color:#000}p{line-height:1.6;margin-bottom:1.25rem;text-rendering:optimizeLegibility}q{quotes:"“" "”" "‘" "’"}small{font-size:60%;line-height:inherit}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img,object[type^="image/"],svg{display:inline-block;height:auto;max-width:100%;vertical-align:middle}img{border:0;-ms-interpolation-mode:bicubic}object{max-width:100%}svg:not(:root){overflow:hidden}figure{margin:0}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}.left{float:left !important}.right{float:right !important}.text-left{text-align:left !important}.text-right{text-align:right !important}.text-center{text-align:center !important}.text-justify{text-align:justify !important}.hide{display:none}.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:0.25em}p aside{font-size:.875em;line-height:1.35;font-style:italic}h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans", "DejaVu Sans", sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.2;word-spacing:-0.05em}h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{color:#e99b8f;line-height:0}h1{font-size:2.125em}h2{font-size:1.6875em}h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}h4,h5{font-size:1.125em}h6{font-size:1em}ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}ul,ol{margin-left:1.5em}ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}ul.square{list-style-type:square}ul.circle{list-style-type:circle}ul.disc{list-style-type:disc}ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}dl dt{margin-bottom:.3125em;font-weight:bold}dl dd{margin-bottom:1.25em;margin-left:1.125em}blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,0.85)}@media screen and (min-width: 768px){h1{font-size:2.75em}h2{font-size:2.3125em}h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}h4{font-size:1.4375em}}table{background:#fff;border:1px solid #dedede;border-collapse:collapse;border-spacing:0;margin-bottom:1.25em;word-wrap:normal}table thead,table tfoot{background:#f7f8f7}table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,0.8);text-align:left}table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,0.8)}table tr.even,table tr.alt{background:#f8f8f7}table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}.center{margin-left:auto;margin-right:auto}.stretch{width:100%}.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:"";display:table}.clearfix::after,.float-group::after{clear:both}:not(pre).nobreak{word-wrap:normal}:not(pre).nowrap{white-space:nowrap}:not(pre).pre-wrap{white-space:pre-wrap}:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal !important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}pre>code{display:block}pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}.keyseq{color:rgba(51,51,51,0.8)}kbd{display:inline-block;color:rgba(0,0,0,0.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,0.2),inset 0 0 0 0.1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}.keyseq kbd:first-child{margin-left:0}.keyseq kbd:last-child{margin-right:0}.menuseq,.menuref{color:#000}.menuseq b:not(.caret),.menuref{font-weight:inherit}.menuseq{word-spacing:-0.02em}.menuseq b.caret{font-size:1.25em;line-height:0.8}.menuseq i.caret{font-weight:bold;text-align:center;width:0.45em}b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}b.button::before{content:"[";padding:0 3px 0 2px}b.button::after{content:"]";padding:0 2px 0 3px}p a>code:hover{color:rgba(0,0,0,0.9)}body>div[id]{margin:0 auto;max-width:62.5em;position:relative;padding-left:.9375em;padding-right:0.9375em}body>div[id]::before,body>div[id]::after,#content #footnotes::before{content:"";display:table;clear:both}#content{margin-top:1.25em;margin-bottom:0.625em}#content::before{content:none}#header>h1:first-child{color:rgba(0,0,0,0.85);margin-top:2.25rem;margin-bottom:0}#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,0.6);display:flex;flex-flow:row wrap}#header .details span:first-child{margin-left:-0.125em}#header .details span.email a{color:rgba(0,0,0,0.85)}#header .details br{display:none}#header .details br+span::before{content:" – "}#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,0.85)}#header .details br+span#revremark::before{content:" | "}#header #revnumber{text-transform:capitalize}#header #revnumber::after{content:" "}#content>h1:first-child:not([class]){color:rgba(0,0,0,0.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}#toc{border-bottom:1px solid #e7e7e9;padding-bottom:0.5em}#toc>ul{margin-left:0.125em}#toc ul.sectlevel0>li>a{font-style:italic}#toc ul.sectlevel0 ul.sectlevel1{margin:0.5em 0}#toc ul{font-family:"Open Sans", "DejaVu Sans", sans-serif;list-style-type:none}#toc li{line-height:1.3334;margin-top:0.3334em}#toc a{text-decoration:none}#toc a:active{text-decoration:underline}#toctitle{color:#7a2518;font-size:1.2em}@media screen and (min-width: 768px){#toctitle{font-size:1.375em}body.toc2{padding-left:15em;padding-right:0}#toc.toc2{margin-top:0 !important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0 !important;border-bottom-width:0 !important;z-index:1000;padding:1.25em 1em;height:calc(100% - (70px + 2.5em));overflow:auto}#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}#toc.toc2>ul{font-size:.9em;margin-bottom:0}#toc.toc2 ul ul{margin-left:0;padding-left:1em}#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:0.5em}body.toc2.toc-right{padding-left:0;padding-right:15em}body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}@media screen and (min-width: 1280px){body.toc2{padding-left:20em;padding-right:0}#toc.toc2{width:20em}#toc.toc2 #toctitle{font-size:1.375em}#toc.toc2>ul{font-size:0.95em}#toc.toc2 ul ul{padding-left:1.25em}body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}#content #toc>:first-child{margin-top:0}#content #toc>:last-child{margin-bottom:0}#footer{max-width:none;background:#025d8c;padding:1.25em;margin-left:2em}#footer-text{color:rgba(255,255,255,0.8);line-height:1.44}.sect1{padding-bottom:0.625em}@media screen and (min-width: 768px){#content{margin-bottom:1.25em}.sect1{padding-bottom:1.25em}}.sect1:last-child{padding-bottom:0}.sect1+.sect1{border-top:1px solid #e7e7e9}#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none !important;visibility:hidden;text-align:center;font-weight:400}#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:0.1em}#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}details{margin-left:1.25rem}details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}details>summary::-webkit-details-marker{display:none}details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif", "DejaVu Serif", serif;font-size:1rem;font-style:italic}table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,0.85)}.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}.admonitionblock>table td.icon{text-align:center;width:80px}.admonitionblock>table td.icon img{max-width:none}.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans", "DejaVu Sans", sans-serif;text-transform:uppercase}.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,0.6);word-wrap:anywhere}.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}.exampleblock>.content{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#fffef7;border-radius:4px;box-shadow:0 1px 4px #e0e0dc}.exampleblock>.content>:first-child{margin-top:0}.exampleblock>.content>:last-child{margin-bottom:0}.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}.sidebarblock>:first-child{margin-top:0}.sidebarblock>:last-child{margin-bottom:0}.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:0.8125em}@media screen and (min-width: 768px){.literalblock pre,.listingblock>.content>pre{font-size:0.90625em}}@media screen and (min-width: 1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,0.9)}.listingblock>.content{position:relative}.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:0.5}.listingblock:hover code[data-lang]::before{display:block}.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:0.5}.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}.listingblock pre.highlightjs{padding:0}.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}.listingblock pre.prettyprint{border-width:0}.prettyprint{background:#f7f7f8}pre.prettyprint .linenums{line-height:1.45;margin-left:2em}pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}pre.prettyprint li code[data-lang]::before{opacity:1}pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}table.linenotable td.code{padding-left:0.75em}table.linenotable td.linenos{width:0.01%}table.linenotable td.linenos,pre.pygments .linenos,pre.rouge .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}pre.pygments span.linenos,pre.rouge span.linenos{display:inline-block;margin-right:0.75em}.quoteblock{margin:0 1em 1.25em 1.5em;display:table}.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:0.75em}.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,0.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}.quoteblock blockquote{margin:0;padding:0;border:0}.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,0.1)}.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}.verseblock{margin:0 1em 1.25em}.verseblock pre{font-family:"Open Sans", "DejaVu Sans", sans-serif;font-size:1.15rem;color:rgba(0,0,0,0.85);font-weight:300;text-rendering:optimizeLegibility}.verseblock pre strong{font-weight:400}.verseblock .attribution{margin-top:1.25rem;margin-left:0.5ex}.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}.quoteblock .attribution br,.verseblock .attribution br{display:none}.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,0.6)}.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}.quoteblock.abstract{margin:0 1em 1.25em;display:block}.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:0.25em solid #dddddf}.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}p.tableblock:last-child{margin-bottom:0}td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}td.tableblock>.content>:last-child{margin-bottom:-1.25em}table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}table.grid-all>*>tr>*{border-width:1px}table.grid-cols>*>tr>*{border-width:0 1px}table.grid-rows>*>tr>*{border-width:1px 0}table.frame-all{border-width:1px}table.frame-ends{border-width:1px 0}table.frame-sides{border-width:0 1px}table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}th.halign-left,td.halign-left{text-align:left}th.halign-right,td.halign-right{text-align:right}th.halign-center,td.halign-center{text-align:center}th.valign-top,td.valign-top{vertical-align:top}th.valign-bottom,td.valign-bottom{vertical-align:bottom}th.valign-middle,td.valign-middle{vertical-align:middle}table thead th,table tfoot th{font-weight:bold}tbody tr th{background:#f7f8f7}tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,0.8);font-weight:bold}p.tableblock>code:only-child{background:none;padding:0}p.tableblock{font-size:1em}ol{margin-left:1.75em}ul li ol{margin-left:1.5em}dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:0.625em}ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:0.625em}ul.unstyled,ol.unstyled{margin-left:0}li>p:empty:only-child::before{content:"";display:inline-block}ul.checklist>li>p:first-child{margin-left:-1em}ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:0.125em}ul.checklist>li>p:first-child>input[type=checkbox]:first-child{font:inherit;margin:0 .25em 0 0;padding:0}ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 0.625em -1.25em}ul.inline>li{margin-left:1.25em}.unstyled dl dt{font-weight:400;font-style:normal}ol.arabic{list-style-type:decimal}ol.decimal{list-style-type:decimal-leading-zero}ol.loweralpha{list-style-type:lower-alpha}ol.upperalpha{list-style-type:upper-alpha}ol.lowerroman{list-style-type:lower-roman}ol.upperroman{list-style-type:upper-roman}ol.lowergreek{list-style-type:lower-greek}.hdlist>table,.colist>table{border:0;background:none}.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}td.hdlist1,td.hdlist2{vertical-align:top;padding:0 0.625em}td.hdlist1{font-weight:bold;padding-bottom:1.25em}td.hdlist2{word-wrap:anywhere}.literalblock+.colist,.listingblock+.colist{margin-top:-0.5em}.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}.colist td:not([class]):first-child img{max-width:none}.colist td:not([class]):last-child{padding:0.25em 0}.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}.imageblock.left{margin:0.25em 0.625em 1.25em 0}.imageblock.right{margin:0.25em 0 1.25em 0.625em}.imageblock>.title{margin-bottom:0}.imageblock.thumb,.imageblock.th{border-width:6px}.imageblock.thumb>.title,.imageblock.th>.title{padding:0 0.125em}.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}.image.left{margin-right:0.625em}.image.right{margin-left:0.625em}a.image{text-decoration:none;display:inline-block}a.image object{pointer-events:none}sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}sup.footnote a,sup.footnoteref a{text-decoration:none}sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:0.625em}#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:0.2em}#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}#footnotes .footnote:last-of-type{margin-bottom:0}#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:0.75em 0}div.page-break{display:none}div.unbreakable{page-break-inside:avoid}.big{font-size:larger}.small{font-size:smaller}.underline{text-decoration:underline}.overline{text-decoration:overline}.line-through{text-decoration:line-through}.aqua{color:#00bfbf}.aqua-background{background:#00fafa}.black{color:#000}.black-background{background:#000}.blue{color:#0000bf}.blue-background{background:#0000fa}.fuchsia{color:#bf00bf}.fuchsia-background{background:#fa00fa}.gray{color:#606060}.gray-background{background:#7d7d7d}.green{color:#006000}.green-background{background:#007d00}.lime{color:#00bf00}.lime-background{background:#00fa00}.maroon{color:#600000}.maroon-background{background:#7d0000}.navy{color:#000060}.navy-background{background:#00007d}.olive{color:#606000}.olive-background{background:#7d7d00}.purple{color:#600060}.purple-background{background:#7d007d}.red{color:#bf0000}.red-background{background:#fa0000}.silver{color:#909090}.silver-background{background:#bcbcbc}.teal{color:#006060}.teal-background{background:#007d7d}.white{color:#bfbfbf}.white-background{background:#fafafa}.yellow{color:#bfbf00}.yellow-background{background:#fafa00}span.icon>.fa{cursor:default}a span.icon>.fa{cursor:inherit}.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,0.5);cursor:default}.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,0.8);color:#111}.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}.conum[data-value]{display:inline-block;color:#fff !important;background:rgba(0,0,0,0.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans", "DejaVu Sans", sans-serif;font-style:normal;font-weight:bold}.conum[data-value] *{color:#fff !important}.conum[data-value]+b{display:none}.conum[data-value]::after{content:attr(data-value)}pre .conum[data-value]{position:relative;top:-0.125em}b.conum *{color:inherit !important}.conum:not([data-value]):empty{display:none}dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}h1,h2,p,td.content,span.alt,summary{letter-spacing:-0.01em}p strong,td.content strong,div.footnote strong{letter-spacing:-0.005em}p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}.print-only{display:none !important}@page{margin:1.25cm 0.75cm}@media print{*{box-shadow:none !important;text-shadow:none !important}html{font-size:80%}a{color:inherit !important;text-decoration:underline !important}a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none !important}a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:0.25em}abbr[title]{border-bottom:1px dotted}abbr[title]::after{content:" (" attr(title) ")"}pre,blockquote,tr,img,object,svg{page-break-inside:avoid}thead{display:table-header-group}p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}body>div[id]{max-width:none}#toc,.sidebarblock,.exampleblock>.content{background:none !important}#toc{border-bottom:1px solid #dddddf !important;padding-bottom:0 !important}body.book #header{text-align:center}body.book #header>h1:first-child{border:0 !important;margin:2.5em 0 1em}body.book #header .details{border:0 !important;display:block;padding:0 !important}body.book #header .details span:first-child{margin-left:0 !important}body.book #header .details br{display:block}body.book #header .details br+span::before{content:none !important}body.book #toc{border:0 !important;text-align:left !important;padding:0 !important;margin:0 !important}body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}.listingblock code[data-lang]::before{display:block}div.page-break{display:block;page-break-after:always}#footer{padding:0 0.9375em}.hide-on-print{display:none !important}.print-only{display:block !important}.hide-for-print{display:none !important}.show-for-print{display:inherit !important}}@media amzn-kf8, print{#header>h1:first-child{margin-top:1.25rem}.sect1{padding:0 !important}.sect1+.sect1{border:0}#footer{background:none}#footer-text{color:rgba(0,0,0,0.6);font-size:0.9em}}@media amzn-kf8{body>div[id]{padding:0}}body{padding:0;margin:0;margin-top:70px !important}.container{position:relative;z-index:1;padding-top:50px;min-height:100%}.container p{font-family:sans-serif;font-size:1.2em}nav{position:fixed;z-index:9999;left:0;right:0;top:0;height:70px;padding:0 1.5em;background-color:#025d8c;font-family:sans-serif;line-height:70px}nav .logo{width:50px;vertical-align:middle}nav .nav-menu{position:absolute;right:0.3em;top:0;padding:0;margin:0;list-style:none}nav .nav-item{display:inline-block}nav .nav-item>a{display:inline-block;padding:0 2.5em;line-height:70px;color:#fff;text-decoration:none}nav .dropdown{position:relative}nav .dropdown a::after{content:"";display:inline-block;margin-left:0.5em;vertical-align:middle;border-top:0.3em solid #fff;border-right:0.3em solid transparent;border-left:0.3em solid transparent}nav .dropdown.show a::after{transform:rotate(180deg)}nav .dropdown-menu{display:none;position:absolute;left:0;right:0;top:100%;padding:0.5em 0;margin-top:-0.5em;border:1px solid rgba(0,0,0,0.3);border-radius:0.5em;background-color:#fff;width:max-content}nav .dropdown-menu-left{left:auto;right:0}nav .dropdown.show .dropdown-menu{display:block}nav .dropdown-div{display:block;padding:0.4em 0;line-height:4em}nav .dropdown-div a::after{content:none;margin-left:0;border-top:0;border-right:0;border-left:0}nav .dropdown-item{display:block;padding:0 1.5em;font-size:0.875em;color:#000;line-height:1.6em;text-decoration:none}nav .btn-hamburger{display:none;position:absolute;right:1.5em;top:50%;background-color:transparent;border:0;cursor:pointer;outline:none;transform:translateY(-50%)}nav .btn-hamburger span{display:block;width:30px;height:4px;background-color:#fff;margin:6px;border-radius:2px;transition:0.3s ease-in-out}nav .btn-hamburger span:nth-child(4),nav .btn-hamburger span:nth-child(5){position:absolute;top:10px;opacity:0.5}nav .btn-hamburger span:nth-child(4){transform:rotate(45deg) scale(0)}nav .btn-hamburger span:nth-child(5){transform:rotate(-45deg) scale(0)}nav.opened .btn-hamburger span:nth-child(4){opacity:1;transform:rotate(45deg) scale(1)}nav.opened .btn-hamburger span:nth-child(5){opacity:1;transform:rotate(-45deg) scale(1)}nav.opened .btn-hamburger span:nth-child(1),nav.opened .btn-hamburger span:nth-child(2),nav.opened .btn-hamburger span:nth-child(3){opacity:0}@media screen and (max-width: 768px){nav .nav-menu{position:fixed;left:0;right:0;top:70px;bottom:100%;display:flex;flex-direction:column;justify-content:start;background-color:#363d4e;transition:bottom 0.5s ease-in-out;overflow:hidden}nav.opened .nav-menu{bottom:0}nav .nav-item>a{display:block}nav .dropdown-menu{position:relative;top:0;margin:0 1.5em}nav .btn-hamburger{display:block}}@media screen{div.narrow{max-width:1080px;margin:0 auto !important;margin-top:70px auto !important;float:none !important}#toc.toc2{margin-top:70px !important}}

</style>
<!-- docinfo -->
</head>
<body class="book toc2 toc-left">
    <div id="wrap">
      <script src="/js/versions.js"></script>
      <script src="/js/nav.js"></script>
      <script>
        document.open();
        document.write(buildNavigation());
        addNavbarListeners();
        document.close();
      </script>
    </div>
<div id="header">
<h1>Installing Foreman 3.7 Server on Debian/Ubuntu</h1>
<div class="details">
<span id="revnumber">version 3.7 (unsupported),</span>
<span id="revdate">published Jun 27 2023</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Preparing_your_Environment_for_Installation_foreman">1. Preparing your Environment for Installation</a>
<ul class="sectlevel2">
<li><a href="#system-requirements_foreman">1.1. System Requirements</a></li>
<li><a href="#storage-requirements_foreman">1.2. Storage Requirements</a></li>
<li><a href="#supported-operating-systems_foreman">1.3. Supported Operating Systems</a></li>
<li><a href="#supported-browsers_foreman">1.4. Supported Browsers</a></li>
<li><a href="#Ports_and_Firewalls_Requirements_foreman">1.5. Ports and Firewalls Requirements</a></li>
<li><a href="#Enabling_Connections_from_a_Client_to_Server_foreman">1.6. Enabling Connections from a Client to Foreman&#160;server</a></li>
<li><a href="#verifying-firewall-settings_foreman">1.7. Verifying Firewall Settings</a></li>
<li><a href="#verifying-dns-resolution_foreman">1.8. Verifying DNS resolution</a></li>
</ul>
</li>
<li><a href="#preparing-environment-for-installation-in-ipv6-network_foreman">2. Preparing your Environment for Foreman Installation in an IPv6 Network</a>
<ul class="sectlevel2">
<li><a href="#limitations-of-installation-in-an-ipv6-network_foreman">2.1. Limitations of Foreman Installation in an IPv6 Network</a></li>
<li><a href="#requirements-for-installation-in-an-ipv6-network_foreman">2.2. Requirements for Foreman Installation in an IPv6 Network</a></li>
</ul>
</li>
<li><a href="#Installing_Server_Connected_foreman">3. Installing Foreman&#160;server</a>
<ul class="sectlevel2">
<li><a href="#configuring-repositories_foreman">3.1. Configuring Repositories</a></li>
<li><a href="#Installing_Server_Packages_foreman">3.2. Installing Foreman&#160;server Packages</a></li>
<li><a href="#configuring-server_foreman">3.3. Configuring Foreman&#160;server</a></li>
</ul>
</li>
<li><a href="#performing-additional-configuration">4. Performing Additional Configuration on Foreman&#160;server</a>
<ul class="sectlevel2">
<li><a href="#configuring-foreman-server-to-consume-content-from-a-custom-cdn_foreman">4.1. Configuring Foreman&#160;Server to Consume Content from a Custom CDN</a></li>
<li><a href="#configuring-for-uefi-http-boot-provisioning-in-an-ipv6-network_foreman">4.2. Configuring Foreman for UEFI HTTP Boot Provisioning in an IPv6 Network</a></li>
<li><a href="#Configuring_Server_with_an_HTTP_Proxy_foreman">4.3. Configuring Foreman&#160;server with an HTTP Proxy</a></li>
<li><a href="#enabling-power-management-on-managed-hosts_foreman">4.4. Enabling Power Management on Managed Hosts</a></li>
<li><a href="#configuring-dns-dhcp-and-tftp_foreman">4.5. Configuring DNS, DHCP, and TFTP on Foreman&#160;server</a></li>
<li><a href="#disabling-dns-dhcp-tftp-for-unmanaged-networks_foreman">4.6. Disabling DNS, DHCP, and TFTP for Unmanaged Networks</a></li>
<li><a href="#Configuring_Server_for_Outgoing_Emails_foreman">4.7. Configuring Foreman&#160;server for Outgoing Emails</a></li>
<li><a href="#tuning-with-predefined-profiles_foreman">4.8. Tuning Foreman&#160;server with Predefined Profiles</a></li>
</ul>
</li>
<li><a href="#Configuring_External_Authentication_foreman">5. Configuring External Authentication</a>
<ul class="sectlevel2">
<li><a href="#Using_LDAP_foreman">5.1. Using LDAP</a></li>
<li><a href="#Using_FreeIPA_foreman">5.2. Using FreeIPA</a></li>
<li><a href="#Using_Active_Directory_foreman">5.3. Using Active Directory</a></li>
<li><a href="#Configuring_External_User_Groups_foreman">5.4. Configuring External User Groups</a></li>
<li><a href="#Refreshing_External_User_Groups_for_LDAP_foreman">5.5. Refreshing External User Groups for LDAP</a></li>
<li><a href="#Refreshing_External_User_Groups_for_FreeIPA_or_AD_foreman">5.6. Refreshing External User Groups for FreeIPA or AD</a></li>
<li><a href="#Configuring_the_Hammer_CLI_to_Use_FreeIPA_User_Authentication_foreman">5.7. Configuring the Hammer CLI to Use FreeIPA User Authentication</a></li>
<li><a href="#External_Authentication_for_Provisioned_Hosts_foreman">5.8. External Authentication for Provisioned Hosts</a></li>
<li><a href="#Configuring_Project_with_Keycloak_Authentication_keycloak-general">5.9. Configuring Foreman with Keycloak Authentication</a></li>
<li><a href="#Configuring_Keycloak_Authentication_with_TOTP_keycloak-totp">5.10. Configuring Keycloak Authentication with TOTP</a></li>
<li><a href="#Configuring_Keycloak_Authentication_with_CAC_Cards_keycloak-cac-cards">5.11. Configuring Keycloak Authentication with PIV Cards</a></li>
<li><a href="#Disabling_Keycloak_Authentication_foreman">5.12. Disabling Keycloak Authentication</a></li>
</ul>
</li>
<li><a href="#configuring-external-services">6. Configuring Foreman&#160;server with External Services</a>
<ul class="sectlevel2">
<li><a href="#configuring-external-dns_foreman">6.1. Configuring Foreman&#160;server with External DNS</a></li>
<li><a href="#configuring-external-dhcp_foreman">6.2. Configuring Foreman&#160;server with External DHCP</a></li>
<li><a href="#configuring-external-tftp_foreman">6.3. Configuring Foreman&#160;server with External TFTP</a></li>
<li><a href="#configuring-external-idm-dns_foreman">6.4. Configuring Foreman&#160;server with External IdM DNS</a></li>
</ul>
</li>
<li><a href="#applying-custom-configuration_foreman">Appendix A: Applying Custom Configuration to Foreman</a></li>
<li><a href="#restoring-manual-changes-overwritten-by-a-puppet-run_foreman">Appendix B: Restoring Manual Changes Overwritten by a Puppet Run</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Preparing_your_Environment_for_Installation_foreman"><a class="anchor" href="#Preparing_your_Environment_for_Installation_foreman"></a>1. Preparing your Environment for Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before you install Foreman, ensure that your environment meets the following requirements.</p>
</div>
<div class="sect2">
<h3 id="system-requirements_foreman"><a class="anchor" href="#system-requirements_foreman"></a>1.1. System Requirements</h3>
<div class="paragraph">
<p>The following requirements apply to the networked base operating system:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>x86_64 architecture</p>
</li>
<li>
<p>4-core 2.0 GHz CPU at a minimum</p>
</li>
<li>
<p>A minimum of 4 GB RAM is required for Foreman&#160;server to function.
Foreman running with less RAM than the minimum value might not operate correctly.</p>
</li>
<li>
<p>Administrative user (root) access</p>
</li>
<li>
<p>Full forward and reverse DNS resolution using a fully-qualified domain name</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Foreman only supports <code>UTF-8</code> encoding.
If your territory is USA and your language is English, set <code>en_US.utf-8</code> as the system-wide locale settings.
For more information about configuring system locale in Enterprise Linux, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_basic_system_settings/assembly_changing-basic-environment-settings_configuring-basic-system-settings#proc_configuring-the-system-locale_assembly_changing-basic-environment-settings">Configuring System Locale guide</a>.</p>
</div>
<div class="paragraph">
<p>Foreman&#160;server and Smart&#160;Proxy&#160;server do not support shortnames in the hostnames.
When using custom certificates, the Common Name (CN) of the custom certificate must be a fully qualified domain name (FQDN) instead of a shortname.
This does not apply to the clients of a Foreman.</p>
</div>
<div class="paragraph">
<p>Before you install Foreman&#160;server, ensure that your environment meets the requirements for installation.</p>
</div>
<div class="paragraph">
<p>Foreman&#160;server must be installed on a freshly provisioned system that serves no other function except to run Foreman&#160;server.
The freshly provisioned system must not have the following users provided by external identity providers to avoid conflicts with the local users that Foreman&#160;server creates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>www-data</p>
</li>
<li>
<p>foreman</p>
</li>
<li>
<p>foreman-proxy</p>
</li>
<li>
<p>postgres</p>
</li>
<li>
<p>puppet</p>
</li>
<li>
<p>redis</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="storage-requirements_foreman"><a class="anchor" href="#storage-requirements_foreman"></a>1.2. Storage Requirements</h3>
<div class="paragraph">
<p>The following table details storage requirements for specific directories.
These values are based on expected use case scenarios and can vary according to individual environments.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Storage Requirements for a Foreman&#160;server Installation</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Directory</th>
<th class="tableblock halign-left valign-top">Installation Size</th>
<th class="tableblock halign-left valign-top">Runtime Size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/var/log</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/var/lib/postgresql</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20 GB</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/usr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 GB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not Applicable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/opt/puppetlabs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500 MB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not Applicable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="supported-operating-systems_foreman"><a class="anchor" href="#supported-operating-systems_foreman"></a>1.3. Supported Operating Systems</h3>
<div class="paragraph">
<p>You can install the operating system from a disc, local ISO image, or kickstart.</p>
</div>
<div class="paragraph">
<p>The following operating systems are supported by the installer, have packages, and are tested for deploying Foreman:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Operating Systems supported by foreman-installer</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operating System</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Architecture</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Notes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debian 11 (Bullseye)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amd64</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ubuntu 20.04 (Focal)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amd64</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Before you install Foreman, apply all operating system updates if possible.</p>
</div>
<div class="paragraph">
<p>Install Foreman&#160;server on a freshly provisioned system.</p>
</div>
</div>
<div class="sect2">
<h3 id="supported-browsers_foreman"><a class="anchor" href="#supported-browsers_foreman"></a>1.4. Supported Browsers</h3>
<div class="paragraph">
<p>Using the most recent version of a major browser is highly recommended, as Foreman and the frameworks it uses offer limited support for older versions.</p>
</div>
<div class="paragraph">
<p>The recommended requirements are as follows for major browsers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Google Chrome &#8211; latest version</p>
</li>
<li>
<p>Microsoft Edge &#8211; latest version</p>
</li>
<li>
<p>Apple Safari &#8211; latest version</p>
</li>
<li>
<p>Mozilla Firefox &#8211; latest version</p>
</li>
<li>
<p>Mozilla Firefox Extended Support Release (ESR) &#8211; latest version</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other browsers may work unpredictably.</p>
</div>
<div class="paragraph">
<p>The Foreman web UI and command-line interface support English, Portuguese, Simplified Chinese Traditional Chinese, Korean, Japanese, Italian, Spanish, Russian, French, and German.</p>
</div>
</div>
<div class="sect2">
<h3 id="Ports_and_Firewalls_Requirements_foreman"><a class="anchor" href="#Ports_and_Firewalls_Requirements_foreman"></a>1.5. Ports and Firewalls Requirements</h3>
<div class="paragraph">
<p>For the components of Foreman architecture to communicate, ensure that the required network ports are open and free on the base operating system.
You must also ensure that the required network ports are open on any network-based firewalls.</p>
</div>
<div class="paragraph">
<p>Use this information to configure any network-based firewalls.
Note that some cloud solutions must be specifically configured to allow communications between machines because they isolate machines similarly to network-based firewalls.
If you use an application-based firewall, ensure that the application-based firewall permits all applications that are listed in the tables and known to your firewall.
If possible, disable the application checking and allow open port communication based on the protocol.</p>
</div>
<div class="paragraph">
<div class="title">Integrated Smart&#160;Proxy</div>
<p>Foreman&#160;server has an integrated Smart&#160;Proxy and any host that is directly connected to Foreman&#160;server is a Client of Foreman in the context of this section.
This includes the base operating system on which Smart&#160;Proxy&#160;server is running.</p>
</div>
<div class="paragraph">
<div class="title">Clients of Smart&#160;Proxy</div>
<p>Hosts which are clients of Smart&#160;Proxies, other than Foreman&#8217;s integrated Smart&#160;Proxy, do not need access to Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>Required ports can change based on your configuration.</p>
</div>
<div class="paragraph">
<p>The following tables indicate the destination port and the direction of network traffic:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Foreman&#160;server incoming traffic</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination Port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required For</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP and UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS Servers and clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name resolution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">67</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic IP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">69</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TFTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TFTP Server (optional)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart&#160;Proxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreman API</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Communication from Smart&#160;Proxy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5910&#8202;&#8211;&#8202;5930</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Browsers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compute Resource&#8217;s virtual console</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provisioning templates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Template retrieval for client installers, iPXE or UEFI HTTP Boot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PXE Boot</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Installation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8140</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Puppet agent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client updates (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenSCAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure Client</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreman</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart&#160;Proxy API</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart Proxy functionality</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Any managed host that is directly connected to Foreman&#160;server is a client in this context because it is a client of the integrated Smart&#160;Proxy.
This includes the base operating system on which a Smart&#160;Proxy&#160;server is running.</p>
</div>
<div class="paragraph">
<p>A DHCP Smart&#160;Proxy performs ICMP ping or TCP echo connection attempts to hosts in subnets with DHCP IPAM set to find out if an IP address considered for use is free.
This behavior can be turned off using <code>foreman-installer --foreman-proxy-dhcp-ping-free-ip=false</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Foreman&#160;server outgoing traffic</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Destination Port</th>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Service</th>
<th class="tableblock halign-left valign-top">Destination</th>
<th class="tableblock halign-left valign-top">Required For</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ICMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Free IP checking (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">echo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Free IP checking (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Target host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remote execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run jobs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">22, 16514</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSH SSH/TLS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compute Resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreman originated communications, for compute resources in libvirt</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP and UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS Servers on the Internet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolve DNS records (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP and UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart&#160;Proxy DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation of DNS conflicts (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">53</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP and UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Orchestration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation of DNS conflicts</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">68</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic IP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remote repository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content Sync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remote yum repository</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">389, 636</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LDAP, LDAPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">External LDAP Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LDAP authentication, necessary only if external authentication is enabled.
The port can be customized when <code>LDAPAuthSource</code> is defined</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreman</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart&#160;Proxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart&#160;Proxy</p>
<p class="tableblock">Configuration management</p>
<p class="tableblock">Template retrieval</p>
<p class="tableblock">OpenSCAP</p>
<p class="tableblock">Remote Execution result upload</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Amazon EC2, Azure, Google GCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compute resources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual machine interactions (query/create/destroy) (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infoblox DHCP Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When using Infoblox for DHCP, management of the DHCP leases (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">623</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Power management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BMC On/Off/Cycle/Status</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenStack Compute Resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compute resources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual machine interactions (query/create/destroy) (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5900&#8202;&#8211;&#8202;5930</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSL/TLS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hypervisor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">noVNC console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Launch noVNC console</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7911</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP, OMAPI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DHCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The DHCP target is configured using <code>--foreman-proxy-dhcp-server</code> and defaults to localhost</p>
<p class="tableblock">ISC and <code>remote_isc</code> use a configurable port that defaults to 7911 and uses OMAPI</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Discovery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart&#160;Proxy sends reboot command to the discovered host (optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart&#160;Proxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Smart&#160;Proxy API</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Management of Smart&#160;Proxies</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="Enabling_Connections_from_a_Client_to_Server_foreman"><a class="anchor" href="#Enabling_Connections_from_a_Client_to_Server_foreman"></a>1.6. Enabling Connections from a Client to Foreman&#160;server</h3>
<div class="paragraph">
<p>Smart&#160;Proxies and Content Hosts that are clients of a Foreman&#160;server&#8217;s internal Smart&#160;Proxy require access through Foreman&#8217;s host-based firewall and any network-based firewalls.</p>
</div>
<div class="paragraph">
<p>Use this procedure to configure the host-based firewall on the system that Foreman is installed on, to enable incoming connections from Clients, and to make the configuration persistent across system reboots.
For more information on the ports used, see <a href="https://docs.theforeman.org/3.7/Installing_Server/index-foreman-deb.html#satellite-ports-and-firewalls-requirements_foreman">Ports and Firewalls Requirements</a>.</p>
</div>
<div class="paragraph">
<p>If you do not use <code>firewall-cmd</code> to configure the Linux firewall, implement using the command of your choice.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To open the ports for client to Foreman communication, enter the following command on the base operating system that you want to install Foreman on:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># firewall-cmd \
--add-port="53/udp" --add-port="53/tcp" \
--add-port="67/udp" \
--add-port="69/udp" \
--add-port="80/tcp" --add-port="443/tcp" \
--add-port="8443/tcp" \
--add-port="8140/tcp"</pre>
</div>
</div>
</li>
<li>
<p>Make the changes persistent:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># firewall-cmd --runtime-to-permanent</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="verifying-firewall-settings_foreman"><a class="anchor" href="#verifying-firewall-settings_foreman"></a>1.7. Verifying Firewall Settings</h3>
<div class="paragraph">
<p>Use this procedure to verify your changes to the firewall settings.</p>
</div>
<div class="paragraph">
<p>If you do not use <code>firewall-cmd</code> to configure the Linux firewall, implement using the command of your choice.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># firewall-cmd --list-all</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="verifying-dns-resolution_foreman"><a class="anchor" href="#verifying-dns-resolution_foreman"></a>1.8. Verifying DNS resolution</h3>
<div class="paragraph">
<p>Verify the full forward and reverse DNS resolution using a fully-qualified domain name to prevent issues while installing Foreman.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure that the host name and local host resolve correctly:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ping -c1 localhost
# ping -c1 `hostname -f` # my_system.domain.com</pre>
</div>
</div>
<div class="paragraph">
<p>Successful name resolution results in output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ping -c1 localhost
PING localhost (127.0.0.1) 56(84) bytes of data.
64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.043 ms

--- localhost ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.043/0.043/0.043/0.000 ms

# ping -c1 `hostname -f`
PING hostname.gateway (XX.XX.XX.XX) 56(84) bytes of data.
64 bytes from hostname.gateway (XX.XX.XX.XX): icmp_seq=1 ttl=64 time=0.019 ms

--- localhost.gateway ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.019/0.019/0.019/0.000 ms</pre>
</div>
</div>
</li>
<li>
<p>To avoid discrepancies with static and transient host names, set all the host names on the system by entering the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hostnamectl set-hostname <em>name</em></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Name resolution is critical to the operation of Foreman.
If Foreman cannot
properly resolve its fully qualified domain name, many options fail, such as provisioning.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preparing-environment-for-installation-in-ipv6-network_foreman"><a class="anchor" href="#preparing-environment-for-installation-in-ipv6-network_foreman"></a>2. Preparing your Environment for Foreman Installation in an IPv6 Network</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can install and use Foreman in an IPv6 network.
Before installing Foreman in an IPv6 network, view the limitations and ensure that you meet the requirements.</p>
</div>
<div class="paragraph">
<p>To provision hosts in an IPv6 network, after installing Foreman, you must also configure Foreman for the UEFI HTTP boot provisioning.
For more information, see <a href="#configuring-for-uefi-http-boot-provisioning-in-an-ipv6-network_foreman">Configuring Foreman for UEFI HTTP Boot Provisioning in an IPv6 Network</a>.</p>
</div>
<div class="sect2">
<h3 id="limitations-of-installation-in-an-ipv6-network_foreman"><a class="anchor" href="#limitations-of-installation-in-an-ipv6-network_foreman"></a>2.1. Limitations of Foreman Installation in an IPv6 Network</h3>
<div class="paragraph">
<p>Foreman installation in an IPv6 network has the following limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can install Foreman and Smart&#160;Proxies in IPv6-only systems, dual-stack installation is not supported.</p>
</li>
<li>
<p>Although Foreman provisioning templates include IPv6 support for PXE and HTTP (iPXE) provisioning, the only tested and certified provisioning workflow is the UEFI HTTP Boot provisioning.
This limitation only relates to users who plan to use Foreman to provision hosts.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="requirements-for-installation-in-an-ipv6-network_foreman"><a class="anchor" href="#requirements-for-installation-in-an-ipv6-network_foreman"></a>2.2. Requirements for Foreman Installation in an IPv6 Network</h3>
<div class="paragraph">
<p>Before installing Foreman in an IPv6 network, ensure that you meet the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You must deploy an external DHCP IPv6 server as a separate unmanaged service to bootstrap clients into GRUB2, which then configures IPv6 networking either using DHCPv6 or or assigning static IPv6 address.
This is required because the DHCP server in Red&#160;Hat Enterprise Linux (ISC DHCP) does not provide an integration API for managing IPv6 records, therefore the Smart&#160;Proxy DHCP plug-in that provides DHCP management is limited to IPv4 subnets.</p>
<div class="paragraph">
<p>Note that this requirement is for Katello users only.</p>
</div>
</li>
<li>
<p>You must configure Foreman to use this IPv4 HTTP proxy server as the default proxy.
For more information, see <a href="https://docs.theforeman.org/3.7/Installing_Server/index-foreman-deb.html#adding-a-default-http-proxy_foreman">Adding a Default HTTP Proxy to Foreman</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Installing_Server_Connected_foreman"><a class="anchor" href="#Installing_Server_Connected_foreman"></a>3. Installing Foreman&#160;server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the following procedures to install Foreman&#160;server and perform the initial configuration.</p>
</div>
<div class="paragraph">
<p>Note that the Foreman installation script is based on Puppet, which means that if you run the installation script more than once, it might overwrite any manual configuration changes.
⁠
To avoid this and determine which future changes apply, use the <code>--noop</code> argument when you run the installation script.
This argument ensures that no actual changes are made.
Potential changes are written to <code>/var/log/foreman-installer/foreman.log</code>.</p>
</div>
<div class="paragraph">
<p>Files are always backed up and so you can revert any unwanted changes.
For example, in the foreman-installer logs, you can see an entry similar to the following about Filebucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/Stage[main]/Dhcp/File[/etc/dhcp/dhcpd.conf]: Filebucketed /etc/dhcp/dhcpd.conf to puppet with sum 622d9820b8e764ab124367c68f5fa3a1</pre>
</div>
</div>
<div class="paragraph">
<p>You can restore the previous file as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># puppet filebucket -l \
restore /etc/dhcp/dhcpd.conf 622d9820b8e764ab124367c68f5fa3a1</pre>
</div>
</div>
<div class="sect2">
<h3 id="configuring-repositories_foreman"><a class="anchor" href="#configuring-repositories_foreman"></a>3.1. Configuring Repositories</h3>
<div class="paragraph">
<p>Use this procedure to enable the repositories that are required to install Foreman&#160;server. Choose from the available list which operating system and version you are installing on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#repositories-debian-11">Debian 11 (Bullseye)</a></p>
</li>
<li>
<p><a href="#repositories-ubuntu-2004">Ubuntu 20.04 (Focal)</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_debian_11_bullseye"><a class="anchor" href="#_debian_11_bullseye"></a>3.1.1. <a id="repositories-debian-11"></a>Debian 11 (Bullseye)</h4>
<div id="configuring-repositories-deb-bullseye" class="olist arabic">
<ol class="arabic">
<li>
<p>Install the <code>wget</code> and <code>ca-certificates</code> packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install wget ca-certificates</pre>
</div>
</div>
</li>
<li>
<p>Change directory to <code>/tmp</code> and retrieve the <code>puppet7-release-bullseye.deb</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cd /tmp &amp;&amp; wget https://apt.puppet.com/puppet7-release-bullseye.deb</pre>
</div>
</div>
</li>
<li>
<p>Install the <code>puppet7-release-bullseye.deb</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install /tmp/puppet7-release-bullseye.deb</pre>
</div>
</div>
</li>
<li>
<p>Enable the Foreman repository:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># wget https://deb.theforeman.org/foreman.asc -O /etc/apt/trusted.gpg.d/foreman.asc
# echo "deb http://deb.theforeman.org/ bullseye 3.7" | sudo tee /etc/apt/sources.list.d/foreman.list
# echo "deb http://deb.theforeman.org/ plugins 3.7" | sudo tee -a /etc/apt/sources.list.d/foreman.list</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_ubuntu_20_04_focal"><a class="anchor" href="#_ubuntu_20_04_focal"></a>3.1.2. <a id="repositories-ubuntu-2004"></a>Ubuntu 20.04 (Focal)</h4>
<div id="configuring-repositories-deb-focal" class="olist arabic">
<ol class="arabic">
<li>
<p>Install the <code>wget</code> and <code>ca-certificates</code> packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install wget ca-certificates</pre>
</div>
</div>
</li>
<li>
<p>Change directory to <code>/tmp</code> and retrieve the <code>puppet7-release-focal.deb</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cd /tmp &amp;&amp; wget https://apt.puppet.com/puppet7-release-focal.deb</pre>
</div>
</div>
</li>
<li>
<p>Install the <code>puppet7-release-focal.deb</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install /tmp/puppet7-release-focal.deb</pre>
</div>
</div>
</li>
<li>
<p>Enable the Foreman repository:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># wget https://deb.theforeman.org/foreman.asc -O /etc/apt/trusted.gpg.d/foreman.asc
# echo "deb http://deb.theforeman.org/ focal 3.7" | sudo tee /etc/apt/sources.list.d/foreman.list
# echo "deb http://deb.theforeman.org/ plugins 3.7" | sudo tee -a /etc/apt/sources.list.d/foreman.list</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Installing_Server_Packages_foreman"><a class="anchor" href="#Installing_Server_Packages_foreman"></a>3.2. Installing Foreman&#160;server Packages</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update package lists:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get update</pre>
</div>
</div>
</li>
<li>
<p>Update all packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get upgrade</pre>
</div>
</div>
</li>
<li>
<p>Install <code>foreman-installer</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install foreman-installer</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-server_foreman"><a class="anchor" href="#configuring-server_foreman"></a>3.3. Configuring Foreman&#160;server</h3>
<div class="paragraph">
<p>Install Foreman&#160;server using the <code>foreman-installer</code> installation script.</p>
</div>
<div class="paragraph">
<p>This method is performed by running the installation script with one or more command options.
The command options override the corresponding default initial configuration options and are recorded in the Foreman answer file.
You can run the script as often as needed to configure any necessary options.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Depending on the options that you use when running the Foreman installer, the configuration can take several minutes to complete.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="Configuring_Installation_foreman"><a class="anchor" href="#Configuring_Installation_foreman"></a>3.3.1. Configuring Foreman Installation</h4>
<div class="paragraph">
<p>This initial configuration procedure creates an organization, location, user name, and password.
After the initial configuration, you can create additional organizations and locations if required.
The initial configuration also installs PostgreSQL databases on the same server.</p>
</div>
<div class="paragraph">
<p>The installation process can take tens of minutes to complete.
If you are connecting remotely to the system, use a utility such as <code>tmux</code> that allows suspending and reattaching a communication session so that you can check the installation progress in case you become disconnected from the remote system.
If you lose connection to the shell where the installation command is running, see the log at <code>/var/log/foreman-installer/foreman.log</code> to determine if the process completed successfully.</p>
</div>
<div class="ulist">
<div class="title">Considerations</div>
<ul>
<li>
<p>Use the <code>foreman-installer --help</code> command to display the available options and any default values.
If you do not specify any values, the default values are used.</p>
</li>
<li>
<p>Specify a meaningful value for the option: <code>--foreman-initial-organization</code>.
This can be your company name.
An internal label that matches the value is also created and cannot be changed afterwards.
If you do not specify a value, an organization called <strong>Default Organization</strong> with the label <strong>Default_Organization</strong> is created.
You can rename the organization name but not the label.</p>
</li>
<li>
<p>By default, all configuration files configured by the installer are managed by Puppet.
When <code>foreman-installer</code> runs, it overwrites any manual changes to the Puppet managed files with the initial values.
By default, Foreman&#160;server is installed with the Puppet agent running as a service.
If required, you can disable Puppet agent on Foreman&#160;server using the <code>--puppet-runmode=none</code> option.</p>
</li>
<li>
<p>If you want to manage DNS files and DHCP files manually, use the <code>--foreman-proxy-dns-managed=false</code> and <code>--foreman-proxy-dhcp-managed=false</code> options so that Puppet does not manage the files related to the respective services.
For more information on how to apply custom configuration on other services, see <a href="https://docs.theforeman.org/3.7/Installing_Server/index-foreman-deb.html#applying-custom-configuration_foreman">Applying Custom Configuration to Foreman</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enter the following command with any additional options that you want to use:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer \
--foreman-initial-organization "<em>My_Organization</em>" \
--foreman-initial-location "<em>My_Location</em>" \
--foreman-initial-admin-username <em>admin_user_name</em> \
--foreman-initial-admin-password <em>admin_password</em></pre>
</div>
</div>
<div class="paragraph">
<p>The script displays its progress and writes logs to <code>/var/log/foreman-installer/foreman.log</code>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="performing-additional-configuration"><a class="anchor" href="#performing-additional-configuration"></a>4. Performing Additional Configuration on Foreman&#160;server</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuring-foreman-server-to-consume-content-from-a-custom-cdn_foreman"><a class="anchor" href="#configuring-foreman-server-to-consume-content-from-a-custom-cdn_foreman"></a>4.1. Configuring Foreman&#160;Server to Consume Content from a Custom CDN</h3>
<div class="paragraph">
<p>If you have an internal Content Delivery Network (CDN) or serve content on an accessible web server, you can configure your Foreman&#160;server to consume Red&#160;Hat repositories from this CDN server instead of the Red&#160;Hat CDN.
A CDN server can be any web server that mirrors repositories in the same directory structure as the Red&#160;Hat CDN.</p>
</div>
<div class="paragraph">
<p>You can configure the source of content for each organization.
Foreman recognizes automatically which Red&#160;Hat repositories from the subscription manifest in your organization are available on your CDN server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have a CDN server that provides Red&#160;Hat content and is accessible by Foreman&#160;server.</p>
</li>
<li>
<p>If your CDN server uses HTTPS, ensure you have uploaded the SSL certificate into Foreman.
For more information, see <a href="https://docs.theforeman.org/3.7/Managing_Content/index-foreman-deb.html#Importing_Custom_SSL_Certificates_content-management">Importing Custom SSL Certificates</a> in <em>Managing Content</em>.</p>
</li>
<li>
<p>You have uploaded a manifest to your organization.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Content</strong> &gt; <strong>Subscriptions</strong>.</p>
</li>
<li>
<p>Click the <strong>Manage Manifest</strong> button.</p>
</li>
<li>
<p>Select the <strong>CDN Configuration</strong> tab.</p>
</li>
<li>
<p>Select the <strong>Custom CDN</strong> tab.</p>
</li>
<li>
<p>In the <strong>URL</strong> field, enter the URL of your CDN server from which you want Foreman&#160;server to consume Red&#160;Hat repositories.</p>
</li>
<li>
<p>Optional: In the <strong>SSL CA Content Credential</strong>, select the SSL certificate of the CDN server.</p>
</li>
<li>
<p>Click <strong>Update</strong>.</p>
</li>
<li>
<p>You can now enable Red&#160;Hat repositories consumed from your internal CDN server.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">CLI Procedure</div>
<ol class="arabic">
<li>
<p>Connect to your Foreman&#160;server using SSH.</p>
</li>
<li>
<p>Set CDN configuration to your custom CDN server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer organization configure-cdn --name="<em>My_Organization</em>" \
--type=custom_cdn \
--url https://<em>my-cdn.example.com</em> \
--ssl-ca-credential-id "<em>My_CDN_CA_Cert_ID</em>"</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://docs.theforeman.org/3.7/Planning_for_Project/index-foreman-deb.html#chap-Architecture_Guide-Content_Delivery_Network_Structure">Content Delivery Network Structure</a> in <em>Planning for Foreman</em></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configuring-for-uefi-http-boot-provisioning-in-an-ipv6-network_foreman"><a class="anchor" href="#configuring-for-uefi-http-boot-provisioning-in-an-ipv6-network_foreman"></a>4.2. Configuring Foreman for UEFI HTTP Boot Provisioning in an IPv6 Network</h3>
<div class="paragraph">
<p>Use this procedure to configure Foreman to provision hosts in an IPv6 network with UEFI HTTP Boot provisioning.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Ensure that your clients can access DHCP and HTTP servers.</p>
</li>
<li>
<p>Ensure that the UDP ports 67 and 68 are accessible by clients so clients can send DHCP requests and receive DHCP offers.</p>
</li>
<li>
<p>Ensure that the TCP port 8000 is open for clients to download files and Kickstart templates from Foreman and Smart&#160;Proxies.</p>
</li>
<li>
<p>Ensure that the host provisioning interface subnet has an HTTP Boot Smart&#160;Proxy, and Templates Smart&#160;Proxy set.
For more information, see <a href="https://docs.theforeman.org/3.7/Provisioning_Hosts/index-foreman-deb.html#Adding_a_Subnet_to_Server_provisioning">Adding a Subnet to Foreman&#160;server</a> in <em>Provisioning Hosts</em>.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong> &gt; <strong>Provisioning</strong> and ensure that the <strong>Token duration</strong> setting is not set to <strong>0</strong>.
Foreman cannot identify clients that are booting from the network by a remote IPv6 address because of unmanaged DHCPv6 service, therefore provisioning tokens must be enabled.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>You must disable DHCP management in the installer or not use it.</p>
</li>
<li>
<p>For all IPv6 subnets created in Foreman, set the <strong>DHCP Smart&#160;Proxy</strong> to blank.</p>
</li>
<li>
<p>Optional: If the host and the DHCP server are separated by a router, configure the DHCP relay agent and point to the DHCP server.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Server_with_an_HTTP_Proxy_foreman"><a class="anchor" href="#Configuring_Server_with_an_HTTP_Proxy_foreman"></a>4.3. Configuring Foreman&#160;server with an HTTP Proxy</h3>
<div class="paragraph">
<p>Use the following procedures to configure Foreman with an HTTP proxy.</p>
</div>
<div class="sect3">
<h4 id="adding-a-default-http-proxy_foreman"><a class="anchor" href="#adding-a-default-http-proxy_foreman"></a>4.3.1. Adding a Default HTTP Proxy to Foreman</h4>
<div class="paragraph">
<p>If your network uses an HTTP Proxy, you can configure Foreman&#160;server to use an HTTP proxy for requests to the Red&#160;Hat Content Delivery Network (CDN) or another content source.
Use the FQDN instead of the IP address where possible to avoid losing connectivity because of network changes.</p>
</div>
<div class="paragraph">
<p>The following procedure configures a proxy only for downloading content for Foreman.
To use the CLI instead of the Foreman web UI, see the <a href="#cli-adding-a-default-http-proxy_foreman">CLI procedure</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>HTTP Proxies</strong>.</p>
</li>
<li>
<p>Click <strong>New HTTP Proxy</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter the name for the HTTP proxy.</p>
</li>
<li>
<p>In the <strong>Url</strong> field, enter the URL of the HTTP proxy in the following format: <code>https://proxy.example.com:8080</code>.</p>
</li>
<li>
<p>Optional: If authentication is required, in the <strong>Username</strong> field, enter the username to authenticate with.</p>
</li>
<li>
<p>Optional: If authentication is required, in the <strong>Password</strong> field, enter the password to authenticate with.</p>
</li>
<li>
<p>To test connection to the proxy, click the <strong>Test Connection</strong> button.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>, and click the <strong>Content</strong> tab.</p>
</li>
<li>
<p>Set the <strong>Default HTTP Proxy</strong> setting to the created HTTP proxy.</p>
</li>
</ol>
</div>
<div id="cli-adding-a-default-http-proxy_foreman" class="olist arabic">
<div class="title">CLI procedure</div>
<ol class="arabic">
<li>
<p>Verify that the <code>http_proxy</code>, <code>https_proxy</code>, and <code>no_proxy</code> variables are not set.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># unset http_proxy
# unset https_proxy
# unset no_proxy</pre>
</div>
</div>
</li>
<li>
<p>Add an HTTP proxy entry to Foreman:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer http-proxy create --name=<em>myproxy</em> \
--url http://<em>myproxy.example.com</em>:8080  \
--username=<em>proxy_username</em> \
--password=<em>proxy_password</em></pre>
</div>
</div>
</li>
<li>
<p>Configure Foreman to use this HTTP proxy by default:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name=content_default_http_proxy --value=<em>myproxy</em></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="using-an-http-proxy-for-all-http-requests_foreman"><a class="anchor" href="#using-an-http-proxy-for-all-http-requests_foreman"></a>4.3.2. Using an HTTP Proxy for all Foreman HTTP Requests</h4>
<div class="paragraph">
<p>If your Foreman&#160;server must remain behind a firewall that blocks HTTP and HTTPS, you can configure a proxy for communication with external systems, including compute resources.</p>
</div>
<div class="paragraph">
<p>Note that if you are using compute resources for provisioning, and you want to use a different HTTP proxy with the compute resources, the proxy that you set for all Foreman communication takes precedence over the proxies that you set for compute resources.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>.</p>
</li>
<li>
<p>In the <strong>HTTP(S) proxy</strong> row, select the adjacent <strong>Value</strong> column and enter the proxy URL.</p>
</li>
<li>
<p>Click the tick icon to save your changes.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name=http_proxy --value=<em>Proxy_URL</em></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="excluding-hosts-from-receiving-proxied-requests_foreman"><a class="anchor" href="#excluding-hosts-from-receiving-proxied-requests_foreman"></a>4.3.3. Excluding Hosts from Receiving Proxied Requests</h4>
<div class="paragraph">
<p>If you use an HTTP Proxy for all Foreman HTTP or HTTPS requests, you can prevent certain hosts from communicating through the proxy.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>.</p>
</li>
<li>
<p>In the <strong>HTTP(S) proxy except hosts</strong> row, select the adjacent <strong>Value</strong> column and enter the names of one or more hosts that you want to exclude from proxy requests.</p>
</li>
<li>
<p>Click the tick icon to save your changes.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name=http_proxy_except_list --value=[<em>hostname1.hostname2...</em>]</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="configuring-proxy-for-pxe-files_foreman"><a class="anchor" href="#configuring-proxy-for-pxe-files_foreman"></a>4.3.4. Configuring a proxy for PXE files downloads</h4>
<div class="paragraph">
<p>For Red Hat content served through the Content Delivery Network, Smart&#160;Proxy downloads PXE files from synchronized repositories.
However, when configuring and installing an operating system using Installation Media, Smart&#160;Proxy connects directly using the <code>wget</code> utility.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Smart&#160;Proxy with the TFTP feature, to verify the ports that are permitted by SELinux for the HTTP cache, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl edit foreman-proxy</pre>
</div>
</div>
</li>
<li>
<p>Insert the following test into the editor:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[Service]
Environment="http_proxy=http://proxy.example.com:8888"
Environment="https_proxy=https://proxy.example.com:8888"</pre>
</div>
</div>
</li>
<li>
<p>Save the file.
Verify that the file appears as <code>/etc/systemd/system/foreman-proxy.service.d/overrides.conf</code>.</p>
</li>
<li>
<p>Restart the <code>foreman-proxy</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart foreman-proxy</pre>
</div>
</div>
</li>
<li>
<p>Create a host or enter build mode for an existing host to re-download PXE files to the TFTP Smart&#160;Proxy.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="resetting-the-http-proxy_foreman"><a class="anchor" href="#resetting-the-http-proxy_foreman"></a>4.3.5. Resetting the HTTP Proxy</h4>
<div class="paragraph">
<p>If you want to reset the current HTTP proxy setting, unset the <strong>Default HTTP Proxy</strong> setting.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>, and click the <strong>Content</strong> tab.</p>
</li>
<li>
<p>Set the <strong>Default HTTP Proxy</strong> setting to <strong>no global default</strong>.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Set the <code>content_default_http_proxy</code> setting to an empty string:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name=content_default_http_proxy --value=""</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enabling-power-management-on-managed-hosts_foreman"><a class="anchor" href="#enabling-power-management-on-managed-hosts_foreman"></a>4.4. Enabling Power Management on Managed Hosts</h3>
<div class="paragraph">
<p>To perform power management tasks on managed hosts using the intelligent platform management interface (IPMI) or a similar protocol, you must enable the baseboard management controller (BMC) module on Foreman&#160;server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>All managed hosts must have a network interface of BMC type.
Foreman&#160;server uses this NIC to pass the appropriate credentials to the host.
For more information, see <a href="https://docs.theforeman.org/3.7/Managing_Hosts/index-foreman-deb.html#Adding_a_Baseboard_Management_Controller_Interface_managing-hosts">Adding a Baseboard Management Controller (BMC) Interface</a> in <em>Managing Hosts</em>.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>To enable BMC, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-bmc "true" \
--foreman-proxy-bmc-default-provider "freeipmi"</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configuring-dns-dhcp-and-tftp_foreman"><a class="anchor" href="#configuring-dns-dhcp-and-tftp_foreman"></a>4.5. Configuring DNS, DHCP, and TFTP on Foreman&#160;server</h3>
<div class="paragraph">
<p>To configure the DNS, DHCP, and TFTP services on Foreman&#160;server, use the <code>foreman-installer</code> command with the options appropriate for your environment.
To view a complete list of configurable options, enter the <code>foreman-installer --help</code> command.</p>
</div>
<div class="paragraph">
<p>Any changes to the settings require entering the <code>foreman-installer</code> command again.
You can enter the command multiple times and each time it updates all configuration files with the changed values.</p>
</div>
<div class="paragraph">
<div class="title">Adding Multihomed DHCP details</div>
<p>If you want to use Multihomed DHCP, you must inform the installer.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Ensure that the following information is available to you:</p>
<div class="ulist">
<ul>
<li>
<p>DHCP IP address ranges</p>
</li>
<li>
<p>DHCP gateway IP address</p>
</li>
<li>
<p>DHCP nameserver IP address</p>
</li>
<li>
<p>DNS information</p>
</li>
<li>
<p>TFTP server name</p>
</li>
</ul>
</div>
</li>
<li>
<p>Use the FQDN instead of the IP address where possible in case of network changes.</p>
</li>
<li>
<p>Contact your network administrator to ensure that you have the correct settings.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Enter the <code>foreman-installer</code> command with the options appropriate for your environment.
The following example shows configuring full provisioning services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer \
--foreman-proxy-dns true \
--foreman-proxy-dns-managed true \
--foreman-proxy-dns-interface <em>eth0</em> \
--foreman-proxy-dns-zone <em>example.com</em> \
--foreman-proxy-dns-reverse <em>2.0.192.in-addr.arpa</em> \
--foreman-proxy-dhcp true \
--foreman-proxy-dhcp-managed true \
--foreman-proxy-dhcp-interface <em>eth0</em> \
--foreman-proxy-dhcp-additional-interfaces <em>eth1</em> \
--foreman-proxy-dhcp-additional-interfaces <em>eth2</em> \
--foreman-proxy-dhcp-range "<em>192.0.2.100</em> <em>192.0.2.150</em>" \
--foreman-proxy-dhcp-gateway <em>192.0.2.1</em> \
--foreman-proxy-dhcp-nameservers <em>192.0.2.2</em> \
--foreman-proxy-tftp true \
--foreman-proxy-tftp-managed true \
--foreman-proxy-tftp-servername <em>192.0.2.3</em></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can monitor the progress of the <code>foreman-installer</code> command displayed in your prompt.
You can view the logs in <code>/var/log/foreman-installer/foreman.log</code>.
You can view the settings used, including the <code>initial_admin_password</code> parameter, in the <code>/etc/foreman-installer/scenarios.d/foreman-answers.yaml</code> file.</p>
</div>
<div class="paragraph">
<p>For more information about configuring DHCP, DNS, and TFTP services, see <a href="https://docs.theforeman.org/3.7/Provisioning_Hosts/index-foreman-deb.html#Configuring_Network_Services_provisioning">Configuring Network Services</a> in <em>Provisioning Hosts</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="disabling-dns-dhcp-tftp-for-unmanaged-networks_foreman"><a class="anchor" href="#disabling-dns-dhcp-tftp-for-unmanaged-networks_foreman"></a>4.6. Disabling DNS, DHCP, and TFTP for Unmanaged Networks</h3>
<div class="paragraph">
<p>If you want to manage TFTP, DHCP, and DNS services manually, you must prevent Foreman from maintaining these services on the operating system and disable orchestration to avoid DHCP and DNS validation errors.
However, Foreman does not remove the back-end services on the operating system.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Foreman&#160;server, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-dhcp false \
--foreman-proxy-dns false \
--foreman-proxy-tftp false</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong> and select a subnet.</p>
</li>
<li>
<p>Click the <strong>Smart&#160;Proxies</strong> tab and clear the <strong>DHCP Smart&#160;Proxy</strong>, <strong>TFTP Smart&#160;Proxy</strong>, and <strong>Reverse DNS Smart&#160;Proxy</strong> fields.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Domains</strong> and select a domain.</p>
</li>
<li>
<p>Clear the <strong>DNS Smart&#160;Proxy</strong> field.</p>
</li>
<li>
<p>Optional: If you use a DHCP service supplied by a third party, configure your DHCP server to pass the following options:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">Option 66: <em>IP address of Foreman or Smart&#160;Proxy</em>
Option 67: /pxelinux.0</pre>
</div>
</div>
<div class="paragraph">
<p>For more information about DHCP options, see <a href="https://tools.ietf.org/html/rfc2132">RFC 2132</a>.</p>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Foreman does not perform orchestration when a Smart&#160;Proxy is not set for a given subnet and domain.
When enabling or disabling Smart&#160;Proxy associations, orchestration commands for existing hosts can fail if the expected records and configuration files are not present.
When associating a Smart&#160;Proxy to turn orchestration on, ensure the required DHCP and DNS records as well as the TFTP files are in place for the existing Foreman hosts in order to prevent host deletion failures in the future.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Server_for_Outgoing_Emails_foreman"><a class="anchor" href="#Configuring_Server_for_Outgoing_Emails_foreman"></a>4.7. Configuring Foreman&#160;server for Outgoing Emails</h3>
<div class="paragraph">
<p>To send email messages from Foreman&#160;server, you can use either an SMTP server, or the <code>sendmail</code> command.</p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Some SMTP servers with anti-spam protection or grey-listing features are known to cause problems.
To setup outgoing email with such a service either install and configure a vanilla SMTP service on Foreman&#160;server for relay or use the <code>sendmail</code> command instead.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>.</p>
</li>
<li>
<p>Click the <strong>Email</strong> tab and set the configuration options to match your preferred delivery method.
The changes have an immediate effect.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The following example shows the configuration options for using an SMTP server:</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Using an SMTP server as a delivery method</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Example value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delivery method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>smtp.example.com</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">login</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP HELO/EHLO domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>example.com</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>password</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>user@example.com</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>SMTP username</code> and <code>SMTP password</code> specify the login credentials for the SMTP server.</p>
</div>
</li>
<li>
<p>The following example uses <strong>gmail.com</strong> as an SMTP server:</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Using gmail.com as an SMTP server</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Example value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delivery method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">smtp.gmail.com</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">plain</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP HELO/EHLO domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">smtp.gmail.com</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP enable StartTLS auto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>password</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">587</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMTP username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>user</em>@gmail.com</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>The following example uses the <code>sendmail</code> command as a delivery method:</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Using sendmail as a delivery method</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Example value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delivery method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sendmail</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sendmail location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/usr/sbin/sendmail</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sendmail arguments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-i</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For security reasons, both Sendmail location and Sendmail argument settings are read-only and can be only set in <code>/etc/foreman/settings.yaml</code>.
Both settings currently cannot be set via <code>foreman-installer</code>.
This is being tracked in <a href="https://projects.theforeman.org/issues/33543">issue #33543</a>.
For more information see the <strong>sendmail 1</strong> man page.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>If you decide to send email using an SMTP server which uses TLS authentication, also perform one of the following steps:</p>
<div class="ulist">
<ul>
<li>
<p>Mark the CA certificate of the SMTP server as trusted.
To do so, execute the following commands on Foreman&#160;server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cp mailca.crt /etc/pki/ca-trust/source/anchors/
# update-ca-trust enable
# update-ca-trust</pre>
</div>
</div>
<div class="paragraph">
<p>Where <code><em>mailca.crt</em></code> is the CA certificate of the SMTP server.</p>
</div>
</li>
<li>
<p>Alternatively, in the Foreman web UI, set the <code>SMTP enable StartTLS auto</code> option to <code>No</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Test email</strong> to send a test message to the user&#8217;s email address to confirm the configuration is working.
If a message fails to send, the Foreman web UI displays an error.
See the log at <code>/var/log/foreman/production.log</code> for further details.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For information on configuring email notifications for individual users or user groups, see <a href="https://docs.theforeman.org/3.7/Administering_Project/index-foreman-deb.html#Configuring_Email_Notification_Preferences_admin">Configuring Email Notification Preferences</a> in <em>Administering Foreman</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="tuning-with-predefined-profiles_foreman"><a class="anchor" href="#tuning-with-predefined-profiles_foreman"></a>4.8. Tuning Foreman&#160;server with Predefined Profiles</h3>
<div class="paragraph">
<p>If your Foreman deployment includes more than 5000 hosts, you can use predefined tuning profiles to improve performance of Foreman.</p>
</div>
<div class="paragraph">
<p>Note that you cannot use tuning profiles on Smart&#160;Proxies.</p>
</div>
<div class="paragraph">
<p>You can choose one of the profiles depending on the number of hosts your Foreman manages and available hardware resources.</p>
</div>
<div class="paragraph">
<p>The tuning profiles are available in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes</code> directory.</p>
</div>
<div class="paragraph">
<p>When you run the <code>foreman-installer</code> command with the <code>--tuning</code> option, deployment configuration settings are applied to Foreman in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The default tuning profile defined in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code> file</p>
</li>
<li>
<p>The tuning profile that you want to apply to your deployment and is defined in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes/</code> directory</p>
</li>
<li>
<p>Optional: If you have configured a <code>/etc/foreman-installer/custom-hiera.yaml</code> file, Foreman applies these configuration settings.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the configuration settings that are defined in the <code>/etc/foreman-installer/custom-hiera.yaml</code> file override the configuration settings that are defined in the tuning profiles.</p>
</div>
<div class="paragraph">
<p>Therefore, before applying a tuning profile, you must compare the configuration settings that are defined in the default tuning profile in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code>, the tuning profile that you want to apply and your <code>/etc/foreman-installer/custom-hiera.yaml</code> file, and remove any duplicated configuration from the <code>/etc/foreman-installer/custom-hiera.yaml</code> file.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">default</dt>
<dd>
<p>Number of managed hosts: 0&#8202;&#8211;&#8202;5000</p>
<div class="paragraph">
<p>RAM: 20G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 4</p>
</div>
</dd>
<dt class="hdlist1">medium</dt>
<dd>
<p>Number of managed hosts: 5001&#8202;&#8211;&#8202;10000</p>
<div class="paragraph">
<p>RAM: 32G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 8</p>
</div>
</dd>
<dt class="hdlist1">large</dt>
<dd>
<p>Number of managed hosts: 10001&#8202;&#8211;&#8202;20000</p>
<div class="paragraph">
<p>RAM: 64G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 16</p>
</div>
</dd>
<dt class="hdlist1">extra-large</dt>
<dd>
<p>Number of managed hosts: 20001&#8202;&#8211;&#8202;60000</p>
<div class="paragraph">
<p>RAM: 128G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 32</p>
</div>
</dd>
<dt class="hdlist1">extra-extra-large</dt>
<dd>
<p>Number of managed hosts: 60000+</p>
<div class="paragraph">
<p>RAM: 256G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 48+</p>
</div>
</dd>
</dl>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Optional: If you have configured the <code>custom-hiera.yaml</code> file on Foreman&#160;server, back up the <code>/etc/foreman-installer/custom-hiera.yaml</code> file to <code>custom-hiera.original</code>.
You can use the backup file to restore the <code>/etc/foreman-installer/custom-hiera.yaml</code> file to its original state if it becomes corrupted:</p>
<div class="listingblock">
<div class="content">
<pre># cp /etc/foreman-installer/custom-hiera.yaml \
/etc/foreman-installer/custom-hiera.original</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you have configured the <code>custom-hiera.yaml</code> file on Foreman&#160;server, review the definitions of the default tuning profile in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code> and the tuning profile that you want to apply in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes/</code>.
Compare the configuration entries against the entries in your <code>/etc/foreman-installer/custom-hiera.yaml</code> file and remove any duplicated configuration settings in your <code>/etc/foreman-installer/custom-hiera.yaml</code> file.</p>
</li>
<li>
<p>Enter the <code>foreman-installer</code> command with the <code>--tuning</code> option for the profile that you want to apply.
For example, to apply the medium tuning profile settings, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --tuning medium</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Configuring_External_Authentication_foreman"><a class="anchor" href="#Configuring_External_Authentication_foreman"></a>5. Configuring External Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By using external authentication you can derive user and user group permissions from user group membership in an external identity provider.
When you use external authentication, you do not have to create these users and maintain their group membership manually on Foreman&#160;server.
In case the external source does not provide email, it will be requested during the first login through Foreman web UI.</p>
</div>
<div class="paragraph">
<div class="title">Important User and Group Account Information</div>
<p>All user and group accounts must be local accounts.
This is to ensure that there are no authentication conflicts between local accounts on your Foreman&#160;server and accounts in your Active Directory domain.</p>
</div>
<div class="paragraph">
<p>Your system is not affected by this conflict if your user and group accounts exist in both <code>/etc/passwd</code> and <code>/etc/group</code> files.
For example, to check if entries for <code>puppet</code>, <code>apache</code>, <code>foreman</code> and <code>foreman-proxy</code> groups exist in both <code>/etc/passwd</code> and <code>/etc/group</code> files, enter the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/passwd | grep 'puppet\|apache\|foreman\|foreman-proxy'
# cat /etc/group | grep 'puppet\|apache\|foreman\|foreman-proxy'</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Scenarios for Configuring External Authentication</div>
<p>Foreman supports the following general scenarios for configuring external authentication:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using <em>Lightweight Directory Access Protocol</em> (LDAP) server as an external identity provider.
LDAP is a set of open protocols used to access centrally stored information over a network.
With Foreman, you can manage LDAP entirely through the Foreman web UI.
For more information, see <a href="#Using_LDAP_foreman">Using LDAP</a>.
Though you can use LDAP to connect to a FreeIPA or AD server, the setup does not support server discovery, cross-forest trusts, or single sign-on with Kerberos in Foreman&#8217;s web UI.</p>
</li>
<li>
<p>Using a FreeIPA server as an external identity provider.
FreeIPA deals with the management of individual identities, their credentials and privileges used in a networking environment.
Configuration using FreeIPA cannot be completed using only the Foreman web UI and requires some interaction with the CLI.
For more information see <a href="#Using_FreeIPA_foreman">Using FreeIPA</a>.</p>
</li>
<li>
<p>Using <em>Active Directory</em> (AD) integrated with FreeIPA through cross-forest Kerberos trust as an external identity provider.
For more information see <a href="#Active_Directory_with_Cross_Forest_Trust_foreman">Active Directory with Cross-Forest Trust</a>.</p>
</li>
<li>
<p>Using Keycloak as an OpenID provider for external authentication to Foreman.
For more information, see <a href="#Configuring_Project_with_Keycloak_Authentication_keycloak-general">Configuring Foreman with Keycloak Authentication</a>.</p>
</li>
<li>
<p>Using Keycloak as an OpenID provider for external authentication to Foreman with TOTP.
For more information, see <a href="#Configuring_Keycloak_Authentication_with_TOTP_keycloak-totp">Configuring Keycloak Authentication with TOTP</a>.</p>
</li>
<li>
<p>Using Keycloak as an OpenID provider for external authentication to Foreman with PIV cards.
For more information, see <a href="#Configuring_Keycloak_Authentication_with_CAC_Cards_keycloak-cac-cards">Configuring Keycloak Authentication with PIV Cards</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As well as providing access to Foreman&#160;server, hosts provisioned with Foreman can also be integrated with FreeIPA realms.
Foreman has a realm feature that automatically manages the life cycle of any system registered to a realm or domain provider.
For more information, see <a href="#External_Authentication_for_Provisioned_Hosts_foreman">External Authentication for Provisioned Hosts</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Authentication Overview</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Authentication</th>
<th class="tableblock halign-left valign-top">User Groups</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FreeIPA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kerberos or LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active Directory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kerberos or LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POSIX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LDAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="Using_LDAP_foreman"><a class="anchor" href="#Using_LDAP_foreman"></a>5.1. Using LDAP</h3>
<div class="paragraph">
<p>Foreman supports LDAP authentication using one or multiple LDAP directories.</p>
</div>
<div class="paragraph">
<p>If you require Foreman to use <code>TLS</code> to establish a secure LDAP connection (LDAPS), first obtain certificates used by the LDAP server you are connecting to and mark them as trusted on the base operating system of your Foreman&#160;server as described below.
If your LDAP server uses a certificate chain with intermediate certificate authorities, all of the root and intermediate certificates in the chain must be trusted, so ensure all certificates are obtained.
If you do not require secure LDAP at this time, proceed to <a href="#Configuring_Project_to_Use_LDAP_foreman">Configuring Foreman to use LDAP</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Users cannot use both FreeIPA and LDAP as an authentication method.
Once a user authenticates using one method, they cannot use the other method.</p>
</div>
<div class="paragraph">
<p>To change the authentication method for a user, you have to remove the automatically created user from Foreman.</p>
</div>
<div class="paragraph">
<p>For more information on using FreeIPA as an authentication method, see <a href="#Using_FreeIPA_foreman">Using FreeIPA</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="Configuring_TLS_for_Secure_LDAP_foreman"><a class="anchor" href="#Configuring_TLS_for_Secure_LDAP_foreman"></a>5.1.1. Configuring TLS for Secure LDAP</h4>
<div class="paragraph">
<p>Use the Foreman CLI to configure TLS for secure LDAP (LDAPS).</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Obtain the Certificate from the LDAP Server.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you use Active Directory Certificate Services, export the Enterprise PKI CA Certificate using the Base-64 encoded X.509 format.
See <a href="https://access.redhat.com/solutions/1498773">How to configure Active Directory authentication with <code>TLS</code> on Foreman</a> for information on creating and exporting a CA certificate from an Active Directory server.</p>
</li>
<li>
<p>Download the LDAP server certificate to a temporary location onto Foreman&#160;server and remove it when finished.</p>
<div class="paragraph">
<p>For example, <code>/tmp/example.crt</code>.
The filename extensions <code>.cer</code> and <code>.crt</code> are only conventions and can refer to DER binary or PEM ASCII format certificates.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Trust the Certificate from the LDAP Server.</p>
<div class="paragraph">
<p>Foreman&#160;server requires the CA certificates for LDAP authentication to be individual files in <code>/etc/pki/tls/certs/</code> directory.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the <code>install</code> command to install the imported certificate into the <code>/etc/pki/tls/certs/</code> directory with the correct permissions:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># install /tmp/<em>example.crt</em> /etc/pki/tls/certs/</pre>
</div>
</div>
</li>
<li>
<p>Enter the following command as <code>root</code> to trust the <em>example.crt</em> certificate obtained from the LDAP server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ln -s <em>example.crt</em> /etc/pki/tls/certs/$(openssl \
x509 -noout -hash -in \
/etc/pki/tls/certs/<em>example.crt</em>).0</pre>
</div>
</div>
</li>
<li>
<p>Restart the <code>httpd</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart httpd</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_Project_to_Use_LDAP_foreman"><a class="anchor" href="#Configuring_Project_to_Use_LDAP_foreman"></a>5.1.2. Configuring Foreman to use LDAP</h4>
<div class="paragraph">
<p>In the Foreman web UI, configure Foreman to use LDAP.</p>
</div>
<div class="paragraph">
<p>Note that if you need single sign-on functionality with Kerberos on Foreman web UI, you should use FreeIPA and AD external authentication instead.
For more information, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Using_FreeIPA_foreman">Using FreeIPA</a></p>
</li>
<li>
<p><a href="#Using_Active_Directory_foreman">Using Active Directory</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Set the Network Information System (NIS) service boolean to true to prevent SELinux from stopping outgoing LDAP connections:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># setsebool -P nis_enabled on</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Authentication Sources</strong>.</p>
</li>
<li>
<p>Click <strong>Create LDAP Authentication Source</strong>.</p>
</li>
<li>
<p>On the <strong>LDAP server</strong> tab, enter the LDAP server&#8217;s name, host name, port, and server type.
The default port is 389, the default server type is POSIX (alternatively you can select FreeIPA or Active Directory depending on the type of authentication server).
For <code>TLS</code> encrypted connections, select the <strong>LDAPS</strong> checkbox to enable encryption.
The port should change to 636, which is the default for LDAPS.</p>
</li>
<li>
<p>On the <strong>Account</strong> tab, enter the account information and domain name details.
See <a href="#Description_of_LDAP_Settings_foreman">Description of LDAP Settings</a> for descriptions and examples.</p>
</li>
<li>
<p>On the <strong>Attribute mappings</strong> tab, map LDAP attributes to Foreman attributes.
You can map login name, first name, last name, email address, and photo attributes.
See <a href="#Example_Settings_for_LDAP_Connections_foreman">Example Settings for LDAP Connections</a> for examples.</p>
</li>
<li>
<p>On the <strong>Locations</strong> tab, select locations from the left table.
Selected locations are assigned to users created from the LDAP authentication source, and available after their first login.</p>
</li>
<li>
<p>On the <strong>Organizations</strong> tab, select organizations from the left table.
Selected organizations are assigned to users created from the LDAP authentication source, and available after their first login.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
<li>
<p>Configure new accounts for LDAP users:</p>
<div class="ulist">
<ul>
<li>
<p>If you did not select <strong>Automatically Create Accounts In Foreman</strong> checkbox, see <a href="https://docs.theforeman.org/3.7/Administering_Project/index-foreman-deb.html#Creating_a_User_admin">Creating a User</a> in <em>Administering Foreman</em> to create user accounts manually.</p>
</li>
<li>
<p>If you selected the <strong>Automatically Create Accounts In Foreman</strong> checkbox, LDAP users can now log in to Foreman using their LDAP accounts and passwords.
After they log in for the first time, the Foreman administrator has to assign roles to them manually.
For more information on assigning user accounts appropriate roles in Foreman, see <a href="https://docs.theforeman.org/3.7/Administering_Project/index-foreman-deb.html#Assigning_Roles_to_a_User_admin">Assigning Roles to a User</a> in <em>Administering Foreman</em>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Description_of_LDAP_Settings_foreman"><a class="anchor" href="#Description_of_LDAP_Settings_foreman"></a>5.1.3. Description of LDAP Settings</h4>
<div class="paragraph">
<p>The following table provides a description for each setting in the <strong>Account</strong> tab.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Account Tab Settings</caption>
<colgroup>
<col style="width: 22.2222%;">
<col style="width: 77.7778%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Setting</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Account</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The user name of the LDAP account that has read access to the LDAP server.
User name is not required if the server allows anonymous reading, otherwise use the full path to the user&#8217;s object.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">uid=$login,cn=users,cn=accounts,dc=example,dc=com</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>$login</code> variable stores the username entered on the login page as a literal string.
The value is accessed when the variable is expanded.</p>
</div>
<div class="paragraph">
<p>The variable cannot be used with external user groups from an LDAP source because Foreman needs to retrieve the group list without the user logging in.
Use either an anonymous, or dedicated service user.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Account password</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The LDAP password for the user defined in the <strong>Account username</strong> field.
This field can remain blank if the <strong>Account username</strong> is using the <code>$login</code> variable.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Base DN</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The top level domain name of the LDAP directory.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Groups base DN</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The top level domain name of the LDAP directory tree that contains groups.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>LDAP filter</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A filter to restrict LDAP queries.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Automatically Create Accounts In Foreman</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If this checkbox is selected, Foreman creates user accounts for LDAP users when they log in to Foreman for the first time.
After they log in for the first time, the Foreman administrator has to assign roles to them manually.
See <a href="https://docs.theforeman.org/3.7/Administering_Project/index-foreman-deb.html#Assigning_Roles_to_a_User_admin">Assigning Roles to a User</a> in <em>Administering Foreman</em> to assign user accounts appropriate roles in Foreman.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Usergroup Sync</strong></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If this option is selected, the user group membership of a user is automatically synchronized when the user logs in, which ensures the membership is always up to date.
If this option is cleared, Foreman relies on a cron job to regularly synchronize group membership (every 30 minutes by default).
For more information, see <a href="#Configuring_External_User_Groups_foreman">Configuring External User Groups</a>.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Example_Settings_for_LDAP_Connections_foreman"><a class="anchor" href="#Example_Settings_for_LDAP_Connections_foreman"></a>5.1.4. Example Settings for LDAP Connections</h4>
<div class="paragraph">
<p>The following table shows example settings for different types of LDAP connections.
The example below uses a dedicated service account called <em>redhat</em> that has bind, read, and search permissions on the user and group entries.
Note that LDAP attribute names are case sensitive.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Example Settings for Active Directory, Free IPA or Red&#160;Hat Identity Management and POSIX LDAP Connections</caption>
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 28.5714%;">
<col style="width: 28.5715%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Setting</th>
<th class="tableblock halign-left valign-top">Active Directory</th>
<th class="tableblock halign-left valign-top">FreeIPA or Red&#160;Hat Identity Management</th>
<th class="tableblock halign-left valign-top">POSIX (OpenLDAP)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Account</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOMAIN\redhat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uid=redhat,cn=users,
cn=accounts,dc=example,
dc=com</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uid=redhat,ou=users,
dc=example,dc=com</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Account password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P@ssword</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base DN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DC=example,DC=COM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dc=example,dc=com</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dc=example,dc=com</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Groups Base DN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CN=Users,DC=example,DC=com</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cn=groups,cn=accounts,
dc=example,dc=com</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cn=employee,ou=userclass,
dc=example,dc=com</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login name attribute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">userPrincipalName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uid</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First name attribute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">givenName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">givenName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">givenName</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last name attribute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sn</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Email address attribute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mail</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Photo attribute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">thumbnailPhoto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><code>userPrincipalName</code> allows the use of whitespace in usernames.
The login name attribute <code>sAMAccountName</code> (which is not listed in the table above) provides backwards compatibility with legacy Microsoft systems.
<code>sAMAccountName</code> does not allow the use of whitespace in usernames.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Example_LDAP_Filters_foreman"><a class="anchor" href="#Example_LDAP_Filters_foreman"></a>5.1.5. Example LDAP Filters</h4>
<div class="paragraph">
<p>As an administrator, you can create LDAP filters to restrict the access of specific users to Foreman.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Example filters for allowing specific users to login</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">User</th>
<th class="tableblock halign-left valign-top">Filter</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(distinguishedName=cn=User1,cn=Users,dc=domain,dc=example)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User1, User3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(memberOf=cn=Group1,cn=Users,dc=domain,dc=example)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User2, User3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(memberOf=cn=Group2,cn=Users,dc=domain,dc=example)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User1, User2, User3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(|(memberOf=cn=Group1,cn=Users,dc=domain,dc=example)(memberOf=cn=Group2,cn=Users,dc=domain,dc=example))</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User1, User2, User3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(memberOf:1.2.840.113556.1.4.1941:=cn=Users,dc=domain,dc=example)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Group <code>Users</code> is a nested group that contains groups <code>Group1</code> and <code>Group2</code>.
If you want to filter all users from a nested group, you must add <code>memberOf:1.2.840.113556.1.4.1941:=</code> before the nested group name.
See the last example in the table above.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">LDAP directory structure</div>
<p>The LDAP directory structure that the filters in the example use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">DC=Domain,DC=Example
   |
   |----- CN=Users
         |
         |----- CN=Group1
         |----- CN=Group2
         |----- CN=User1
         |----- CN=User2
         |----- CN=User3</pre>
</div>
</div>
<div class="paragraph">
<div class="title">LDAP group membership</div>
<p>The group membership that the filters in the example use:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Group</th>
<th class="tableblock halign-left valign-top">Members</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User1,
User3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User2,
User3</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Using_FreeIPA_foreman"><a class="anchor" href="#Using_FreeIPA_foreman"></a>5.2. Using FreeIPA</h3>
<div class="paragraph">
<p>This section shows how to integrate Foreman&#160;server with a FreeIPA server and how to enable host-based access control.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can attach FreeIPA as an external authentication source with no single sign-on support.
For more information, see <a href="#Using_LDAP_foreman">Using LDAP</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>Users cannot use both FreeIPA and LDAP as an authentication method.
Once a user authenticates using one method, they cannot use the other method.</p>
</div>
<div class="paragraph">
<p>To change the authentication method for a user, you have to remove the automatically created user from Foreman.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>The base operating system of Foreman&#160;server must be enrolled in the FreeIPA domain by the FreeIPA administrator of your organization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The examples in this chapter assume separation between FreeIPA and Foreman configuration.
However, if you have administrator privileges for both servers, you can configure FreeIPA as described in <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/installing_identity_management/index">Red&#160;Hat Enterprise Linux 8 Installing Identity Management Guide</a>.</p>
</div>
<div class="sect3">
<h4 id="Configuring_FreeIPA_Authentication_on_Server_foreman"><a class="anchor" href="#Configuring_FreeIPA_Authentication_on_Server_foreman"></a>5.2.1. Configuring FreeIPA Authentication on Foreman&#160;server</h4>
<div class="paragraph">
<p>In the Foreman CLI, configure FreeIPA authentication by first creating a host entry on the FreeIPA server.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the FreeIPA server, to authenticate, enter the following command and enter your password when prompted:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># kinit <em>admin</em></pre>
</div>
</div>
</li>
<li>
<p>To verify that you have authenticated, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># klist</pre>
</div>
</div>
</li>
<li>
<p>On the FreeIPA server, create a host entry for Foreman&#160;server and generate a one-time password, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa host-add --random <em>hostname</em></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The generated one-time password must be used on the client to complete FreeIPA-enrollment.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create an HTTP service for Foreman&#160;server, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa service-add HTTP/<em>hostname</em></pre>
</div>
</div>
</li>
<li>
<p>On Foreman&#160;server, install the IPA client:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install ipa-client</pre>
</div>
</div>
</li>
<li>
<p>On Foreman&#160;server, enter the following command as root to configure FreeIPA-enrollment:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa-client-install --password <em>OTP</em></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>OTP</em> with the one-time password provided by the FreeIPA administrator.</p>
</div>
</li>
<li>
<p>Ensure that the hostname is set to the fully qualified domain name (FQDN); the short name is not sufficient:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hostname
foreman.example.com</pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise, <code>foreman-installer</code> cannot generate the right principal name that is needed to join the realm.</p>
</div>
</li>
<li>
<p>Set FreeIPA as the authentication provider, using one of the following commands:</p>
<div class="ulist">
<ul>
<li>
<p>If you only want to enable access to the Foreman web UI but not the Foreman API, enter:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer \
--foreman-ipa-authentication=true</pre>
</div>
</div>
</li>
<li>
<p>If you want to enable access both to the Foreman web UI and the Foreman API, enter:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer \
--foreman-ipa-authentication-api=true \
--foreman-ipa-authentication=true</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Enabling access to both the Foreman API and the Foreman web UI can lead to security problems.
After an IdM user receives a Kerberos ticket-granting ticket (TGT) by entering <code>kinit <em>user_name</em></code>, an attacker can obtain an API session.
The attack is possible even if the user did not previously enter the Foreman login credentials anywhere, for example in the browser.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Restart Foreman services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service restart</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>External users can now log in to Foreman using their FreeIPA credentials.
They can now choose to either log in to Foreman&#160;server directly using their username and password or take advantage of the configured Kerberos single sign-on and obtain a ticket on their client machine and be logged in automatically.
The two-factor authentication with one-time password (2FA OTP) is also supported.</p>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_Host_Based_Authentication_Control_foreman"><a class="anchor" href="#Configuring_Host_Based_Authentication_Control_foreman"></a>5.2.2. Configuring Host-Based Authentication Control</h4>
<div class="paragraph">
<p>HBAC rules define which machine within the domain a FreeIPA user is allowed to access.
You can configure HBAC on the FreeIPA server to prevent selected users from accessing Foreman&#160;server.
With this approach, you can prevent Foreman from creating database entries for users that are not allowed to log in.
For more information on HBAC, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/managing_idm_users_groups_hosts_and_access_control_rules/index#host-based-access-control-rules-in-idm_ensuring-the-presence-of">Managing IdM Users, Groups, Hosts, and Access Control Rules Guide</a>.</p>
</div>
<div class="paragraph">
<p>On the FreeIPA server, configure Host-Based Authentication Control (HBAC).</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the FreeIPA server, to authenticate, enter the following command and enter your password when prompted:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># kinit <em>admin</em></pre>
</div>
</div>
</li>
<li>
<p>To verify that you have authenticated, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># klist</pre>
</div>
</div>
</li>
<li>
<p>Create HBAC service and rule on the FreeIPA server and link them together.
The following examples use the PAM service name <em>foreman-prod</em>.
Execute the following commands on the FreeIPA server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa hbacsvc-add foreman-prod
# ipa hbacrule-add allow_foreman_prod
# ipa hbacrule-add-service allow_foreman_prod --hbacsvcs=foreman-prod</pre>
</div>
</div>
</li>
<li>
<p>Add the user who is to have access to the service foreman-prod, and the hostname of Foreman&#160;server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa hbacrule-add-user allow_foreman_prod --user=<em>username</em>
# ipa hbacrule-add-host allow_foreman_prod --hosts=<em>foreman.example.com</em></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, host groups and user groups can be added to the <em>allow</em>foreman_prod_ rule.</p>
</div>
</li>
<li>
<p>To check the status of the rule, execute:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa hbacrule-find foreman-prod
# ipa hbactest --user=<em>username</em> --host=<em>foreman.example.com</em> --service=foreman-prod</pre>
</div>
</div>
</li>
<li>
<p>Ensure the allow_all rule is disabled on the FreeIPA server.
For instructions on how to do so without disrupting other services see the <a href="https://access.redhat.com/solutions/67895">How to configure HBAC rules in IdM</a> article on the Red&#160;Hat Customer Portal.</p>
</li>
<li>
<p>Configure the FreeIPA integration with Foreman&#160;server as described in <a href="#Configuring_FreeIPA_Authentication_on_Server_foreman">Configuring FreeIPA Authentication on Foreman&#160;server</a>.
On Foreman&#160;server, define the PAM service as root:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-pam-service=foreman-prod</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Using_Active_Directory_foreman"><a class="anchor" href="#Using_Active_Directory_foreman"></a>5.3. Using Active Directory</h3>
<div class="paragraph">
<p>This section shows how to use direct Active Directory (AD) as an external authentication source for Foreman&#160;server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can attach Active Directory as an external authentication source with no single sign-on support.
For more information, see <a href="#Using_LDAP_foreman">Using LDAP</a>.
For an example configuration, see <a href="https://access.redhat.com/solutions/1498773">How to configure Active Directory authentication with TLS on Foreman</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Direct AD integration means that Foreman&#160;server is joined directly to the AD domain where the identity is stored.
The recommended setup consists of two steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enrolling Foreman&#160;server with the Active Directory server as described in <a href="#Enrolling_Server_with_the_AD_Server_foreman">Enrolling Foreman&#160;server with the AD Server</a>.</p>
</li>
<li>
<p>Configuring direct Active Directory integration with GSS-proxy as described in <a href="#Configuring_Direct_AD_Integration_with_GSS_Proxy_foreman">Configuring Direct AD Integration with GSS-Proxy</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="GSS_Proxy_foreman"><a class="anchor" href="#GSS_Proxy_foreman"></a>5.3.1. GSS-Proxy</h4>
<div class="paragraph">
<p>The traditional process of Kerberos authentication in Apache requires the Apache process to have read access to the keytab file.
GSS-Proxy allows you to implement stricter privilege separation for the Apache server by removing access to the keytab file while preserving Kerberos authentication functionality.
When using AD as an external authentication source for Foreman, it is recommended to implement GSS-proxy, because the keys in the keytab file are the same as the host keys.</p>
</div>
<div class="paragraph">
<p>Perform the following procedures on Enterprise Linux that acts as a base operating system for your Foreman&#160;server.
For the examples in this section <em>EXAMPLE.ORG</em> is the Kerberos realm for the AD domain.
By completing the procedures, users that belong to the EXAMPLE.ORG realm can log in to Foreman&#160;server.</p>
</div>
</div>
<div class="sect3">
<h4 id="Enrolling_Server_with_the_AD_Server_foreman"><a class="anchor" href="#Enrolling_Server_with_the_AD_Server_foreman"></a>5.3.2. Enrolling Foreman&#160;server with the AD Server</h4>
<div class="paragraph">
<p>In the Foreman CLI, enroll Foreman&#160;server with the Active Directory server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>GSS-proxy and nfs-common are installed.</p>
<div class="paragraph">
<p>Installing GSS-proxy and nfs-common:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install gssproxy nfs-common</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install the required packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install sssd adcli realmd ipa-python-compat krb5-workstation samba-common-tools</pre>
</div>
</div>
</li>
<li>
<p>Enroll Foreman&#160;server with the AD server.
You may need to have administrator permissions to perform the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># realm join -v <em>EXAMPLE.ORG</em> --membership-software=samba -U Administrator</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_Direct_AD_Integration_with_GSS_Proxy_foreman"><a class="anchor" href="#Configuring_Direct_AD_Integration_with_GSS_Proxy_foreman"></a>5.3.3. Configuring Direct AD Integration with GSS-Proxy</h4>
<div class="paragraph">
<p>In the Foreman CLI, configure the direct Active Directory integration with GSS-proxy.</p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Foreman is enrolled with the Active Directory server.
For more information, see <a href="#Enrolling_Server_with_the_AD_Server_foreman">Enrolling Foreman&#160;server with the AD Server</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the <code>/etc/ipa/</code> directory and the <code>default.conf</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir /etc/ipa
# touch /etc/ipa/default.conf</pre>
</div>
</div>
</li>
<li>
<p>To the <code>default.conf</code> file, add the following content:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[global]
server = unused
realm = <em>EXAMPLE.ORG</em></pre>
</div>
</div>
</li>
<li>
<p>Create the <code>/etc/net-keytab.conf</code> file with the following content:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[global]
workgroup = EXAMPLE
realm = EXAMPLE.ORG
kerberos method = system keytab
security = ads</pre>
</div>
</div>
</li>
<li>
<p>Determine the effective user ID of the Apache user:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># id apache</pre>
</div>
</div>
<div class="paragraph">
<p>Apache user must not have access to the keytab file.</p>
</div>
</li>
<li>
<p>Create the <code>/etc/gssproxy/00-http.conf</code> file with the following content:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[service/HTTP]
mechs = krb5
cred_store = keytab:/etc/krb5.keytab
cred_store = ccache:/var/lib/gssproxy/clients/krb5cc_%U
euid = <em>ID_of_Apache_User</em></pre>
</div>
</div>
</li>
<li>
<p>Create a keytab entry:</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The host must not be enrolled to a domain before creating a keytab entry.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># KRB5_KTNAME=FILE:/etc/httpd/conf/http.keytab net ads keytab add HTTP -U administrator -d3 -s /etc/net-keytab.conf
# chown root.apache /etc/httpd/conf/http.keytab
# chmod 640 /etc/httpd/conf/http.keytab</pre>
</div>
</div>
</li>
<li>
<p>Enable IPA authentication in Foreman:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-ipa-authentication=true</pre>
</div>
</div>
</li>
<li>
<p>Start and enable the <code>gssproxy</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart gssproxy
# systemctl enable --now gssproxy</pre>
</div>
</div>
</li>
<li>
<p>To configure the Apache server to use the <code>gssproxy</code> service, create a <code>systemd</code> drop-in file and add the following content to it:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir -p /etc/systemd/system/httpd.service.d/
# vi /etc/systemd/system/httpd.service.d/gssproxy.conf
[Service]
Environment=GSS_USE_PROXY=1</pre>
</div>
</div>
</li>
<li>
<p>Apply changes to the service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl daemon-reload</pre>
</div>
</div>
</li>
<li>
<p>Start and enable the <code>httpd</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart httpd</pre>
</div>
</div>
</li>
<li>
<p>Verify that SSO is working as expected.</p>
<div class="paragraph">
<p>With a running Apache server, users making HTTP requests against the server are authenticated if the client has a valid Kerberos ticket.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Retrieve the Kerberos ticket of the LDAP user, using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># kinit ldapuser</pre>
</div>
</div>
</li>
<li>
<p>View the Kerberos ticket, using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># klist</pre>
</div>
</div>
</li>
<li>
<p>View output from successful SSO-based authentication, using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># curl -k -u : --negotiate https://<em>foreman.example.com/</em>users/extlogin</pre>
</div>
</div>
<div class="paragraph">
<p>This returns the following response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">&lt;html&gt;&lt;body&gt;You are being &lt;a href="https://<em>foreman.example.com/</em>users/4-ldapuserexample-com/edit"&gt;redirected&lt;/a&gt;.&lt;/body&gt;&lt;/html&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Kerberos_Configuration_in_Web_Browsers_foreman"><a class="anchor" href="#Kerberos_Configuration_in_Web_Browsers_foreman"></a>5.3.4. Kerberos Configuration in Web Browsers</h4>
<div class="paragraph">
<p>For information on configuring Firefox, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/configuring_authentication_and_authorization_in_rhel/index#Configuring_Firefox_to_use_Kerberos_for_SSO">Configuring Firefox to Use Kerberos for Single Sign-On</a> in the <em>Red&#160;Hat Enterprise Linux Configuring authentication and authorization in RHEL</em> guide.</p>
</div>
<div class="paragraph">
<p>If you use the Internet Explorer browser, add Foreman&#160;server to the list of Local Intranet or Trusted sites, and turn on the <em>Enable Integrated Windows Authentication</em> setting.
See the Internet Explorer documentation for details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>With direct AD integration, HBAC through FreeIPA is not available.
As an alternative, you can use Group Policy Objects (GPO) that enable administrators to centrally manage policies in AD environments.
To ensure correct GPO to PAM service mapping, use the following sssd configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">access_provider = ad
ad_gpo_access_control = enforcing
ad_gpo_map_service = +foreman</pre>
</div>
</div>
<div class="paragraph">
<p>Here, <em>foreman</em> is the PAM service name.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Active_Directory_with_Cross_Forest_Trust_foreman"><a class="anchor" href="#Active_Directory_with_Cross_Forest_Trust_foreman"></a>5.3.5. Active Directory with Cross-Forest Trust</h4>
<div class="paragraph">
<p>Kerberos can create <code>cross-forest trust</code> that defines a relationship between two otherwise separate domain forests.
A domain forest is a hierarchical structure of domains; both AD and FreeIPA constitute a forest.
With a trust relationship enabled between AD and FreeIPA, users of AD can access Linux hosts and services using a single set of credentials.</p>
</div>
<div class="paragraph">
<p>From the Foreman point of view, the configuration process is the same as integration with FreeIPA server without cross-forest trust configured.
Foreman&#160;server has to be enrolled in the IdM domain and integrated as described in <a href="#Using_FreeIPA_foreman">Using FreeIPA</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_the_FreeIPA_Server_to_use_Cross_Forest_Trust_foreman"><a class="anchor" href="#Configuring_the_FreeIPA_Server_to_use_Cross_Forest_Trust_foreman"></a>5.3.6. Configuring the FreeIPA Server to Use Cross-Forest Trust</h4>
<div class="paragraph">
<p>On the FreeIPA server, configure the server to use <code>cross-forest trust</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable HBAC:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create an external group and add the AD group to it.</p>
</li>
<li>
<p>Add the new external group to a POSIX group.</p>
</li>
<li>
<p>Use the POSIX group in a HBAC rule.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Configure sssd to transfer additional attributes of AD users.</p>
<div class="ulist">
<ul>
<li>
<p>Add the AD user attributes to the <em>nss</em> and <em>domain</em> sections in <code>/etc/sssd/sssd.conf</code>.
For example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">[nss]
user_attributes=+mail, +sn, +givenname
[domain/EXAMPLE.com]
...
krb5_store_password_if_offline = True
ldap_user_extra_attrs=email:mail, lastname:sn, firstname:givenname

[ifp]
allowed_uids = ipaapi, root
user_attributes=+email, +firstname, +lastname</pre>
</div>
</div>
</li>
<li>
<p>Verify the AD attributes value.</p>
<div class="listingblock">
<div class="content">
<pre># dbus-send --print-reply --system --dest=org.freedesktop.sssd.infopipe /org/freedesktop/sssd/infopipe org.freedesktop.sssd.infopipe.GetUserAttr string:ad-user@ad-domain array:string:email,firstname,lastname</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_External_User_Groups_foreman"><a class="anchor" href="#Configuring_External_User_Groups_foreman"></a>5.4. Configuring External User Groups</h3>
<div class="paragraph">
<p>Foreman does not associate external users with their user group automatically.
You must create a user group with the same name as in the external source on Foreman.
Members of the external user group then automatically become members of the Foreman user group and receive the associated permissions.</p>
</div>
<div class="paragraph">
<p>The configuration of external user groups depends on the type of external authentication.</p>
</div>
<div class="paragraph">
<p>To assign additional permissions to an external user, add this user to an internal user group that has no external mapping specified.
Then assign the required roles to this group.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>If you use an LDAP server, configure Foreman to use LDAP authentication.
For more information see <a href="#Using_LDAP_foreman">Using LDAP</a>.</p>
<div class="paragraph">
<p>When using external user groups from an LDAP source, you cannot use the <code>$login</code> variable as a substitute for the account user name.
You must use either an anonymous or dedicated service user.</p>
</div>
</li>
<li>
<p>If you use a FreeIPA or AD server, configure Foreman to use FreeIPA or AD authentication.
For more information, see <a href="https://docs.theforeman.org/3.7/Installing_Server/index-foreman-deb.html#Configuring_External_Authentication_foreman">Configuring External Authentication</a> in <em>Installing Foreman 3.7 Server on Debian/Ubuntu</em>.</p>
</li>
<li>
<p>Ensure that at least one external user authenticates for the first time.</p>
</li>
<li>
<p>Retain a copy of the external group names you want to use.
To find the group membership of external users, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># id <em>username</em></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>User Groups</strong>, and click <strong>Create User Group</strong>.</p>
</li>
<li>
<p>Specify the name of the new user group.
Do not select any users to avoid adding users automatically when you refresh the external user group.</p>
</li>
<li>
<p>Click the <strong>Roles</strong> tab and select the roles you want to assign to the user group.
Alternatively, select the <strong>Administrator</strong> checkbox to assign all available permissions.</p>
</li>
<li>
<p>Click the <strong>External groups</strong> tab, then click <strong>Add external user group</strong>, and select an authentication source from the <strong>Auth source</strong> drop-down menu.</p>
<div class="paragraph">
<p>Specify the exact name of the external group in the <strong>Name</strong> field.</p>
</div>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="Refreshing_External_User_Groups_for_LDAP_foreman"><a class="anchor" href="#Refreshing_External_User_Groups_for_LDAP_foreman"></a>5.5. Refreshing External User Groups for LDAP</h3>
<div class="paragraph">
<p>To set the LDAP source to synchronize user group membership automatically on user login, in the <strong>Auth Source</strong> page, select the <strong>Usergroup Sync</strong> option.
If this option is not selected, LDAP user groups are refreshed automatically through a scheduled cron job synchronizing the LDAP Authentication source every 30 minutes by default.</p>
</div>
<div class="paragraph">
<p>If the user groups in the LDAP Authentication source change in the lapse of time between scheduled tasks, the user can be assigned to incorrect external user groups.
This is corrected automatically when the scheduled task runs.</p>
</div>
<div class="paragraph">
<p>Use this procedure to refresh the LDAP source manually.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Usergroups</strong> and select a user group.</p>
</li>
<li>
<p>On the <strong>External Groups</strong> tab, click <strong>Refresh</strong> to the right of the required user group.</p>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">CLI procedure</div>
<ul>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre># foreman-rake ldap:refresh_usergroups</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="Refreshing_External_User_Groups_for_FreeIPA_or_AD_foreman"><a class="anchor" href="#Refreshing_External_User_Groups_for_FreeIPA_or_AD_foreman"></a>5.6. Refreshing External User Groups for FreeIPA or AD</h3>
<div class="paragraph">
<p>External user groups based on FreeIPA or AD are refreshed only when a group member logs in to Foreman.
It is not possible to alter user membership of external user groups in the Foreman web UI, such changes are overwritten on the next group refresh.</p>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_the_Hammer_CLI_to_Use_FreeIPA_User_Authentication_foreman"><a class="anchor" href="#Configuring_the_Hammer_CLI_to_Use_FreeIPA_User_Authentication_foreman"></a>5.7. Configuring the Hammer CLI to Use FreeIPA User Authentication</h3>
<div class="paragraph">
<p>This section describes how to configure the Foreman Hammer command-line interface (CLI) tool to use FreeIPA (IdM) to authenticate users.</p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>You are logged in to the host from which you want to access Foreman by using Hammer.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Enable sessions in the <code>~/.hammer/cli.modules.d/foreman.yml</code> Hammer configuration file by adding the <code>:use_sessions: true</code> line to the <code>foreman</code> parameters:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">:foreman:
  :use_sessions: true</pre>
</div>
</div>
<div class="paragraph">
<p>Adding the line enforces session usage in Hammer.
This means that Hammer performs the authentication request only once instead of with each <code>hammer</code> command.</p>
</div>
</li>
<li>
<p>Optional: Enable negotiate authentication in the <code>~/.hammer/cli.modules.d/foreman.yml</code> Hammer configuration file by adding the <code>:default_auth_type: 'Negotiate_Auth'</code> line to the <code>foreman</code> parameters:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">:foreman:
  :default_auth_type: 'Negotiate_Auth'
  :use_sessions: true</pre>
</div>
</div>
<div class="paragraph">
<p>Adding this line means that your authentication is negotiated when you enter the first <code>hammer</code> command.
If this entry is present, Hammer tries to communicate with Foreman&#160;server using the negotiation protocol.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="External_Authentication_for_Provisioned_Hosts_foreman"><a class="anchor" href="#External_Authentication_for_Provisioned_Hosts_foreman"></a>5.8. External Authentication for Provisioned Hosts</h3>
<div class="paragraph">
<p>Use this section to configure Foreman&#160;server or Smart&#160;Proxy&#160;server for FreeIPA realm support, then add hosts to the FreeIPA realm group.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Foreman&#160;server that is registered to the Content Delivery Network or an external Smart&#160;Proxy&#160;server that is registered to Foreman&#160;server.</p>
</li>
<li>
<p>A deployed realm or domain provider such as FreeIPA.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">To install and configure FreeIPA packages on Foreman&#160;server or Smart&#160;Proxy&#160;Server:</div>
<p>To use FreeIPA for provisioned hosts, complete the following steps to install and configure FreeIPA packages on Foreman&#160;server or Smart&#160;Proxy&#160;server:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the <code>ipa-client</code> package on Foreman&#160;server or Smart&#160;Proxy&#160;server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install ipa-client</pre>
</div>
</div>
</li>
<li>
<p>Configure the server as a FreeIPA client:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa-client-install</pre>
</div>
</div>
</li>
<li>
<p>Create a realm proxy user, <code>realm-smart-proxy</code>, and the relevant roles in FreeIPA:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-prepare-realm admin realm-smart-proxy</pre>
</div>
</div>
<div class="paragraph">
<p>Note the principal name that returns and your FreeIPA server configuration details because you require them for the following procedure.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">To configure Foreman&#160;server or Smart&#160;Proxy&#160;Server for FreeIPA Realm Support:</div>
<p>Complete the following procedure on Foreman and every Smart&#160;Proxy that you want to use:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy the <code>/root/freeipa.keytab</code> file to any Smart&#160;Proxy&#160;server that you want to include in the same principal and realm:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp /root/freeipa.keytab root@<em>smartproxy.example.com</em>:/etc/foreman-proxy/freeipa.keytab</pre>
</div>
</div>
</li>
<li>
<p>Move the <code>/root/freeipa.keytab</code> file to the <code>/etc/foreman-proxy</code> directory and set the ownership settings to the <code>foreman-proxy</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mv /root/freeipa.keytab /etc/foreman-proxy
# chown foreman-proxy:foreman-proxy /etc/foreman-proxy/freeipa.keytab</pre>
</div>
</div>
</li>
<li>
<p>Enter the following command on all Smart&#160;Proxies that you want to include in the realm.
If you use the integrated Smart&#160;Proxy on Foreman, enter this command on Foreman&#160;server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-realm true \
--foreman-proxy-realm-keytab /etc/foreman-proxy/freeipa.keytab \
--foreman-proxy-realm-principal <em>realm-smart-proxy@EXAMPLE.COM</em> \
--foreman-proxy-realm-provider freeipa</pre>
</div>
</div>
<div class="paragraph">
<p>You can also use these options when you first configure the Foreman&#160;server.</p>
</div>
</li>
<li>
<p>Ensure that the most updated versions of the ca-certificates package is installed and trust the FreeIPA Certificate Authority:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cp /etc/ipa/ca.crt /etc/pki/ca-trust/source/anchors/ipa.crt
# update-ca-trust enable
# update-ca-trust</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you configure FreeIPA on an existing Foreman&#160;server or Smart&#160;Proxy&#160;server, complete the following steps to ensure that the configuration changes take effect:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Restart the <strong>foreman-proxy</strong> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart foreman-proxy</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong>.</p>
</li>
<li>
<p>Locate the Smart&#160;Proxy you have configured for FreeIPA and from the list in the <strong>Actions</strong> column, select <strong>Refresh</strong>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">To create a realm for the FreeIPA-enabled Smart&#160;Proxy</div>
<p>After you configure your integrated or external Smart&#160;Proxy with FreeIPA, you must create a realm and add the FreeIPA-configured Smart&#160;Proxy to the realm.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Realms</strong> and click <strong>Create Realm</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the realm.</p>
</li>
<li>
<p>From the <strong>Realm Type</strong> list, select the type of realm.</p>
</li>
<li>
<p>From the <strong>Realm Smart&#160;Proxy</strong> list, select Smart&#160;Proxy&#160;server where you have configured FreeIPA.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and from the <strong>Locations</strong> list, select the location where you want to add the new realm.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and from the <strong>Organizations</strong> list, select the organization where you want to add the new realm.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Updating Host Groups with Realm Information</div>
<p>You must update any host groups that you want to use with the new realm information.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Configure</strong> &gt; <strong>Host Groups</strong>, select the host group that you want to update, and click the <strong>Network</strong> tab.</p>
</li>
<li>
<p>From the <strong>Realm</strong> list, select the realm you create as part of this procedure, and then click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Adding Hosts to a FreeIPA Host Group</div>
<p>FreeIPA supports the ability to set up automatic membership rules based on a system&#8217;s attributes.
Foreman&#8217;s realm feature provides administrators with the ability to map the Foreman host groups to the FreeIPA parameter <code>userclass</code> which allow administrators to configure automembership.</p>
</div>
<div class="paragraph">
<p>When nested host groups are used, they are sent to the FreeIPA server as they are displayed in the Foreman User Interface.
For example, "Parent/Child/Child".</p>
</div>
<div class="paragraph">
<p>Foreman&#160;server or Smart&#160;Proxy&#160;server sends updates to the FreeIPA server, however automembership rules are only applied at initial registration.</p>
</div>
<div class="olist arabic">
<div class="title">To Add Hosts to a FreeIPA Host Group:</div>
<ol class="arabic">
<li>
<p>On the FreeIPA server, create a host group:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa hostgroup-add <em>hostgroup_name</em> --desc=<em>hostgroup_description</em></pre>
</div>
</div>
</li>
<li>
<p>Create an <code>automembership</code> rule:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa automember-add --type=hostgroup <em>hostgroup_name</em> <em>automember_rule</em></pre>
</div>
</div>
<div class="paragraph">
<p>Where you can use the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>automember-add</code> flags the group as an automember group.</p>
</li>
<li>
<p><code>--type=hostgroup</code> identifies that the target group is a host group, not a user group.</p>
</li>
<li>
<p><code><em>automember_rule</em></code> adds the name you want to identify the automember rule by.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Define an automembership condition based on the <code>userclass</code> attribute:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa automember-add-condition --key=userclass --type=hostgroup --inclusive-regex=<em>^webserver</em> <em>hostgroup_name</em>
----------------------------------
Added condition(s) to "<em>hostgroup_name</em>"
----------------------------------
Automember Rule: <em>automember_rule</em>
Inclusive Regex: userclass=<em>^webserver</em>
----------------------------
Number of conditions added 1
----------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>Where you can use the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>automember-add-condition</code> adds regular expression conditions to identify group members.</p>
</li>
<li>
<p><code>--key=userclass</code> specifies the key attribute as <code>userclass</code>.</p>
</li>
<li>
<p><code>--type=hostgroup</code> identifies that the target group is a host group, not a user group.</p>
</li>
<li>
<p><code>--inclusive-regex=</code> <em>^webserver</em> identifies matching values with a regular expression pattern.</p>
</li>
<li>
<p><em>hostgroup_name</em> &#8211; identifies the target host group&#8217;s name.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>When a system is added to Foreman&#160;server&#8217;s <em>hostgroup_name</em> host group, it is added automatically to the FreeIPA server&#8217;s "<em>hostgroup_name</em>" host group.
FreeIPA host groups allow for Host-Based Access Controls (HBAC), sudo policies and other FreeIPA functions.</p>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Project_with_Keycloak_Authentication_keycloak-general"><a class="anchor" href="#Configuring_Project_with_Keycloak_Authentication_keycloak-general"></a>5.9. Configuring Foreman with Keycloak Authentication</h3>
<div class="paragraph">
<p>Use this section to configure Foreman to use Keycloak as an OpenID provider for external authentication.</p>
</div>
<div class="sect3">
<h4 id="prerequisites-for-integrating-foreman-with-keycloak_keycloak-general"><a class="anchor" href="#prerequisites-for-integrating-foreman-with-keycloak_keycloak-general"></a>5.9.1. Prerequisites for Configuring Foreman with Keycloak Authentication</h4>
<div class="paragraph">
<p>Before configuring Foreman with Keycloak external authentication, ensure that you meet the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A working installation of Keycloak server that uses HTTPS instead of HTTP.</p>
</li>
<li>
<p>A Keycloak account with admin privileges.</p>
</li>
<li>
<p>A realm for Foreman user accounts created in Keycloak.</p>
</li>
<li>
<p>If the certificates or the CA are self-signed, ensure that they are added to the end-user certificate trust store.</p>
</li>
<li>
<p>Users imported or added to Keycloak.</p>
<div class="paragraph">
<p>If you have an existing user database configured such as LDAP or Kerberos, you can import users from it by configuring user federation.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.4/html/server_administration_guide/user-storage-federation">User Storage Federation</a> in the <em>Red&#160;Hat Single Sign-On Server Administration Guide</em>.</p>
</div>
<div class="paragraph">
<p>If you do not have an existing user database configured, you can manually create users in Keycloak.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.4/html/server_administration_guide/user_management#create-new-user">Creating New Users</a> in the <em>Red&#160;Hat Single Sign-On Server Administration Guide</em>.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="registering-foreman-as-a-keycloak-client_keycloak-general"><a class="anchor" href="#registering-foreman-as-a-keycloak-client_keycloak-general"></a>5.9.2. Registering Foreman as a Keycloak Client</h4>
<div class="paragraph">
<p>Use this procedure to register Foreman to Keycloak as a client and configure Foreman to use Keycloak as an authentication source.</p>
</div>
<div class="paragraph">
<p>You can configure Foreman and Keycloak with two different authentication methods:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Users authenticate to Foreman using the Foreman web UI.</p>
</li>
<li>
<p>Users authenticate to Foreman using the Foreman CLI.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You must decide on how you want your users to authenticate in advance because both methods require different Foreman clients to be registered to Keycloak and configured.
The steps to register and configure Foreman client in Keycloak are distinguished within the procedure.</p>
</div>
<div class="paragraph">
<p>You can also register two different Foreman clients to Keycloak if you want to use both authentication methods and configure both clients accordingly.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Foreman server, install the following packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install mod_auth_openidc keycloak-httpd-client-install</pre>
</div>
</div>
</li>
<li>
<p>Register Foreman to Keycloak as a client.
Note that you the registration process for logging in using the web UI and the CLI are different.
You can register two clients Foreman clients to Keycloak to be able to log in to Foreman from the web UI and the CLI.</p>
<div class="ulist">
<ul>
<li>
<p>If you want you users to authenticate to Foreman using the web UI, create a client as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># keycloak-httpd-client-install --app-name foreman-openidc \
--keycloak-server-url "<em>https://Keycloak.example.com</em>" \
--keycloak-admin-username "<em>admin</em>" \
--keycloak-realm "<em>Foreman_Realm</em>" \
--keycloak-admin-realm master \
--keycloak-auth-role root-admin \
-t openidc -l /users/extlogin --force</pre>
</div>
</div>
<div class="paragraph">
<p>Enter the password for the administer account when prompted.
This command creates a client for Foreman in Keycloak.</p>
</div>
<div class="paragraph">
<p>Then, configure Foreman to use Keycloak as an authentication source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-keycloak true \
--foreman-keycloak-app-name "foreman-openidc" \
--foreman-keycloak-realm "<em>Foreman_Realm</em>"</pre>
</div>
</div>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, create a client as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># keycloak-httpd-client-install --app-name hammer-openidc \
--keycloak-server-url "<em>https://Keycloak.example.com</em>" \
--keycloak-admin-username "<em>admin</em>" \
--keycloak-realm "<em>Foreman_Realm</em>" \
--keycloak-admin-realm master \
--keycloak-auth-role root-admin \
-t openidc -l /users/extlogin --force</pre>
</div>
</div>
<div class="paragraph">
<p>Enter the password for the administer account when prompted.
This command creates a client for Foreman in Keycloak.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Restart the <code>httpd</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart httpd</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-the-foreman-client-in-keycloak_keycloak-general"><a class="anchor" href="#configuring-the-foreman-client-in-keycloak_keycloak-general"></a>5.9.3. Configuring the Foreman Client in Keycloak</h4>
<div class="paragraph">
<p>Use this procedure to configure the Foreman client in the Keycloak web UI and create group and audience mappers for the Foreman client.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Keycloak web UI, navigate to <strong>Clients</strong> and click the Foreman client.</p>
</li>
<li>
<p>Configure access type:</p>
<div class="ulist">
<ul>
<li>
<p>If you want your users to authenticate to Foreman using the Foreman web UI, from the <strong>Access Type</strong> list, select <strong>confidential</strong>.</p>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, from the <strong>Access Type</strong> list, select <strong>public</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In the <strong>Valid redirect URI</strong> fields, add a valid redirect URI.</p>
<div class="ulist">
<ul>
<li>
<p>If you want your users to authenticate to Foreman using the Foreman web UI, in the blank field below the existing URI, enter a URI in the form <code>https://foreman.example.com/users/extlogin</code>. Note that you must add the string <code>/users/extlogin</code> after the Foreman FQDN.</p>
<div class="paragraph">
<p>After completing this step, the Foreman client for logging in using the Foreman web UI must have the following <strong>Valid Redirect URIs</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://foreman.example.com/users/extlogin/redirect_uri
https://foreman.example.com/users/extlogin</pre>
</div>
</div>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, in the blank field below the existing URI, enter <strong>urn:ietf:wg:oauth:2.0:oob</strong>.</p>
<div class="paragraph">
<p>After completing this step, the Foreman client for logging in using the CLI must have the following <strong>Valid Redirect URIs</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://foreman.example.com/users/extlogin/redirect_uri
urn:ietf:wg:oauth:2.0:oob</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>Click the <strong>Mappers</strong> tab and click <strong>Create</strong> to add an audience mapper.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the audience mapper.</p>
</li>
<li>
<p>From the <strong>Mapper Type</strong> list, select <strong>Audience</strong>.</p>
</li>
<li>
<p>From the <strong>Included Client Audience</strong> list, select the Foreman client.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>Click <strong>Create</strong> to add a group mapper so that you can specify authorization in Foreman based on group membership.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the group mapper.</p>
</li>
<li>
<p>From the <strong>Mapper Type</strong> list, select <strong>Group Membership</strong>.</p>
</li>
<li>
<p>In the <strong>Token Claim Name</strong> field, enter <strong>groups</strong>.</p>
</li>
<li>
<p>Set the <strong>Full group path</strong> setting to OFF.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_Project_Settings_for_Keycloak_Authentication_keycloak-general"><a class="anchor" href="#Configuring_Project_Settings_for_Keycloak_Authentication_keycloak-general"></a>5.9.4. Configuring Foreman Settings for Keycloak Authentication</h4>
<div class="paragraph">
<p>Use this section to configure Foreman for Keycloak authentication using the Foreman web UI or the CLI.</p>
</div>
<div class="sect4">
<h5 id="configuring-foreman-settings-for-keycloak-authentication-using-the-web-ui_keycloak-general"><a class="anchor" href="#configuring-foreman-settings-for-keycloak-authentication-using-the-web-ui_keycloak-general"></a>Configuring Foreman Settings for Keycloak Authentication Using the Web UI</h5>
<div class="paragraph">
<p>Use this procedure to configure Foreman settings for Keycloak authentication using the Foreman web UI.</p>
</div>
<div class="paragraph">
<p>Note that you can navigate to the following URL within your realm to obtain values to configure Foreman settings: <code>https://Keycloak.example.com/auth/realms/Foreman_Realm/.well-known/openid-configuration</code></p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Ensure that the <strong>Access Type</strong> setting in the Foreman client in the Keycloak web UI is set to <strong>confidential</strong></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>, and click the <strong>Authentication</strong> tab.</p>
</li>
<li>
<p>Locate the <strong>Authorize login delegation</strong> row, and in the <strong>Value</strong> column, set the value to <strong>Yes</strong>.</p>
</li>
<li>
<p>Locate the <strong>Authorize login delegation auth source user autocreate</strong> row, and in the <strong>Value</strong> column,
set the value to <strong>External</strong>.</p>
</li>
<li>
<p>Locate the <strong>Login delegation logout URL</strong> row, and in the <strong>Value</strong> column, set the value to <strong>https://foreman.example.com/users/extlogout</strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC Algorithm</strong> row, and in the <strong>Value</strong> column, set the algorithm for encoding on Keycloak to <strong>RS256</strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC Audience</strong> row, and in the <strong>Value</strong> column, set the value to the client ID for Keycloak.</p>
</li>
<li>
<p>Locate the <strong>OIDC Issuer</strong> row, and in the <strong>Value</strong> column, set the value to <strong><em>https://Keycloak.example.com/auth/realms/Foreman_Realm</em></strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC JWKs URL</strong> row, and in the <strong>Value</strong> column, set the value to <strong><em>https://Keycloak.example.com/auth/realms/Foreman_Realm/protocol/openid-connect/certs</em></strong>.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Authentication Sources</strong> and click <strong>External</strong>.</p>
</li>
<li>
<p>Click <strong>Create LDAP Authentication Source</strong> and select the Keycloak server.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and add locations that can use the Keycloak authentication source.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and add organizations that can use the Keycloak authentication source.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="configuring-foreman-settings-for-keycloak-authentication-using-the-cli_keycloak-general"><a class="anchor" href="#configuring-foreman-settings-for-keycloak-authentication-using-the-cli_keycloak-general"></a>Configuring Foreman Settings for Keycloak Authentication Using the CLI</h5>
<div class="paragraph">
<p>Use this procedure to configure Foreman settings for Keycloak authentication using the Foreman CLI.</p>
</div>
<div class="paragraph">
<p>Note that you can navigate to the following URL within your realm to obtain values to configure Foreman settings: <code>https://Keycloak.example.com/auth/realms/Foreman_Realm/.well-known/openid-configuration</code></p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Ensure that the <strong>Access Type</strong> setting in the Foreman client in the Keycloak web UI is set to <strong>public</strong></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Foreman, set the login delegation to <code>true</code> so that users can authenticate using the Open IDC protocol:</p>
<div class="listingblock">
<div class="content">
<pre># hammer settings set --name authorize_login_delegation --value true</pre>
</div>
</div>
</li>
<li>
<p>Set the login delegation logout URL:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name login_delegation_logout_url \
--value https://foreman.example.com/users/extlogout</pre>
</div>
</div>
</li>
<li>
<p>Set the algorithm for encoding on Keycloak, for example, <code>RS256</code>:</p>
<div class="listingblock">
<div class="content">
<pre># hammer settings set --name oidc_algorithm --value 'RS256'</pre>
</div>
</div>
</li>
<li>
<p>Open the <code><em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_REALM</em>/.well-known/openid-configuration</code> URL and note the values to populate the options in the following steps.</p>
</li>
<li>
<p>Add the value for the Hammer client in the Open IDC audience:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_audience \
--value "['<em>foreman.example.com</em>-hammer-openidc']"</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you register several Keycloak clients to Foreman, ensure that you append all audiences in the array.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_audience \
--value "['<em>foreman.example.com</em>-foreman-openidc', '<em>foreman.example.com</em>-hammer-openidc']"</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Set the value for the Open IDC issuer:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_issuer \
--value "<em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_Realm</em>"</pre>
</div>
</div>
</li>
<li>
<p>Set the value for Open IDC Java Web Token (JWT):</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_jwks_url \
--value "<em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_Realm</em>/protocol/openid-connect/certs"</pre>
</div>
</div>
</li>
<li>
<p>Retrieve the ID of the Keycloak authentication source:</p>
<div class="listingblock">
<div class="content">
<pre># hammer auth-source external list</pre>
</div>
</div>
</li>
<li>
<p>Set the location and organization:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer auth-source external update --id <em>Authentication Source ID</em> \
--location-ids <em>Location ID</em> --organization-ids <em>Organization ID</em></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="logging-in-to-the-foreman-web-ui-using-keycloak_keycloak-general"><a class="anchor" href="#logging-in-to-the-foreman-web-ui-using-keycloak_keycloak-general"></a>5.9.5. Logging in to the Foreman web UI Using Keycloak</h4>
<div class="paragraph">
<p>Use this procedure to log in to the Foreman web UI using Keycloak.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>In your browser, log in to Foreman and enter your credentials.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="logging-in-to-the-foreman-cli-using-keycloak_keycloak-general"><a class="anchor" href="#logging-in-to-the-foreman-cli-using-keycloak_keycloak-general"></a>5.9.6. Logging in to the Foreman CLI Using Keycloak</h4>
<div class="paragraph">
<p>Use this procedure to authenticate to the Foreman CLI using the code grant type.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To authenticate to the Foreman CLI using the code grant type, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer auth login oauth \
--two-factor \
--oidc-token-endpoint 'https://<em>Keycloak.example.com</em>/auth/realms/ssl-realm/protocol/openid-connect/token' \
--oidc-authorization-endpoint 'https://<em>Keycloak.example.com</em>/auth' \
--oidc-client-id '<em>foreman.example.com</em>-foreman-openidc' \
--oidc-redirect-uri urn:ietf:wg:oauth:2.0:oob</pre>
</div>
</div>
<div class="paragraph">
<p>The command prompts you to enter a success code.</p>
</div>
</li>
<li>
<p>To retrieve the success code, navigate to the URL that the command returns and provide the required information.</p>
</li>
<li>
<p>Copy the success code that the web UI returns.</p>
</li>
<li>
<p>In the command prompt of <code>hammer auth login oauth</code>, enter the success code to authenticate to the Foreman CLI.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-group-mapping-for-keycloak-authentication_keycloak-general"><a class="anchor" href="#configuring-group-mapping-for-keycloak-authentication_keycloak-general"></a>5.9.7. Configuring Group Mapping for Keycloak Authentication</h4>
<div class="paragraph">
<p>Optionally, to implement the Role Based Access Control (RBAC), create a group in Foreman, assign a role to this group, and then map an Active Directory group to the Foreman group.
As a result, anyone in the given group in Keycloak are logged in under the corresponding Foreman group.
This example configures users of the Foreman-admin user group in the Active Directory to authenticate as users with administrator privileges on Foreman.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>User Groups</strong>, and click the <strong>Create User Group</strong> button.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the user group.
The name should not be the same as in the Active Directory.</p>
</li>
<li>
<p>Do not add users and user groups to the right-hand columns.
Click the <strong>Roles</strong> tab.</p>
</li>
<li>
<p>Select the <strong>Administer</strong> checkbox.</p>
</li>
<li>
<p>Click the <strong>External Groups</strong> tab.</p>
</li>
<li>
<p>Click <strong>Add external user group</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter the name of the Active Directory group.</p>
</li>
<li>
<p>From the list, select <strong>EXTERNAL</strong>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Keycloak_Authentication_with_TOTP_keycloak-totp"><a class="anchor" href="#Configuring_Keycloak_Authentication_with_TOTP_keycloak-totp"></a>5.10. Configuring Keycloak Authentication with TOTP</h3>
<div class="paragraph">
<p>Use this section to configure Foreman to use Keycloak as an OpenID provider for external authentication with TOTP cards.</p>
</div>
<div class="sect3">
<h4 id="prerequisites-for-integrating-foreman-with-keycloak_keycloak-totp"><a class="anchor" href="#prerequisites-for-integrating-foreman-with-keycloak_keycloak-totp"></a>5.10.1. Prerequisites for Configuring Foreman with Keycloak Authentication</h4>
<div class="paragraph">
<p>Before configuring Foreman with Keycloak external authentication, ensure that you meet the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A working installation of Keycloak server that uses HTTPS instead of HTTP.</p>
</li>
<li>
<p>A Keycloak account with admin privileges.</p>
</li>
<li>
<p>A realm for Foreman user accounts created in Keycloak.</p>
</li>
<li>
<p>If the certificates or the CA are self-signed, ensure that they are added to the end-user certificate trust store.</p>
</li>
<li>
<p>Users imported or added to Keycloak.</p>
<div class="paragraph">
<p>If you have an existing user database configured such as LDAP or Kerberos, you can import users from it by configuring user federation.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.4/html/server_administration_guide/user-storage-federation">User Storage Federation</a> in the <em>Red&#160;Hat Single Sign-On Server Administration Guide</em>.</p>
</div>
<div class="paragraph">
<p>If you do not have an existing user database configured, you can manually create users in Keycloak.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.4/html/server_administration_guide/user_management#create-new-user">Creating New Users</a> in the <em>Red&#160;Hat Single Sign-On Server Administration Guide</em>.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="registering-foreman-as-a-keycloak-client_keycloak-totp"><a class="anchor" href="#registering-foreman-as-a-keycloak-client_keycloak-totp"></a>5.10.2. Registering Foreman as a Keycloak Client</h4>
<div class="paragraph">
<p>Use this procedure to register Foreman to Keycloak as a client and configure Foreman to use Keycloak as an authentication source.</p>
</div>
<div class="paragraph">
<p>You can configure Foreman and Keycloak with two different authentication methods:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Users authenticate to Foreman using the Foreman web UI.</p>
</li>
<li>
<p>Users authenticate to Foreman using the Foreman CLI.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You must decide on how you want your users to authenticate in advance because both methods require different Foreman clients to be registered to Keycloak and configured.
The steps to register and configure Foreman client in Keycloak are distinguished within the procedure.</p>
</div>
<div class="paragraph">
<p>You can also register two different Foreman clients to Keycloak if you want to use both authentication methods and configure both clients accordingly.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Foreman server, install the following packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install mod_auth_openidc keycloak-httpd-client-install</pre>
</div>
</div>
</li>
<li>
<p>Register Foreman to Keycloak as a client.
Note that you the registration process for logging in using the web UI and the CLI are different.
You can register two clients Foreman clients to Keycloak to be able to log in to Foreman from the web UI and the CLI.</p>
<div class="ulist">
<ul>
<li>
<p>If you want you users to authenticate to Foreman using the web UI, create a client as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># keycloak-httpd-client-install --app-name foreman-openidc \
--keycloak-server-url "<em>https://Keycloak.example.com</em>" \
--keycloak-admin-username "<em>admin</em>" \
--keycloak-realm "<em>Foreman_Realm</em>" \
--keycloak-admin-realm master \
--keycloak-auth-role root-admin \
-t openidc -l /users/extlogin --force</pre>
</div>
</div>
<div class="paragraph">
<p>Enter the password for the administer account when prompted.
This command creates a client for Foreman in Keycloak.</p>
</div>
<div class="paragraph">
<p>Then, configure Foreman to use Keycloak as an authentication source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-keycloak true \
--foreman-keycloak-app-name "foreman-openidc" \
--foreman-keycloak-realm "<em>Foreman_Realm</em>"</pre>
</div>
</div>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, create a client as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># keycloak-httpd-client-install --app-name hammer-openidc \
--keycloak-server-url "<em>https://Keycloak.example.com</em>" \
--keycloak-admin-username "<em>admin</em>" \
--keycloak-realm "<em>Foreman_Realm</em>" \
--keycloak-admin-realm master \
--keycloak-auth-role root-admin \
-t openidc -l /users/extlogin --force</pre>
</div>
</div>
<div class="paragraph">
<p>Enter the password for the administer account when prompted.
This command creates a client for Foreman in Keycloak.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Restart the <code>httpd</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart httpd</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-the-foreman-client-in-keycloak_keycloak-totp"><a class="anchor" href="#configuring-the-foreman-client-in-keycloak_keycloak-totp"></a>5.10.3. Configuring the Foreman Client in Keycloak</h4>
<div class="paragraph">
<p>Use this procedure to configure the Foreman client in the Keycloak web UI and create group and audience mappers for the Foreman client.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Keycloak web UI, navigate to <strong>Clients</strong> and click the Foreman client.</p>
</li>
<li>
<p>Configure access type:</p>
<div class="ulist">
<ul>
<li>
<p>If you want your users to authenticate to Foreman using the Foreman web UI, from the <strong>Access Type</strong> list, select <strong>confidential</strong>.</p>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, from the <strong>Access Type</strong> list, select <strong>public</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In the <strong>Valid redirect URI</strong> fields, add a valid redirect URI.</p>
<div class="ulist">
<ul>
<li>
<p>If you want your users to authenticate to Foreman using the Foreman web UI, in the blank field below the existing URI, enter a URI in the form <code>https://foreman.example.com/users/extlogin</code>. Note that you must add the string <code>/users/extlogin</code> after the Foreman FQDN.</p>
<div class="paragraph">
<p>After completing this step, the Foreman client for logging in using the Foreman web UI must have the following <strong>Valid Redirect URIs</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://foreman.example.com/users/extlogin/redirect_uri
https://foreman.example.com/users/extlogin</pre>
</div>
</div>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, in the blank field below the existing URI, enter <strong>urn:ietf:wg:oauth:2.0:oob</strong>.</p>
<div class="paragraph">
<p>After completing this step, the Foreman client for logging in using the CLI must have the following <strong>Valid Redirect URIs</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://foreman.example.com/users/extlogin/redirect_uri
urn:ietf:wg:oauth:2.0:oob</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>Click the <strong>Mappers</strong> tab and click <strong>Create</strong> to add an audience mapper.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the audience mapper.</p>
</li>
<li>
<p>From the <strong>Mapper Type</strong> list, select <strong>Audience</strong>.</p>
</li>
<li>
<p>From the <strong>Included Client Audience</strong> list, select the Foreman client.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>Click <strong>Create</strong> to add a group mapper so that you can specify authorization in Foreman based on group membership.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the group mapper.</p>
</li>
<li>
<p>From the <strong>Mapper Type</strong> list, select <strong>Group Membership</strong>.</p>
</li>
<li>
<p>In the <strong>Token Claim Name</strong> field, enter <strong>groups</strong>.</p>
</li>
<li>
<p>Set the <strong>Full group path</strong> setting to OFF.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_Project_Settings_for_Keycloak_Authentication_keycloak-totp"><a class="anchor" href="#Configuring_Project_Settings_for_Keycloak_Authentication_keycloak-totp"></a>5.10.4. Configuring Foreman Settings for Keycloak Authentication</h4>
<div class="paragraph">
<p>Use this section to configure Foreman for Keycloak authentication using the Foreman web UI or the CLI.</p>
</div>
<div class="sect4">
<h5 id="configuring-foreman-settings-for-keycloak-authentication-using-the-web-ui_keycloak-totp"><a class="anchor" href="#configuring-foreman-settings-for-keycloak-authentication-using-the-web-ui_keycloak-totp"></a>Configuring Foreman Settings for Keycloak Authentication Using the Web UI</h5>
<div class="paragraph">
<p>Use this procedure to configure Foreman settings for Keycloak authentication using the Foreman web UI.</p>
</div>
<div class="paragraph">
<p>Note that you can navigate to the following URL within your realm to obtain values to configure Foreman settings: <code>https://Keycloak.example.com/auth/realms/Foreman_Realm/.well-known/openid-configuration</code></p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Ensure that the <strong>Access Type</strong> setting in the Foreman client in the Keycloak web UI is set to <strong>confidential</strong></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>, and click the <strong>Authentication</strong> tab.</p>
</li>
<li>
<p>Locate the <strong>Authorize login delegation</strong> row, and in the <strong>Value</strong> column, set the value to <strong>Yes</strong>.</p>
</li>
<li>
<p>Locate the <strong>Authorize login delegation auth source user autocreate</strong> row, and in the <strong>Value</strong> column,
set the value to <strong>External</strong>.</p>
</li>
<li>
<p>Locate the <strong>Login delegation logout URL</strong> row, and in the <strong>Value</strong> column, set the value to <strong>https://foreman.example.com/users/extlogout</strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC Algorithm</strong> row, and in the <strong>Value</strong> column, set the algorithm for encoding on Keycloak to <strong>RS256</strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC Audience</strong> row, and in the <strong>Value</strong> column, set the value to the client ID for Keycloak.</p>
</li>
<li>
<p>Locate the <strong>OIDC Issuer</strong> row, and in the <strong>Value</strong> column, set the value to <strong><em>https://Keycloak.example.com/auth/realms/Foreman_Realm</em></strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC JWKs URL</strong> row, and in the <strong>Value</strong> column, set the value to <strong><em>https://Keycloak.example.com/auth/realms/Foreman_Realm/protocol/openid-connect/certs</em></strong>.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Authentication Sources</strong> and click <strong>External</strong>.</p>
</li>
<li>
<p>Click <strong>Create LDAP Authentication Source</strong> and select the Keycloak server.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and add locations that can use the Keycloak authentication source.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and add organizations that can use the Keycloak authentication source.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="configuring-foreman-settings-for-keycloak-authentication-using-the-cli_keycloak-totp"><a class="anchor" href="#configuring-foreman-settings-for-keycloak-authentication-using-the-cli_keycloak-totp"></a>Configuring Foreman Settings for Keycloak Authentication Using the CLI</h5>
<div class="paragraph">
<p>Use this procedure to configure Foreman settings for Keycloak authentication using the Foreman CLI.</p>
</div>
<div class="paragraph">
<p>Note that you can navigate to the following URL within your realm to obtain values to configure Foreman settings: <code>https://Keycloak.example.com/auth/realms/Foreman_Realm/.well-known/openid-configuration</code></p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Ensure that the <strong>Access Type</strong> setting in the Foreman client in the Keycloak web UI is set to <strong>public</strong></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Foreman, set the login delegation to <code>true</code> so that users can authenticate using the Open IDC protocol:</p>
<div class="listingblock">
<div class="content">
<pre># hammer settings set --name authorize_login_delegation --value true</pre>
</div>
</div>
</li>
<li>
<p>Set the login delegation logout URL:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name login_delegation_logout_url \
--value https://foreman.example.com/users/extlogout</pre>
</div>
</div>
</li>
<li>
<p>Set the algorithm for encoding on Keycloak, for example, <code>RS256</code>:</p>
<div class="listingblock">
<div class="content">
<pre># hammer settings set --name oidc_algorithm --value 'RS256'</pre>
</div>
</div>
</li>
<li>
<p>Open the <code><em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_REALM</em>/.well-known/openid-configuration</code> URL and note the values to populate the options in the following steps.</p>
</li>
<li>
<p>Add the value for the Hammer client in the Open IDC audience:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_audience \
--value "['<em>foreman.example.com</em>-hammer-openidc']"</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you register several Keycloak clients to Foreman, ensure that you append all audiences in the array.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_audience \
--value "['<em>foreman.example.com</em>-foreman-openidc', '<em>foreman.example.com</em>-hammer-openidc']"</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Set the value for the Open IDC issuer:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_issuer \
--value "<em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_Realm</em>"</pre>
</div>
</div>
</li>
<li>
<p>Set the value for Open IDC Java Web Token (JWT):</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_jwks_url \
--value "<em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_Realm</em>/protocol/openid-connect/certs"</pre>
</div>
</div>
</li>
<li>
<p>Retrieve the ID of the Keycloak authentication source:</p>
<div class="listingblock">
<div class="content">
<pre># hammer auth-source external list</pre>
</div>
</div>
</li>
<li>
<p>Set the location and organization:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer auth-source external update --id <em>Authentication Source ID</em> \
--location-ids <em>Location ID</em> --organization-ids <em>Organization ID</em></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-foreman-with-keycloak-for-totp-authentication_keycloak-totp"><a class="anchor" href="#configuring-foreman-with-keycloak-for-totp-authentication_keycloak-totp"></a>5.10.5. Configuring Foreman with Keycloak for TOTP Authentication</h4>
<div class="paragraph">
<p>Use this procedure to configure Foreman to use Keycloak as an OpenID provider for external authentication with Time-based One-time Password (TOTP).</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Keycloak web UI, navigate to the Foreman realm.</p>
</li>
<li>
<p>Navigate to <strong>Authentication</strong>, and click the <strong>OTP Policy</strong> tab.</p>
</li>
<li>
<p>Ensure that the <strong>Supported Applications</strong> field includes FreeOTP or Google Authenticator.</p>
</li>
<li>
<p>Configure the OTP settings to suit your requirements.</p>
</li>
<li>
<p>Optional: If you want to use TOTP authentication as a default authentication method for all users, click the <strong>Flows</strong> tab, and to the right of the <strong>OTP Form</strong> setting, select <strong>REQUIRED</strong>.</p>
</li>
<li>
<p>Click the <strong>Required Actions</strong> tab.</p>
</li>
<li>
<p>To the right of the <strong>Configure OTP</strong> row, select the <strong>Default Action</strong> checkbox.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="logging-in-to-the-foreman-web-ui-using-keycloak-totp-authentication_keycloak-totp"><a class="anchor" href="#logging-in-to-the-foreman-web-ui-using-keycloak-totp-authentication_keycloak-totp"></a>5.10.6. Logging in to the Foreman web UI Using Keycloak TOTP Authentication</h4>
<div class="paragraph">
<p>Use this procedure to log in to the Foreman web UI using Keycloak TOTP authentication.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to Foreman, Foreman redirects you to the Keycloak login screen.</p>
</li>
<li>
<p>Enter your username and password, and click <strong>Log In</strong>.</p>
</li>
<li>
<p>The first attempt to log in, Keycloak requests you to configure your client by scanning the barcode and entering the pin displayed.</p>
</li>
<li>
<p>After you configure your client and enter a valid PIN, Keycloak redirects you to Foreman and
logs you in.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="logging-in-to-the-foreman-cli-using-keycloak_keycloak-totp"><a class="anchor" href="#logging-in-to-the-foreman-cli-using-keycloak_keycloak-totp"></a>5.10.7. Logging in to the Foreman CLI Using Keycloak</h4>
<div class="paragraph">
<p>Use this procedure to authenticate to the Foreman CLI using the code grant type.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To authenticate to the Foreman CLI using the code grant type, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer auth login oauth \
--two-factor \
--oidc-token-endpoint 'https://<em>Keycloak.example.com</em>/auth/realms/ssl-realm/protocol/openid-connect/token' \
--oidc-authorization-endpoint 'https://<em>Keycloak.example.com</em>/auth' \
--oidc-client-id '<em>foreman.example.com</em>-foreman-openidc' \
--oidc-redirect-uri urn:ietf:wg:oauth:2.0:oob</pre>
</div>
</div>
<div class="paragraph">
<p>The command prompts you to enter a success code.</p>
</div>
</li>
<li>
<p>To retrieve the success code, navigate to the URL that the command returns and provide the required information.</p>
</li>
<li>
<p>Copy the success code that the web UI returns.</p>
</li>
<li>
<p>In the command prompt of <code>hammer auth login oauth</code>, enter the success code to authenticate to the Foreman CLI.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-group-mapping-for-keycloak-authentication_keycloak-totp"><a class="anchor" href="#configuring-group-mapping-for-keycloak-authentication_keycloak-totp"></a>5.10.8. Configuring Group Mapping for Keycloak Authentication</h4>
<div class="paragraph">
<p>Optionally, to implement the Role Based Access Control (RBAC), create a group in Foreman, assign a role to this group, and then map an Active Directory group to the Foreman group.
As a result, anyone in the given group in Keycloak are logged in under the corresponding Foreman group.
This example configures users of the Foreman-admin user group in the Active Directory to authenticate as users with administrator privileges on Foreman.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>User Groups</strong>, and click the <strong>Create User Group</strong> button.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the user group.
The name should not be the same as in the Active Directory.</p>
</li>
<li>
<p>Do not add users and user groups to the right-hand columns.
Click the <strong>Roles</strong> tab.</p>
</li>
<li>
<p>Select the <strong>Administer</strong> checkbox.</p>
</li>
<li>
<p>Click the <strong>External Groups</strong> tab.</p>
</li>
<li>
<p>Click <strong>Add external user group</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter the name of the Active Directory group.</p>
</li>
<li>
<p>From the list, select <strong>EXTERNAL</strong>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_Keycloak_Authentication_with_CAC_Cards_keycloak-cac-cards"><a class="anchor" href="#Configuring_Keycloak_Authentication_with_CAC_Cards_keycloak-cac-cards"></a>5.11. Configuring Keycloak Authentication with PIV Cards</h3>
<div class="paragraph">
<p>Use this section to configure Foreman to use Keycloak as an OpenID provider for external authentication with PIV cards.</p>
</div>
<div class="sect3">
<h4 id="prerequisites-for-integrating-foreman-with-keycloak_keycloak-cac-cards"><a class="anchor" href="#prerequisites-for-integrating-foreman-with-keycloak_keycloak-cac-cards"></a>5.11.1. Prerequisites for Configuring Foreman with Keycloak Authentication</h4>
<div class="paragraph">
<p>Before configuring Foreman with Keycloak external authentication, ensure that you meet the following requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A working installation of Keycloak server that uses HTTPS instead of HTTP.</p>
</li>
<li>
<p>A Keycloak account with admin privileges.</p>
</li>
<li>
<p>A realm for Foreman user accounts created in Keycloak.</p>
</li>
<li>
<p>If the certificates or the CA are self-signed, ensure that they are added to the end-user certificate trust store.</p>
</li>
<li>
<p>Users imported or added to Keycloak.</p>
<div class="paragraph">
<p>If you have an existing user database configured such as LDAP or Kerberos, you can import users from it by configuring user federation.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.4/html/server_administration_guide/user-storage-federation">User Storage Federation</a> in the <em>Red&#160;Hat Single Sign-On Server Administration Guide</em>.</p>
</div>
<div class="paragraph">
<p>If you do not have an existing user database configured, you can manually create users in Keycloak.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.4/html/server_administration_guide/user_management#create-new-user">Creating New Users</a> in the <em>Red&#160;Hat Single Sign-On Server Administration Guide</em>.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="registering-foreman-as-a-keycloak-client_keycloak-cac-cards"><a class="anchor" href="#registering-foreman-as-a-keycloak-client_keycloak-cac-cards"></a>5.11.2. Registering Foreman as a Keycloak Client</h4>
<div class="paragraph">
<p>Use this procedure to register Foreman to Keycloak as a client and configure Foreman to use Keycloak as an authentication source.</p>
</div>
<div class="paragraph">
<p>You can configure Foreman and Keycloak with two different authentication methods:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Users authenticate to Foreman using the Foreman web UI.</p>
</li>
<li>
<p>Users authenticate to Foreman using the Foreman CLI.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You must decide on how you want your users to authenticate in advance because both methods require different Foreman clients to be registered to Keycloak and configured.
The steps to register and configure Foreman client in Keycloak are distinguished within the procedure.</p>
</div>
<div class="paragraph">
<p>You can also register two different Foreman clients to Keycloak if you want to use both authentication methods and configure both clients accordingly.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On the Foreman server, install the following packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install mod_auth_openidc keycloak-httpd-client-install</pre>
</div>
</div>
</li>
<li>
<p>Register Foreman to Keycloak as a client.
Note that you the registration process for logging in using the web UI and the CLI are different.
You can register two clients Foreman clients to Keycloak to be able to log in to Foreman from the web UI and the CLI.</p>
<div class="ulist">
<ul>
<li>
<p>If you want you users to authenticate to Foreman using the web UI, create a client as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># keycloak-httpd-client-install --app-name foreman-openidc \
--keycloak-server-url "<em>https://Keycloak.example.com</em>" \
--keycloak-admin-username "<em>admin</em>" \
--keycloak-realm "<em>Foreman_Realm</em>" \
--keycloak-admin-realm master \
--keycloak-auth-role root-admin \
-t openidc -l /users/extlogin --force</pre>
</div>
</div>
<div class="paragraph">
<p>Enter the password for the administer account when prompted.
This command creates a client for Foreman in Keycloak.</p>
</div>
<div class="paragraph">
<p>Then, configure Foreman to use Keycloak as an authentication source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-keycloak true \
--foreman-keycloak-app-name "foreman-openidc" \
--foreman-keycloak-realm "<em>Foreman_Realm</em>"</pre>
</div>
</div>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, create a client as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># keycloak-httpd-client-install --app-name hammer-openidc \
--keycloak-server-url "<em>https://Keycloak.example.com</em>" \
--keycloak-admin-username "<em>admin</em>" \
--keycloak-realm "<em>Foreman_Realm</em>" \
--keycloak-admin-realm master \
--keycloak-auth-role root-admin \
-t openidc -l /users/extlogin --force</pre>
</div>
</div>
<div class="paragraph">
<p>Enter the password for the administer account when prompted.
This command creates a client for Foreman in Keycloak.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Restart the <code>httpd</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart httpd</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-the-foreman-client-in-keycloak_keycloak-cac-cards"><a class="anchor" href="#configuring-the-foreman-client-in-keycloak_keycloak-cac-cards"></a>5.11.3. Configuring the Foreman Client in Keycloak</h4>
<div class="paragraph">
<p>Use this procedure to configure the Foreman client in the Keycloak web UI and create group and audience mappers for the Foreman client.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Keycloak web UI, navigate to <strong>Clients</strong> and click the Foreman client.</p>
</li>
<li>
<p>Configure access type:</p>
<div class="ulist">
<ul>
<li>
<p>If you want your users to authenticate to Foreman using the Foreman web UI, from the <strong>Access Type</strong> list, select <strong>confidential</strong>.</p>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, from the <strong>Access Type</strong> list, select <strong>public</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In the <strong>Valid redirect URI</strong> fields, add a valid redirect URI.</p>
<div class="ulist">
<ul>
<li>
<p>If you want your users to authenticate to Foreman using the Foreman web UI, in the blank field below the existing URI, enter a URI in the form <code>https://foreman.example.com/users/extlogin</code>. Note that you must add the string <code>/users/extlogin</code> after the Foreman FQDN.</p>
<div class="paragraph">
<p>After completing this step, the Foreman client for logging in using the Foreman web UI must have the following <strong>Valid Redirect URIs</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://foreman.example.com/users/extlogin/redirect_uri
https://foreman.example.com/users/extlogin</pre>
</div>
</div>
</li>
<li>
<p>If you want your users to authenticate to Foreman using the CLI, in the blank field below the existing URI, enter <strong>urn:ietf:wg:oauth:2.0:oob</strong>.</p>
<div class="paragraph">
<p>After completing this step, the Foreman client for logging in using the CLI must have the following <strong>Valid Redirect URIs</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">https://foreman.example.com/users/extlogin/redirect_uri
urn:ietf:wg:oauth:2.0:oob</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>Click the <strong>Mappers</strong> tab and click <strong>Create</strong> to add an audience mapper.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the audience mapper.</p>
</li>
<li>
<p>From the <strong>Mapper Type</strong> list, select <strong>Audience</strong>.</p>
</li>
<li>
<p>From the <strong>Included Client Audience</strong> list, select the Foreman client.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>Click <strong>Create</strong> to add a group mapper so that you can specify authorization in Foreman based on group membership.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the group mapper.</p>
</li>
<li>
<p>From the <strong>Mapper Type</strong> list, select <strong>Group Membership</strong>.</p>
</li>
<li>
<p>In the <strong>Token Claim Name</strong> field, enter <strong>groups</strong>.</p>
</li>
<li>
<p>Set the <strong>Full group path</strong> setting to OFF.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_Project_Settings_for_Keycloak_Authentication_keycloak-cac-cards"><a class="anchor" href="#Configuring_Project_Settings_for_Keycloak_Authentication_keycloak-cac-cards"></a>5.11.4. Configuring Foreman Settings for Keycloak Authentication</h4>
<div class="paragraph">
<p>Use this section to configure Foreman for Keycloak authentication using the Foreman web UI or the CLI.</p>
</div>
<div class="sect4">
<h5 id="configuring-foreman-settings-for-keycloak-authentication-using-the-web-ui_keycloak-cac-cards"><a class="anchor" href="#configuring-foreman-settings-for-keycloak-authentication-using-the-web-ui_keycloak-cac-cards"></a>Configuring Foreman Settings for Keycloak Authentication Using the Web UI</h5>
<div class="paragraph">
<p>Use this procedure to configure Foreman settings for Keycloak authentication using the Foreman web UI.</p>
</div>
<div class="paragraph">
<p>Note that you can navigate to the following URL within your realm to obtain values to configure Foreman settings: <code>https://Keycloak.example.com/auth/realms/Foreman_Realm/.well-known/openid-configuration</code></p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Ensure that the <strong>Access Type</strong> setting in the Foreman client in the Keycloak web UI is set to <strong>confidential</strong></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>, and click the <strong>Authentication</strong> tab.</p>
</li>
<li>
<p>Locate the <strong>Authorize login delegation</strong> row, and in the <strong>Value</strong> column, set the value to <strong>Yes</strong>.</p>
</li>
<li>
<p>Locate the <strong>Authorize login delegation auth source user autocreate</strong> row, and in the <strong>Value</strong> column,
set the value to <strong>External</strong>.</p>
</li>
<li>
<p>Locate the <strong>Login delegation logout URL</strong> row, and in the <strong>Value</strong> column, set the value to <strong>https://foreman.example.com/users/extlogout</strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC Algorithm</strong> row, and in the <strong>Value</strong> column, set the algorithm for encoding on Keycloak to <strong>RS256</strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC Audience</strong> row, and in the <strong>Value</strong> column, set the value to the client ID for Keycloak.</p>
</li>
<li>
<p>Locate the <strong>OIDC Issuer</strong> row, and in the <strong>Value</strong> column, set the value to <strong><em>https://Keycloak.example.com/auth/realms/Foreman_Realm</em></strong>.</p>
</li>
<li>
<p>Locate the <strong>OIDC JWKs URL</strong> row, and in the <strong>Value</strong> column, set the value to <strong><em>https://Keycloak.example.com/auth/realms/Foreman_Realm/protocol/openid-connect/certs</em></strong>.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Authentication Sources</strong> and click <strong>External</strong>.</p>
</li>
<li>
<p>Click <strong>Create LDAP Authentication Source</strong> and select the Keycloak server.</p>
</li>
<li>
<p>Click the <strong>Locations</strong> tab and add locations that can use the Keycloak authentication source.</p>
</li>
<li>
<p>Click the <strong>Organizations</strong> tab and add organizations that can use the Keycloak authentication source.</p>
</li>
<li>
<p>Click <strong>Submit</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="configuring-foreman-settings-for-keycloak-authentication-using-the-cli_keycloak-cac-cards"><a class="anchor" href="#configuring-foreman-settings-for-keycloak-authentication-using-the-cli_keycloak-cac-cards"></a>Configuring Foreman Settings for Keycloak Authentication Using the CLI</h5>
<div class="paragraph">
<p>Use this procedure to configure Foreman settings for Keycloak authentication using the Foreman CLI.</p>
</div>
<div class="paragraph">
<p>Note that you can navigate to the following URL within your realm to obtain values to configure Foreman settings: <code>https://Keycloak.example.com/auth/realms/Foreman_Realm/.well-known/openid-configuration</code></p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Ensure that the <strong>Access Type</strong> setting in the Foreman client in the Keycloak web UI is set to <strong>public</strong></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On Foreman, set the login delegation to <code>true</code> so that users can authenticate using the Open IDC protocol:</p>
<div class="listingblock">
<div class="content">
<pre># hammer settings set --name authorize_login_delegation --value true</pre>
</div>
</div>
</li>
<li>
<p>Set the login delegation logout URL:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name login_delegation_logout_url \
--value https://foreman.example.com/users/extlogout</pre>
</div>
</div>
</li>
<li>
<p>Set the algorithm for encoding on Keycloak, for example, <code>RS256</code>:</p>
<div class="listingblock">
<div class="content">
<pre># hammer settings set --name oidc_algorithm --value 'RS256'</pre>
</div>
</div>
</li>
<li>
<p>Open the <code><em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_REALM</em>/.well-known/openid-configuration</code> URL and note the values to populate the options in the following steps.</p>
</li>
<li>
<p>Add the value for the Hammer client in the Open IDC audience:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_audience \
--value "['<em>foreman.example.com</em>-hammer-openidc']"</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you register several Keycloak clients to Foreman, ensure that you append all audiences in the array.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_audience \
--value "['<em>foreman.example.com</em>-foreman-openidc', '<em>foreman.example.com</em>-hammer-openidc']"</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Set the value for the Open IDC issuer:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_issuer \
--value "<em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_Realm</em>"</pre>
</div>
</div>
</li>
<li>
<p>Set the value for Open IDC Java Web Token (JWT):</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer settings set --name oidc_jwks_url \
--value "<em>Keycloak.example.com</em>/auth/realms/<em>Keycloak_Realm</em>/protocol/openid-connect/certs"</pre>
</div>
</div>
</li>
<li>
<p>Retrieve the ID of the Keycloak authentication source:</p>
<div class="listingblock">
<div class="content">
<pre># hammer auth-source external list</pre>
</div>
</div>
</li>
<li>
<p>Set the location and organization:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer auth-source external update --id <em>Authentication Source ID</em> \
--location-ids <em>Location ID</em> --organization-ids <em>Organization ID</em></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-keycloak-settings-for-authentication-with-cac-cards_keycloak-cac-cards"><a class="anchor" href="#configuring-keycloak-settings-for-authentication-with-cac-cards_keycloak-cac-cards"></a>5.11.5. Configuring Keycloak Settings for Authentication With PIV Cards</h4>
<div class="paragraph">
<p>You must configure Keycloak settings for authentication with PIV cards.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Keycloak web UI, navigate to the <strong>Authentication</strong> tab.</p>
</li>
<li>
<p>From the <strong>Flows</strong> list, select <strong>Browser</strong>.</p>
</li>
<li>
<p>Click <strong>Copy</strong> to copy this flow.</p>
</li>
<li>
<p>In the <strong>Copy Authentication Flow</strong> window, enter a new name for the flow and click <strong>OK</strong>.</p>
</li>
<li>
<p>In the copied flow, delete <strong>Username Password Form</strong> and <strong>OTP Form</strong> entries.</p>
</li>
<li>
<p>Click <strong>Add execution</strong>.</p>
</li>
<li>
<p>From the <strong>Provider</strong> list, select <strong>X509/Validate Username Form</strong>.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>In the <strong>X509/Validate Username Form</strong> raw, select <strong>ALTERNATIVE</strong>.</p>
</li>
<li>
<p>In the <strong>X509/Validate Username Form</strong> raw, click <strong>Actions</strong> &gt; <strong>Config</strong>.</p>
</li>
<li>
<p>In the <strong>Alias</strong> field, enter a name for this configuration.</p>
</li>
<li>
<p>From the <strong>User Identity Source</strong> list, select <strong>Subject’s Common Name</strong>,</p>
</li>
<li>
<p>From the <strong>User mapping method</strong> list, select <strong>Username or Email</strong>.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>Navigate to <strong>Authentication</strong> &gt; <strong>Bindings</strong>.</p>
</li>
<li>
<p>From the <strong>Browser Flow</strong> list, select the created flow.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-users-os-for-keycloak-authentication-with-cac-cards_keycloak-cac-cards"><a class="anchor" href="#configuring-users-os-for-keycloak-authentication-with-cac-cards_keycloak-cac-cards"></a>5.11.6. Configuring Users' OS for Keycloak Authentication with PIV Cards</h4>
<div class="paragraph">
<p>Complete this procedure on each system from which you want to be able to log in to Foreman using Keycloak PIV cards.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install required packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">apt-get install opensc -y</pre>
</div>
</div>
</li>
<li>
<p>Install the Firefox browser if not installed.</p>
</li>
<li>
<p>Launch Firefox and navigate to <strong>Preferences</strong>.</p>
</li>
<li>
<p>Click the <strong>Privacy and Security</strong> tab.</p>
</li>
<li>
<p>Click <strong>Security Devices</strong>.</p>
</li>
<li>
<p>Click <strong>Load</strong>.</p>
</li>
<li>
<p>In the Load PKCS#11 Device Driver window, in the <strong>Module Name</strong> field, enter a name for this device.</p>
</li>
<li>
<p>In the <strong>Module filename</strong> field, enter <strong>/usr/lib64/pkcs11/opensc-pkcs11.so</strong>.</p>
</li>
<li>
<p>Click <strong>OK</strong>.</p>
</li>
<li>
<p>If the PIV card is connected to system, restart the <code>pcscd</code> service.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="logging-in-to-the-foreman-web-ui-using-keycloak-cac-cards_keycloak-cac-cards"><a class="anchor" href="#logging-in-to-the-foreman-web-ui-using-keycloak-cac-cards_keycloak-cac-cards"></a>5.11.7. Logging in to the Foreman web UI Using Keycloak PIV Cards</h4>
<div class="paragraph">
<p>Use this procedure to log in to the Foreman web UI using the Keycloak PIV cards.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In Firefox, log in to Foreman and enter your credentials.</p>
</li>
<li>
<p>When prompted, enter the PIN of the PIV card.</p>
</li>
<li>
<p>Choose the certificate for authentication.
Browser verifies this certificate with Keycloak.
Once authenticated, browser redirects you back to Foreman and logs you in.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="logging-in-to-the-foreman-cli-using-keycloak_keycloak-cac-cards"><a class="anchor" href="#logging-in-to-the-foreman-cli-using-keycloak_keycloak-cac-cards"></a>5.11.8. Logging in to the Foreman CLI Using Keycloak</h4>
<div class="paragraph">
<p>Use this procedure to authenticate to the Foreman CLI using the code grant type.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>To authenticate to the Foreman CLI using the code grant type, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hammer auth login oauth \
--two-factor \
--oidc-token-endpoint 'https://<em>Keycloak.example.com</em>/auth/realms/ssl-realm/protocol/openid-connect/token' \
--oidc-authorization-endpoint 'https://<em>Keycloak.example.com</em>/auth' \
--oidc-client-id '<em>foreman.example.com</em>-foreman-openidc' \
--oidc-redirect-uri urn:ietf:wg:oauth:2.0:oob</pre>
</div>
</div>
<div class="paragraph">
<p>The command prompts you to enter a success code.</p>
</div>
</li>
<li>
<p>To retrieve the success code, navigate to the URL that the command returns and provide the required information.</p>
</li>
<li>
<p>Copy the success code that the web UI returns.</p>
</li>
<li>
<p>In the command prompt of <code>hammer auth login oauth</code>, enter the success code to authenticate to the Foreman CLI.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-group-mapping-for-keycloak-authentication_keycloak-cac-cards"><a class="anchor" href="#configuring-group-mapping-for-keycloak-authentication_keycloak-cac-cards"></a>5.11.9. Configuring Group Mapping for Keycloak Authentication</h4>
<div class="paragraph">
<p>Optionally, to implement the Role Based Access Control (RBAC), create a group in Foreman, assign a role to this group, and then map an Active Directory group to the Foreman group.
As a result, anyone in the given group in Keycloak are logged in under the corresponding Foreman group.
This example configures users of the Foreman-admin user group in the Active Directory to authenticate as users with administrator privileges on Foreman.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>User Groups</strong>, and click the <strong>Create User Group</strong> button.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter a name for the user group.
The name should not be the same as in the Active Directory.</p>
</li>
<li>
<p>Do not add users and user groups to the right-hand columns.
Click the <strong>Roles</strong> tab.</p>
</li>
<li>
<p>Select the <strong>Administer</strong> checkbox.</p>
</li>
<li>
<p>Click the <strong>External Groups</strong> tab.</p>
</li>
<li>
<p>Click <strong>Add external user group</strong>.</p>
</li>
<li>
<p>In the <strong>Name</strong> field, enter the name of the Active Directory group.</p>
</li>
<li>
<p>From the list, select <strong>EXTERNAL</strong>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Disabling_Keycloak_Authentication_foreman"><a class="anchor" href="#Disabling_Keycloak_Authentication_foreman"></a>5.12. Disabling Keycloak Authentication</h3>
<div class="paragraph">
<p>If you want to disable Keycloak authentication in Foreman, complete this procedure.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Enter the following command to disable Keycloak Authentication:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --reset-foreman-keycloak</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-external-services"><a class="anchor" href="#configuring-external-services"></a>6. Configuring Foreman&#160;server with External Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you do not want to configure the DNS, DHCP, and TFTP services on Foreman&#160;server, use this section to configure your Foreman&#160;server to work with external DNS, DHCP and TFTP services.</p>
</div>
<div class="sect2">
<h3 id="configuring-external-dns_foreman"><a class="anchor" href="#configuring-external-dns_foreman"></a>6.1. Configuring Foreman&#160;server with External DNS</h3>
<div class="paragraph">
<p>You can configure Foreman&#160;server with external DNS.
Foreman&#160;server uses the <code>nsupdate</code> utility to update DNS records on the remote server.</p>
</div>
<div class="paragraph">
<p>To make any changes persistent, you must enter the <code>foreman-installer</code> command with the options appropriate for your environment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have a configured external DNS server.</p>
</li>
<li>
<p>This guide assumes you have an existing installation.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Copy the <code>/etc/rndc.key</code> file from the external DNS server to Foreman&#160;server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp root@<em>dns.example.com</em>:/etc/rndc.key /etc/foreman-proxy/rndc.key</pre>
</div>
</div>
</li>
<li>
<p>Configure the ownership, permissions, and SELinux context:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chown -v root:foreman-proxy /etc/foreman-proxy/rndc.key
# chmod -v 640 /etc/foreman-proxy/rndc.key</pre>
</div>
</div>
</li>
<li>
<p>To test the <code>nsupdate</code> utility, add a host remotely:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># echo -e "server <em>DNS_IP_Address</em>\n \
update add aaa.example.com 3600 IN A <em>Host_IP_Address</em>\n \
send\n" | nsupdate -k /etc/foreman-proxy/rndc.key
# nslookup aaa.example.com <em>DNS_IP_Address</em>
# echo -e "server <em>DNS_IP_Address</em>\n \
update delete aaa.example.com 3600 IN A <em>Host_IP_Address</em>\n \
send\n" | nsupdate -k /etc/foreman-proxy/rndc.key</pre>
</div>
</div>
</li>
<li>
<p>Enter the <code>foreman-installer</code> command to make the following persistent changes to the <code>/etc/foreman-proxy/settings.d/dns.yml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-dns=true \
--foreman-proxy-dns-managed=false \
--foreman-proxy-dns-provider=nsupdate \
--foreman-proxy-dns-server="<em>DNS_IP_Address</em>" \
--foreman-proxy-keyfile=/etc/foreman-proxy/rndc.key</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong>.</p>
</li>
<li>
<p>Locate the Foreman&#160;server and select <strong>Refresh</strong> from the list in the <strong>Actions</strong> column.</p>
</li>
<li>
<p>Associate the DNS service with the appropriate subnets and domain.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-external-dhcp_foreman"><a class="anchor" href="#configuring-external-dhcp_foreman"></a>6.2. Configuring Foreman&#160;server with External DHCP</h3>
<div class="paragraph">
<p>To configure Foreman&#160;server with external DHCP, you must complete the following procedures:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#configuring-an-external-dhcp-server_foreman">Configuring an External DHCP Server to Use with Foreman&#160;server</a></p>
</li>
<li>
<p><a href="#Configuring_Server_with_an_External_DHCP_Server_foreman">Configuring Foreman&#160;server with an External DHCP Server</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="configuring-an-external-dhcp-server_foreman"><a class="anchor" href="#configuring-an-external-dhcp-server_foreman"></a>6.2.1. Configuring an External DHCP Server to Use with Foreman&#160;server</h4>
<div class="paragraph">
<p>To configure an external DHCP server running Enterprise Linux to use with Foreman&#160;server, you must install the ISC DHCP Service and Berkeley Internet Name Domain (BIND) packages.
You must also share the DHCP configuration and lease files with Foreman&#160;server.
The example in this procedure uses the distributed Network File System (NFS) protocol to share the DHCP configuration and lease files.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you use dnsmasq as an external DHCP server, enable the <code>dhcp-no-override</code> setting.
This is required because Foreman creates configuration files on the TFTP server under the <code>grub2/</code> subdirectory.
If the <code>dhcp-no-override</code> setting is disabled, clients fetch the bootloader and its configuration from the root directory, which might cause an error.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you do not use <code>firewall-cmd</code> to configure the Linux firewall, implement using the command of your choice.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>On your Enterprise Linux host, install the ISC DHCP Service and Berkeley Internet Name Domain (BIND) packages:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install dhcp bind</pre>
</div>
</div>
</li>
<li>
<p>Generate a security token:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># dnssec-keygen -a HMAC-MD5 -b 512 -n HOST omapi_key</pre>
</div>
</div>
<div class="paragraph">
<p>As a result, a key pair that consists of two files is created in the current directory.</p>
</div>
</li>
<li>
<p>Copy the secret hash from the key:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat Komapi_key.+*.private |grep ^Key|cut -d ' ' -f2</pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>dhcpd</code> configuration file for all of the subnets and add the key.
The following is an example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/dhcp/dhcpd.conf
default-lease-time 604800;
max-lease-time 2592000;
log-facility local7;

subnet <em>192.168.38.0</em> netmask <em>255.255.255.0</em> {
	range <em>192.168.38.10 192.168.38.100</em>;
	option routers <em>192.168.38.1</em>;
	option subnet-mask <em>255.255.255.0</em>;
	option domain-search "<em>virtual.lan</em>";
	option domain-name "<em>virtual.lan</em>";
	option domain-name-servers <em>8.8.8.8</em>;
}

omapi-port 7911;
key omapi_key {
	algorithm HMAC-MD5;
	secret "jNSE5YI3H1A8Oj/tkV4...A2ZOHb6zv315CkNAY7DMYYCj48Umw==";
};
omapi-key omapi_key;</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>option routers</code> value is the Foreman or Smart&#160;Proxy IP address that you want to use with an external DHCP service.</p>
</div>
</li>
<li>
<p>Delete the two key files from the directory that they were created in.</p>
</li>
<li>
<p>On Foreman&#160;server, define each subnet.
Do not set DHCP Smart&#160;Proxy for the defined Subnet yet.</p>
<div class="paragraph">
<p>To prevent conflicts, set up the lease and reservation ranges separately.
For example, if the lease range is 192.168.38.10 to 192.168.38.100, in the Foreman web UI define the reservation range as 192.168.38.101 to 192.168.38.250.</p>
</div>
</li>
<li>
<p>Configure the firewall for external access to the DHCP server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># firewall-cmd --add-service dhcp \
&amp;&amp; firewall-cmd --runtime-to-permanent</pre>
</div>
</div>
</li>
<li>
<p>On Foreman&#160;server, determine the UID and GID of the <code>foreman</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># id -u foreman
<em>993</em>
# id -g foreman
<em>990</em></pre>
</div>
</div>
</li>
<li>
<p>On the DHCP server, create the <code>foreman</code> user and group with the same IDs as determined in a previous step:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># groupadd -g <em>990</em> foreman
# useradd -u <em>993</em> -g <em>990</em> -s /sbin/nologin foreman</pre>
</div>
</div>
</li>
<li>
<p>To ensure that the configuration files are accessible, restore the read and execute flags:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chmod o+rx /etc/dhcp/
# chmod o+r /etc/dhcp/dhcpd.conf
# chattr +i /etc/dhcp/ /etc/dhcp/dhcpd.conf</pre>
</div>
</div>
</li>
<li>
<p>Enable and start the DHCP service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl enable --now dhcpd</pre>
</div>
</div>
</li>
<li>
<p>Export the DHCP configuration and lease files using NFS:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install nfs-kernel-server
# systemctl enable --now nfs-server</pre>
</div>
</div>
</li>
<li>
<p>Create directories for the DHCP configuration and lease files that you want to export using NFS:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir -p /exports/var/lib/dhcpd /exports/etc/dhcp</pre>
</div>
</div>
</li>
<li>
<p>To create mount points for the created directories, add the following line to the <code>/etc/fstab</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">/var/lib/dhcpd /exports/var/lib/dhcpd none bind,auto 0 0
/etc/dhcp /exports/etc/dhcp none bind,auto 0 0</pre>
</div>
</div>
</li>
<li>
<p>Mount the file systems in <code>/etc/fstab</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mount -a</pre>
</div>
</div>
</li>
<li>
<p>Ensure the following lines are present in <code>/etc/exports</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">/exports <em>192.168.38.1</em>(rw,async,no_root_squash,fsid=0,no_subtree_check)

/exports/etc/dhcp <em>192.168.38.1</em>(ro,async,no_root_squash,no_subtree_check,nohide)

/exports/var/lib/dhcpd <em>192.168.38.1</em>(ro,async,no_root_squash,no_subtree_check,nohide)</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the IP address that you enter is the Foreman or Smart&#160;Proxy IP address that you want to use with an external DHCP service.</p>
</div>
</li>
<li>
<p>Reload the NFS server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># exportfs -rva</pre>
</div>
</div>
</li>
<li>
<p>Configure the firewall for the DHCP omapi port 7911:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># firewall-cmd --add-port="7911/tcp" \
&amp;&amp; firewall-cmd --runtime-to-permanent</pre>
</div>
</div>
</li>
<li>
<p>Optional: Configure the firewall for external access to NFS.
Clients are configured using NFSv3.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># firewall-cmd --zone public --add-service mountd \
&amp;&amp; firewall-cmd --zone public --add-service rpc-bind \
&amp;&amp; firewall-cmd --zone public --add-service nfs \
&amp;&amp; firewall-cmd --runtime-to-permanent</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="Configuring_Server_with_an_External_DHCP_Server_foreman"><a class="anchor" href="#Configuring_Server_with_an_External_DHCP_Server_foreman"></a>6.2.2. Configuring Foreman&#160;server with an External DHCP Server</h4>
<div class="paragraph">
<p>You can configure Foreman&#160;server with an external DHCP server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisite</div>
<ul>
<li>
<p>Ensure that you have configured an external DHCP server and that you have shared the DHCP configuration and lease files with Foreman&#160;server.
For more information, see <a href="#configuring-an-external-dhcp-server_foreman">Configuring an External DHCP Server to Use with Foreman&#160;server</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install the <code>nfs-common</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install nfs-common</pre>
</div>
</div>
</li>
<li>
<p>Create the DHCP directories for NFS:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir -p /mnt/nfs/etc/dhcp /mnt/nfs/var/lib/dhcpd</pre>
</div>
</div>
</li>
<li>
<p>Change the file owner:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chown -R foreman-proxy /mnt/nfs</pre>
</div>
</div>
</li>
<li>
<p>Verify communication with the NFS server and the Remote Procedure Call (RPC) communication paths:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># showmount -e <em>DHCP_Server_FQDN</em>
# rpcinfo -p <em>DHCP_Server_FQDN</em></pre>
</div>
</div>
</li>
<li>
<p>Add the following lines to the <code>/etc/fstab</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"><em>DHCP_Server_FQDN</em>:/exports/etc/dhcp /mnt/nfs/etc/dhcp nfs
ro,vers=3,auto,nosharecache,context="system_u:object_r:dhcp_etc_t:s0" 0 0

<em>DHCP_Server_FQDN</em>:/exports/var/lib/dhcpd /mnt/nfs/var/lib/dhcpd nfs
ro,vers=3,auto,nosharecache,context="system_u:object_r:dhcpd_state_t:s0" 0 0</pre>
</div>
</div>
</li>
<li>
<p>Mount the file systems on <code>/etc/fstab</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mount -a</pre>
</div>
</div>
</li>
<li>
<p>To verify that the <code>foreman-proxy</code> user can access the files that are shared over the network, display the DHCP configuration and lease files:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># su foreman-proxy -s /bin/bash
bash-4.2$ cat /mnt/nfs/etc/dhcp/dhcpd.conf
bash-4.2$ cat /mnt/nfs/var/lib/dhcpd/dhcpd.leases
bash-4.2$ exit</pre>
</div>
</div>
</li>
<li>
<p>Enter the <code>foreman-installer</code> command to make the following persistent changes to the <code>/etc/foreman-proxy/settings.d/dhcp.yml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-dhcp=true \
--foreman-proxy-dhcp-provider=remote_isc \
--foreman-proxy-plugin-dhcp-remote-isc-dhcp-config /mnt/nfs/etc/dhcp/dhcpd.conf \
--foreman-proxy-plugin-dhcp-remote-isc-dhcp-leases /mnt/nfs/var/lib/dhcpd/dhcpd.leases \
--foreman-proxy-plugin-dhcp-remote-isc-key-name=omapi_key \
--foreman-proxy-plugin-dhcp-remote-isc-key-secret=jNSE5YI3H1A8Oj/tkV4...A2ZOHb6zv315CkNAY7DMYYCj48Umw== \
--foreman-proxy-plugin-dhcp-remote-isc-omapi-port=7911 \
--enable-foreman-proxy-plugin-dhcp-remote-isc \
--foreman-proxy-dhcp-server=<em>DHCP_Server_FQDN</em></pre>
</div>
</div>
</li>
<li>
<p>Associate the DHCP service with the appropriate subnets and domain.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-external-tftp_foreman"><a class="anchor" href="#configuring-external-tftp_foreman"></a>6.3. Configuring Foreman&#160;server with External TFTP</h3>
<div class="paragraph">
<p>You can configure Foreman&#160;server with external TFTP services.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the TFTP directory for NFS:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir -p /mnt/nfs/var/lib/tftpboot</pre>
</div>
</div>
</li>
<li>
<p>In the <code>/etc/fstab</code> file, add the following line:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"><em>TFTP_Server_IP_Address</em>:/exports/var/lib/tftpboot /mnt/nfs/var/lib/tftpboot nfs rw,vers=3,auto,nosharecache,context="system_u:object_r:tftpdir_rw_t:s0" 0 0</pre>
</div>
</div>
</li>
<li>
<p>Mount the file systems in <code>/etc/fstab</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mount -a</pre>
</div>
</div>
</li>
<li>
<p>Enter the <code>foreman-installer</code> command to make the following persistent changes to the <code>/etc/foreman-proxy/settings.d/tftp.yml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-tftp=true \
--foreman-proxy-tftp-root /mnt/nfs/var/lib/tftpboot</pre>
</div>
</div>
</li>
<li>
<p>If the TFTP service is running on a different server than the DHCP service, update the <code>tftp_servername</code> setting with the FQDN or IP address of the server that the TFTP service is running on:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-tftp-servername=<em>TFTP_Server_FQDN</em></pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong>.</p>
</li>
<li>
<p>Locate the Foreman&#160;server and select <strong>Refresh</strong> from the list in the <strong>Actions</strong> column.</p>
</li>
<li>
<p>Associate the TFTP service with the appropriate subnets and domain.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-external-idm-dns_foreman"><a class="anchor" href="#configuring-external-idm-dns_foreman"></a>6.4. Configuring Foreman&#160;server with External IdM DNS</h3>
<div class="paragraph">
<p>When Foreman&#160;server adds a DNS record for a host, it first determines which Smart&#160;Proxy is providing DNS for that domain.
It then communicates with the Smart&#160;Proxy that is configured to provide DNS service for your deployment and adds the record.
The hosts are not involved in this process.
Therefore, you must install and configure the IdM client on the Foreman or Smart&#160;Proxy that is currently configured to provide a DNS service for the domain you want to manage using the IdM server.</p>
</div>
<div class="paragraph">
<p>Foreman&#160;server can be configured to use a Red&#160;Hat Identity Management (IdM) server to provide DNS service.
For more information about Red&#160;Hat Identity Management, see the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/linux_domain_identity_authentication_and_policy_guide/">Linux Domain Identity, Authentication, and Policy Guide</a>.</p>
</div>
<div class="paragraph">
<p>To configure Foreman&#160;server to use a Red&#160;Hat Identity Management (IdM) server to provide DNS service, use one of the following procedures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#configuring-dynamic-dns-update-with-gss-tsig-authentication_foreman">Configuring Dynamic DNS Update with GSS-TSIG Authentication</a></p>
</li>
<li>
<p><a href="#configuring-dynamic-dns-update-with-tsig-authentication_foreman">Configuring Dynamic DNS Update with TSIG Authentication</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To revert to internal DNS service, use the following procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#reverting-to-internal-dns-service_foreman">Reverting to Internal DNS Service</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You are not required to use Foreman&#160;server to manage DNS.
When you are using the realm enrollment feature of Foreman, where provisioned hosts are enrolled automatically to IdM, the <code>ipa-client-install</code> script creates DNS records for the client.
Configuring Foreman&#160;server with external IdM DNS and realm enrollment are mutually exclusive.
For more information about configuring realm enrollment, see
<a href="#External_Authentication_for_Provisioned_Hosts_foreman">External Authentication for Provisioned Hosts</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="configuring-dynamic-dns-update-with-gss-tsig-authentication_foreman"><a class="anchor" href="#configuring-dynamic-dns-update-with-gss-tsig-authentication_foreman"></a>6.4.1. Configuring Dynamic DNS Update with GSS-TSIG Authentication</h4>
<div class="paragraph">
<p>You can configure the IdM server to use the generic security service algorithm for secret key transaction (GSS-TSIG) technology defined in <a href="https://tools.ietf.org/html/rfc3645">RFC3645</a>.
To configure the IdM server to use the GSS-TSIG technology, you must install the IdM client on the Foreman&#160;server base operating system.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must ensure the IdM server is deployed and the host-based firewall is configured correctly.</p>
</li>
<li>
<p>You must contact the IdM server administrator to ensure that you obtain an account on the IdM server with permissions to create zones on the IdM server.</p>
</li>
<li>
<p>You should create a backup of the answer file.
You can use the backup to restore the answer file to its original state if it becomes corrupted.
For more information, see <a href="https://docs.theforeman.org/3.7/Installing_Server/index-foreman-deb.html#configuring-server_foreman">Configuring Foreman&#160;server</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To configure dynamic DNS update with GSS-TSIG authentication, complete the following steps:</p>
</div>
<div class="olist arabic">
<div class="title">Creating a Kerberos Principal on the IdM Server</div>
<ol class="arabic">
<li>
<p>Obtain a Kerberos ticket for the account obtained from the IdM administrator:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># kinit <em>idm_user</em></pre>
</div>
</div>
</li>
<li>
<p>Create a new Kerberos principal for Foreman&#160;server to use to authenticate on the IdM server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa service-add <em>smart-proxy/foreman.example.com</em></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Installing and Configuring the IdM Client</div>
<ol class="arabic">
<li>
<p>On the base operating system of either the Foreman or Smart&#160;Proxy that is managing the DNS service for your deployment, install the <code>ipa-client</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install ipa-client</pre>
</div>
</div>
</li>
<li>
<p>Configure the IdM client by running the installation script and following the on-screen prompts:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa-client-install</pre>
</div>
</div>
</li>
<li>
<p>Obtain a Kerberos ticket:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># kinit admin</pre>
</div>
</div>
</li>
<li>
<p>Remove any preexisting <code>keytab</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rm /etc/foreman-proxy/dns.keytab</pre>
</div>
</div>
</li>
<li>
<p>Obtain the <code>keytab</code> for this system:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># ipa-getkeytab -p smart-proxy/<em>foreman.example.com@EXAMPLE.COM</em> \
-s <em>idm1.example.com</em> -k /etc/foreman-proxy/dns.keytab</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>When adding a keytab to a standby system with the same host name as the original system in service, add the <code>r</code> option to prevent generating new credentials and rendering the credentials on the original system invalid.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>For the <code>dns.keytab</code> file, set the group and owner to <code>foreman-proxy</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># chown foreman-proxy:foreman-proxy /etc/foreman-proxy/dns.keytab</pre>
</div>
</div>
</li>
<li>
<p>Optional: To verify that the <code>keytab</code> file is valid, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># kinit -kt /etc/foreman-proxy/dns.keytab \
smart-proxy/<em>foreman.example.com@EXAMPLE.COM</em></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Configuring DNS Zones in the IdM web UI</div>
<ol class="arabic">
<li>
<p>Create and configure the zone that you want to manage:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Network Services</strong> &gt; <strong>DNS</strong> &gt; <strong>DNS Zones</strong>.</p>
</li>
<li>
<p>Select <strong>Add</strong> and enter the zone name.
For example, <code>example.com</code>.</p>
</li>
<li>
<p>Click <strong>Add and Edit</strong>.</p>
</li>
<li>
<p>Click the Settings tab and in the <strong>BIND update policy</strong> box, add the following to the semi-colon separated list:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">grant smart-proxy/047<em>foreman.example.com@EXAMPLE.COM</em> wildcard * ANY;</pre>
</div>
</div>
</li>
<li>
<p>Set <strong>Dynamic update</strong> to <strong>True</strong>.</p>
</li>
<li>
<p>Enable <strong>Allow PTR sync</strong>.</p>
</li>
<li>
<p>Click <strong>Save</strong> to save the changes.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create and configure the reverse zone:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Network Services</strong> &gt; <strong>DNS</strong> &gt; <strong>DNS Zones</strong>.</p>
</li>
<li>
<p>Click <strong>Add</strong>.</p>
</li>
<li>
<p>Select <strong>Reverse zone IP network</strong> and add the network address in CIDR format to enable reverse lookups.</p>
</li>
<li>
<p>Click <strong>Add and Edit</strong>.</p>
</li>
<li>
<p>Click the <strong>Settings</strong> tab and in the <strong>BIND update policy</strong> box, add the following to the semi-colon separated list:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">grant smart-proxy\047<em>foreman.example.com@EXAMPLE.COM</em> wildcard * ANY;</pre>
</div>
</div>
</li>
<li>
<p>Set <strong>Dynamic update</strong> to <strong>True</strong>.</p>
</li>
<li>
<p>Click <strong>Save</strong> to save the changes.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Configuring the Foreman or Smart&#160;Proxy&#160;Server that Manages the DNS Service for the Domain</div>
<ol class="arabic">
<li>
<p>Use the <code>foreman-installer</code> command to configure the Foreman or Smart&#160;Proxy that manages the DNS Service for the domain:</p>
<div class="ulist">
<ul>
<li>
<p>On Foreman, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">foreman-installer \
--foreman-proxy-dns=true \
--foreman-proxy-dns-managed=false \
--foreman-proxy-dns-provider=nsupdate_gss \
--foreman-proxy-dns-server="<em>idm1.example.com</em>" \
--foreman-proxy-dns-tsig-principal="smart-proxy/<em>foreman.example.com@EXAMPLE.COM</em>" \
--foreman-proxy-dns-tsig-keytab=/etc/foreman-proxy/dns.keytab</pre>
</div>
</div>
</li>
<li>
<p>On Smart&#160;Proxy, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">foreman-installer --no-enable-foreman --no-enable-foreman-plugin-puppet --no-enable-foreman-cli --no-enable-foreman-cli-puppet \
--foreman-proxy-dns=true \
--foreman-proxy-dns-managed=false \
--foreman-proxy-dns-provider=nsupdate_gss \
--foreman-proxy-dns-server="<em>idm1.example.com</em>" \
--foreman-proxy-dns-tsig-principal="smart-proxy/<em>foreman.example.com@EXAMPLE.COM</em>" \
--foreman-proxy-dns-tsig-keytab=/etc/foreman-proxy/dns.keytab</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After you run the <code>foreman-installer</code> command to make any changes to your Smart&#160;Proxy configuration, you must update the configuration of each affected Smart&#160;Proxy in the Foreman web UI.</p>
</div>
<div class="olist arabic">
<div class="title">Updating the Configuration in the Foreman web UI</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong>, locate the Foreman&#160;server, and from the list in the <strong>Actions</strong> column, select <strong>Refresh</strong>.</p>
</li>
<li>
<p>Configure the domain:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Domains</strong> and select the domain name.</p>
</li>
<li>
<p>In the <strong>Domain</strong> tab, ensure <strong>DNS Smart&#160;Proxy</strong> is set to the Smart&#160;Proxy where the subnet is connected.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the subnet:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong> and select the subnet name.</p>
</li>
<li>
<p>In the <strong>Subnet</strong> tab, set <strong>IPAM</strong> to <strong>None</strong>.</p>
</li>
<li>
<p>In the <strong>Domains</strong> tab, select the domain that you want to manage using the IdM server.</p>
</li>
<li>
<p>In the <strong>Smart&#160;Proxies</strong> tab, ensure <strong>Reverse DNS Smart&#160;Proxy</strong> is set to the Smart&#160;Proxy where the subnet is connected.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="configuring-dynamic-dns-update-with-tsig-authentication_foreman"><a class="anchor" href="#configuring-dynamic-dns-update-with-tsig-authentication_foreman"></a>6.4.2. Configuring Dynamic DNS Update with TSIG Authentication</h4>
<div class="paragraph">
<p>You can configure an IdM server to use the secret key transaction authentication for DNS (TSIG) technology that uses the <code>rndc.key</code> key file for authentication.
The TSIG protocol is defined in <a href="https://tools.ietf.org/html/rfc2845">RFC2845</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must ensure the IdM server is deployed and the host-based firewall is configured correctly.
For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/linux_domain_identity_authentication_and_policy_guide/installing-ipa#prereq-ports">Port Requirements</a> in the <em>Linux Domain Identity, Authentication, and Policy Guide</em>.</p>
</li>
<li>
<p>You must obtain <code>root</code> user access on the IdM server.</p>
</li>
<li>
<p>You must confirm whether Foreman&#160;server or Smart&#160;Proxy&#160;server is configured to provide DNS service for your deployment.</p>
</li>
<li>
<p>You must configure DNS, DHCP and TFTP services on the base operating system of either the Foreman or Smart&#160;Proxy that is managing the DNS service for your deployment.</p>
</li>
<li>
<p>You must create a backup of the answer file.
You can use the backup to restore the answer file to its original state if it becomes corrupted.
For more information, see <a href="https://docs.theforeman.org/3.7/Installing_Server/index-foreman-deb.html#configuring-server_foreman">Configuring Foreman&#160;server</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To configure dynamic DNS update with TSIG authentication, complete the following steps:</p>
</div>
<div class="olist arabic">
<div class="title">Enabling External Updates to the DNS Zone in the IdM Server</div>
<ol class="arabic">
<li>
<p>On the IdM Server, add the following to the top of the <code>/etc/named.conf</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">########################################################################

include "/etc/rndc.key";
controls  {
inet _IdM_Server_IP_Address_ port 953 allow { _Foreman_IP_Address_; } keys { "rndc-key"; };
};
########################################################################</pre>
</div>
</div>
</li>
<li>
<p>Reload the <code>named</code> service to make the changes take effect:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl reload named</pre>
</div>
</div>
</li>
<li>
<p>In the IdM web UI, navigate to <strong>Network Services</strong> &gt; <strong>DNS</strong> &gt; <strong>DNS Zones</strong> and click the name of the zone.
In the <strong>Settings</strong> tab, apply the following changes:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the following in the <code>BIND update policy</code> box:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">grant "rndc-key" zonesub ANY;</pre>
</div>
</div>
</li>
<li>
<p>Set <strong>Dynamic update</strong> to <strong>True</strong>.</p>
</li>
<li>
<p>Click <strong>Update</strong> to save the changes.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Copy the <code>/etc/rndc.key</code> file from the IdM server to the base operating system of your Foreman&#160;server.
Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp /etc/rndc.key root@<em>foreman.example.com</em>:/etc/rndc.key</pre>
</div>
</div>
</li>
<li>
<p>To set the correct ownership, permissions, and SELinux context for the <code>rndc.key</code> file, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># restorecon -v /etc/rndc.key
# chown -v root:named /etc/rndc.key
# chmod -v 640 /etc/rndc.key</pre>
</div>
</div>
</li>
<li>
<p>Assign the <code>foreman-proxy</code> user to the <code>named</code> group manually.
Normally, foreman-installer ensures that the <code>foreman-proxy</code> user belongs to the <code>named</code> UNIX group, however, in this scenario Foreman does not manage users and groups, therefore you need to assign the <code>foreman-proxy</code> user to the <code>named</code> group manually.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># usermod -a -G named foreman-proxy</pre>
</div>
</div>
</li>
<li>
<p>On Foreman&#160;server, enter the following <code>foreman-installer</code> command to configure Foreman to use the external DNS server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer \
--foreman-proxy-dns=true \
--foreman-proxy-dns-managed=false \
--foreman-proxy-dns-provider=nsupdate \
--foreman-proxy-dns-server="<em>IdM_Server_IP_Address</em>" \
--foreman-proxy-keyfile=/etc/rndc.key \
--foreman-proxy-dns-ttl=86400</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Testing External Updates to the DNS Zone in the IdM Server</div>
<ol class="arabic">
<li>
<p>Ensure that the key in the <code>/etc/rndc.key</code> file on Foreman&#160;server is the same key file that is used on the IdM server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">key "rndc-key" {
        algorithm hmac-md5;
        secret "<em>secret-key</em>==";
};</pre>
</div>
</div>
</li>
<li>
<p>On Foreman&#160;server, create a test DNS entry for a host.
For example, host <code><em>test.example.com</em></code> with an A record of <code>192.168.25.20</code> on the IdM server at <code>192.168.25.1</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># echo -e "server 192.168.25.1\n \
update add <em>test.example.com</em> 3600 IN A 192.168.25.20\n \
send\n" | nsupdate -k /etc/rndc.key</pre>
</div>
</div>
</li>
<li>
<p>On Foreman&#160;server, test the DNS entry:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># nslookup <em>test.example.com</em> 192.168.25.1
Server:		192.168.25.1
Address:	192.168.25.1#53

Name:	test.example.com
Address: 192.168.25.20</pre>
</div>
</div>
</li>
<li>
<p>To view the entry in the IdM web UI, navigate to <strong>Network Services</strong> &gt; <strong>DNS</strong> &gt; <strong>DNS Zones</strong>.
Click the name of the zone and search for the host by name.</p>
</li>
<li>
<p>If resolved successfully, remove the test DNS entry:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># echo -e "server 192.168.25.1\n \
update delete <em>test.example.com</em> 3600 IN A 192.168.25.20\n \
send\n" | nsupdate -k /etc/rndc.key</pre>
</div>
</div>
</li>
<li>
<p>Confirm that the DNS entry was removed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># nslookup <em>test.example.com</em> 192.168.25.1</pre>
</div>
</div>
<div class="paragraph">
<p>The above <code>nslookup</code> command fails and returns the <code>SERVFAIL</code> error message if the record was successfully deleted.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="reverting-to-internal-dns-service_foreman"><a class="anchor" href="#reverting-to-internal-dns-service_foreman"></a>6.4.3. Reverting to Internal DNS Service</h4>
<div class="paragraph">
<p>You can revert to using Foreman&#160;server and Smart&#160;Proxy&#160;server as your DNS providers.
You can use a backup of the answer file that was created before configuring external DNS, or you can create a backup of the answer file.
For more information about answer files, see <a href="https://docs.theforeman.org/3.7/Installing_Server/index-foreman-deb.html#configuring-server_foreman">Configuring Foreman&#160;server</a>.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>On the Foreman or Smart&#160;Proxy&#160;server that you want to configure to manage DNS service for the domain, complete the following steps:</p>
</div>
<div class="ulist">
<div class="title">Configuring Foreman or Smart&#160;Proxy as a DNS Server</div>
<ul>
<li>
<p>If you have created a backup of the answer file before configuring external DNS, restore the answer file and then enter the <code>foreman-installer</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer</pre>
</div>
</div>
</li>
<li>
<p>If you do not have a suitable backup of the answer file, create a backup of the answer file now.
To configure Foreman or Smart&#160;Proxy as DNS server without using an answer file, enter the following <code>foreman-installer</code> command on Foreman or Smart&#160;Proxy:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer \
--foreman-proxy-dns=true \
--foreman-proxy-dns-managed=true \
--foreman-proxy-dns-provider=nsupdate \
--foreman-proxy-dns-server="127.0.0.1"</pre>
</div>
</div>
<div class="paragraph">
<p>For more information,see <a href="https://docs.theforeman.org/3.7/Installing_Proxy/index-foreman-deb.html#configuring-dns-dhcp-and-tftp_smart-proxy">Configuring DNS, DHCP, and TFTP on Smart&#160;Proxy&#160;server</a>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>After you run the <code>foreman-installer</code> command to make any changes to your Smart&#160;Proxy configuration, you must update the configuration of each affected Smart&#160;Proxy in the Foreman web UI.</p>
</div>
<div class="olist arabic">
<div class="title">Updating the Configuration in the Foreman web UI</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong>.</p>
</li>
<li>
<p>For each Smart&#160;Proxy that you want to update, from the <strong>Actions</strong> list, select <strong>Refresh</strong>.</p>
</li>
<li>
<p>Configure the domain:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Domains</strong> and click the domain name that you want to configure.</p>
</li>
<li>
<p>In the <strong>Domain</strong> tab, set <strong>DNS Smart&#160;Proxy</strong> to the Smart&#160;Proxy where the subnet is connected.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Configure the subnet:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong> and select the subnet name.</p>
</li>
<li>
<p>In the <strong>Subnet</strong> tab, set <strong>IPAM</strong> to <strong>DHCP</strong> or <strong>Internal DB</strong>.</p>
</li>
<li>
<p>In the <strong>Domains</strong> tab, select the domain that you want to manage using Foreman or Smart&#160;Proxy.</p>
</li>
<li>
<p>In the <strong>Smart&#160;Proxies</strong> tab, set <strong>Reverse DNS Smart&#160;Proxy</strong> to the Smart&#160;Proxy where the subnet is connected.</p>
</li>
<li>
<p>Click <strong>Submit</strong> to save the changes.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applying-custom-configuration_foreman"><a class="anchor" href="#applying-custom-configuration_foreman"></a>Appendix A: Applying Custom Configuration to Foreman</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you install and configure Foreman for the first time using <code>foreman-installer</code>, you can specify that the DNS and DHCP configuration files are not to be managed by Puppet using the installer flags <code>--foreman-proxy-dns-managed=false</code> and <code>--foreman-proxy-dhcp-managed=false</code>.
If these flags are not specified during the initial installer run, rerunning of the installer overwrites all manual changes, for example, rerun for upgrade purposes.
If changes are overwritten, you must run the restore procedure to restore the manual changes.
For more information, see <a href="https://docs.theforeman.org/3.7/Installing_Server/index-foreman-deb.html#restoring-manual-changes-overwritten-by-a-puppet-run_foreman">Restoring Manual Changes Overwritten by a Puppet Run</a>.</p>
</div>
<div class="paragraph">
<p>To view all installer flags available for custom configuration, run <code>foreman-installer --full-help</code>.
Some Puppet classes are not exposed to the Foreman installer.
To manage them manually and prevent the installer from overwriting their values, specify the configuration values by adding entries to configuration file <code>/etc/foreman-installer/custom-hiera.yaml</code>.
This configuration file is in YAML format, consisting of one entry per line in the format of <code>&lt;puppet class&gt;::&lt;parameter name&gt;: &lt;value&gt;</code>.
Configuration values specified in this file persist across installer reruns.</p>
</div>
<div class="paragraph">
<p>Common examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For Apache, to set the ServerTokens directive to only return the Product name:</p>
<div class="listingblock">
<div class="content">
<pre>apache::server_tokens: Prod</pre>
</div>
</div>
</li>
<li>
<p>To turn off the Apache server signature entirely:</p>
<div class="listingblock">
<div class="content">
<pre>apache::server_signature: Off</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Puppet modules for the Foreman installer are stored under <code>/usr/share/foreman-installer/modules</code>.
Check the <code>.pp</code> files (for example: <em>moduleName</em>/manifests/<em>example</em>.pp) to look up the classes, parameters, and values.
Alternatively, use the <code>grep</code> command to do keyword searches.</p>
</div>
<div class="paragraph">
<p>Setting some values may have unintended consequences that affect the performance or functionality of Foreman.
Consider the impact of the changes before you apply them, and test the changes in a non-production environment first.
If you do not have a non-production Foreman environment, run the Foreman installer with the <code>--noop</code> and <code>--verbose</code> options.
If your changes cause problems, remove the offending lines from <code>custom-hiera.yaml</code> and rerun the Foreman installer.
If you have any specific questions about whether a particular value is safe to alter, contact Red Hat support.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="restoring-manual-changes-overwritten-by-a-puppet-run_foreman"><a class="anchor" href="#restoring-manual-changes-overwritten-by-a-puppet-run_foreman"></a>Appendix B: Restoring Manual Changes Overwritten by a Puppet Run</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If your manual configuration has been overwritten by a Puppet run, you can restore the files to the previous state.
The following example shows you how to restore a DHCP configuration file overwritten by a Puppet run.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Copy the file you intend to restore.
This allows you to compare the files to check for any mandatory changes required by the upgrade.
This is not common for DNS or DHCP services.</p>
<div class="listingblock">
<div class="content">
<pre># cp /etc/dhcp/dhcpd.conf /etc/dhcp/dhcpd.backup</pre>
</div>
</div>
</li>
<li>
<p>Check the log files to note down the md5sum of the overwritten file.
For example:</p>
<div class="listingblock">
<div class="content">
<pre># journalctl -xe
...
/Stage[main]/Dhcp/File[/etc/dhcp/dhcpd.conf]: Filebucketed /etc/dhcp/dhcpd.conf to puppet with sum 622d9820b8e764ab124367c68f5fa3a1
...</pre>
</div>
</div>
</li>
<li>
<p>Restore the overwritten file:</p>
<div class="listingblock">
<div class="content">
<pre># puppet filebucket restore --local --bucket \
/var/lib/puppet/clientbucket /etc/dhcp/dhcpd.conf \ 622d9820b8e764ab124367c68f5fa3a1</pre>
</div>
</div>
</li>
<li>
<p>Compare the backup file and the restored file, and edit the restored file to include any mandatory changes required by the upgrade.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 3.7 (unsupported)<br>
Last updated Jun 2023
</div>
</div>
</body>
</html>